<div class="api-wrap" style="margin-left:12px">
  <label>ðŸ”‘ 3DAI Studio Key</label>
  <input type="password" id="studioKey" placeholder="3dai-..." />
</div>

<div class="viz-section">
  <div class="viz-hdr">
    <div>
      <div class="viz-title">ðŸŽ¨ 3D Sanierungskonzept & Visualisierung</div>
      <div class="viz-sub">OpenAI plant die Sanierung â€“ Rodin AI (3DAI Studio) baut das interaktive 3D-Modell</div>
    </div>
    <button class="btn btn-p" id="vizBtn" onclick="generate3DConcept()">âœ¨ 3D Modell generieren</button>
  </div>

  <div class="loading-konzepte" id="ldViz">
    <div class="spinner"></div>
    <p id="vizStatus">KI plant Sanierung... <span>Bitte warten</span></p>
  </div>

  <div id="vizResult" style="display:none; text-align:center;">
    <div class="vorher-box" id="vorherBox" style="margin-bottom: 20px;"></div>
    
    <div style="background:white; border-radius:var(--r); padding:15px; box-shadow:var(--shadow-md);">
      <p style="font-weight:700; color:var(--blue); margin-bottom:10px;">Interaktives 3D-Sanierungskonzept (Rodin v2)</p>
      <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
      <model-viewer id="rodinViewer" src="" ar camera-controls shadow-intensity="1" style="width:100%; height:400px; background:#f9fafb;"></model-viewer>
      <p style="font-size:10px; color:var(--gray-400); margin-top:8px;">Modell generiert durch 3DAI Studio API Â· Rodin Architectural Engine</p>
    </div>
  </div>
</div>

<script>
// FÃ¼gen Sie diese Funktion am Ende Ihres <script> Bereichs hinzu

async function generate3DConcept() {
  const openaiKey = document.getElementById('apiKey').value.trim();
  const studioKey = document.getElementById('studioKey').value.trim();
  
  if (!openaiKey || !studioKey) {
    showErr('Bitte OpenAI Key UND 3DAI Studio Key eingeben.');
    return;
  }
  if (!photos.length) {
    showErr('Bitte zuerst ein Schadensfoto hochladen.');
    return;
  }

  const btn = document.getElementById('vizBtn');
  const ld = document.getElementById('ldViz');
  const resDiv = document.getElementById('vizResult');
  const statusTxt = document.getElementById('vizStatus');

  btn.disabled = true;
  ld.classList.add('on');
  resDiv.style.display = 'none';

  try {
    // SCHRITT 1: OpenAI erstellt den Sanierungs-Prompt fÃ¼r Rodin
    statusTxt.innerHTML = "OpenAI erstellt Sanierungsplan... <span>(Architektur-Analyse)</span>";
    
    const aiRes = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${openaiKey}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: "gpt-4o",
        messages: [{
          role: "user",
          content: [
            { type: "text", text: "Analysiere den Schaden auf diesem Bild und erstelle einen englischen Prompt fÃ¼r eine 3D-KI (Rodin). Der Prompt soll eine perfekt sanierte Version dieser Wand/dieses Raums beschreiben: 'Professional architectural 3D model, clean white plaster walls, modern bright interior, photorealistic 4k textures, no damage'. Gib NUR den englischen Prompt zurÃ¼ck." },
            { type: "image_url", image_url: { url: 'data:image/jpeg;base64,' + photos[0].b64 } }
          ]
        }]
      })
    });
    
    const aiData = await aiRes.json();
    const rodinPrompt = aiData.choices[0].message.content;

    // SCHRITT 2: 3DAI Studio Task starten
    statusTxt.innerHTML = "Rodin AI baut 3D-Modell... <span>(Dauer ca. 60s)</span>";
    
    const studioRes = await fetch('https://api.3daistudio.com/v1/generate', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${studioKey}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        engine: "rodin-v2",
        prompt: rodinPrompt,
        quality: "high"
      })
    });
    
    const studioData = await studioRes.json();
    const taskId = studioData.id;

    // SCHRITT 3: Polling (Warten bis fertig)
    const poll = setInterval(async () => {
      const check = await fetch(`https://api.3daistudio.com/v1/status/${taskId}`, {
        headers: { 'Authorization': `Bearer ${studioKey}` }
      });
      const pollData = await check.json();

      if (pollData.status === 'completed') {
        clearInterval(poll);
        
        // Vorher-Bild anzeigen
        document.getElementById('vorherBox').innerHTML = `
          <img src="${photos[0].full}" style="max-height:150px; border:2px solid var(--red); border-radius:8px;" />
          <div style="color:var(--red); font-size:10px; font-weight:700; margin-top:5px;">ðŸ“· IST-ZUSTAND (SCHADEN)</div>
        `;
        
        document.getElementById('rodinViewer').src = pollData.model_url;
        resDiv.style.display = 'block';
        ld.classList.remove('on');
        btn.disabled = false;
      } else if (pollData.status === 'failed') {
        clearInterval(poll);
        showErr('3D-Generierung fehlgeschlagen.');
        ld.classList.remove('on');
        btn.disabled = false;
      }
    }, 5000);

  } catch (e) {
    showErr('Fehler: ' + e.message);
    ld.classList.remove('on');
    btn.disabled = false;
  }
}
</script>
