<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Geb√§udetrocknung Wiegand ‚Äì Unicorn KI Engine</title>
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --blue:#1a56db;--blue-dark:#1e429f;--blue-light:#ebf5ff;--blue-mid:#3b82f6;
  --gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;
  --gray-400:#9ca3af;--gray-500:#6b7280;--gray-600:#4b5563;--gray-700:#374151;--gray-800:#1f2937;
  --green:#059669;--green-light:#d1fae5;--red:#dc2626;--red-light:#fee2e2;
  --r:12px;--rs:8px;--shadow:0 1px 4px rgba(0,0,0,.09);--shadow-md:0 4px 16px rgba(0,0,0,.1);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Inter',sans-serif;background:#f1f5f9;color:var(--gray-800);font-size:14px;line-height:1.5;}

/* HEADER */
.header{background:linear-gradient(135deg,#1e3a8a,#1a56db);padding:0 28px;display:flex;align-items:center;justify-content:space-between;height:60px;position:sticky;top:0;z-index:100;box-shadow:0 2px 10px rgba(0,0,0,.2);}
.logo{display:flex;align-items:center;gap:10px;}
.logo-icon{width:34px;height:34px;background:rgba(255,255,255,.2);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;}
.logo h1{font-size:15px;font-weight:700;color:white;line-height:1.2;}
.logo p{font-size:10px;color:rgba(255,255,255,.7);}
.api-wrap{display:flex;align-items:center;gap:8px;}
.api-wrap label{font-size:11px;font-weight:600;color:rgba(255,255,255,.8);}
.api-wrap input{border:1.5px solid rgba(255,255,255,.3);border-radius:var(--rs);padding:7px 11px;font-family:monospace;font-size:12px;outline:none;width:200px;background:rgba(255,255,255,0.15);color:white;}

/* LAYOUT & CARDS */
.main{max-width:980px;margin:0 auto;padding:24px 20px;}
.card{background:white;border:1px solid var(--gray-200);border-radius:var(--r);padding:20px;margin-bottom:16px;box-shadow:var(--shadow);}
.card-title{font-size:12px;font-weight:700;color:var(--gray-600);text-transform:uppercase;letter-spacing:.07em;margin-bottom:14px;display:flex;align-items:center;gap:6px;}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}

/* FIELDS */
.f label{display:block;font-size:10px;font-weight:700;color:var(--gray-500);margin-bottom:4px;text-transform:uppercase;}
.f input,.f select{width:100%;border:1.5px solid var(--gray-200);border-radius:var(--rs);padding:9px 11px;font-size:13px;outline:none;background:white;}

/* UPLOAD */
.upload-zone{border:2px dashed var(--gray-300);border-radius:10px;padding:20px;text-align:center;background:var(--gray-50);cursor:pointer;}
.pgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;margin-top:12px;}
.pthumb{position:relative;border-radius:8px;overflow:hidden;aspect-ratio:1;border:2px solid var(--gray-200);}
.pthumb img{width:100%;height:100%;object-fit:cover;}

/* MODES */
.modes{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px;}
.mc{border:1.5px solid var(--gray-200);border-radius:var(--rs);padding:10px 4px;text-align:center;cursor:pointer;font-size:10px;font-weight:600;color:var(--gray-500);background:white;}
.mc.on{border-color:var(--blue);background:var(--blue-light);color:var(--blue);}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:5px;border:none;border-radius:var(--rs);padding:9px 16px;font-weight:600;cursor:pointer;transition:all .2s;}
.btn-p{background:var(--blue);color:white;}
.btn-g{background:var(--green);color:white;}
.btn-full{width:100%;justify-content:center;padding:12px;}

/* LOADING */
.loading{display:none;text-align:center;padding:30px;}
.loading.on{display:block;}
.spinner{width:34px;height:34px;border:3px solid var(--gray-100);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 10px;}
@keyframes spin{to{transform:rotate(360deg)}}

/* RESULT */
.rbox{display:none;}
.rbox.on{display:block;}
.rcontent{font-size:13px;line-height:1.9;color:var(--gray-700);}

/* 3D VIZ */
.viz-section{background:linear-gradient(135deg,#eff6ff,#dbeafe);border:1px solid #bfdbfe;border-radius:var(--r);padding:20px;margin-top:16px;}
#unicorn3D{width:100%; height:450px; border-radius: 12px; background: #f9fafb; margin-top:15px;}

.err{display:none;background:var(--red-light);color:var(--red);padding:9px 14px;border-radius:var(--rs);margin-bottom:12px;}
.err.on{display:block;}
</style>
</head>
<body>

<div class="header">
  <div class="logo">
    <div class="logo-icon">üíß</div>
    <div><h1>Geb√§udetrocknung Wiegand</h1><p>Unicorn Engine ¬∑ 01520 88 112 88</p></div>
  </div>
  <div class="api-wrap">
    <label>üîë OpenAI</label><input type="password" id="apiKey" placeholder="sk-..." />
    <label>üîë Gemini</label><input type="password" id="geminiKey" placeholder="AIza..." />
  </div>
</div>

<div class="main">
  <div class="err" id="err"></div>

  <div class="card">
    <div class="card-title">üìã Objektdaten</div>
    <div class="g3">
      <div class="f"><label>Objekt / Adresse</label><input type="text" id="objekt" placeholder="Musterstr. 5" /></div>
      <div class="f"><label>Kunde</label><input type="text" id="kunde" placeholder="Familie M√ºller" /></div>
      <div class="f">
        <label>Schaden</label>
        <select id="schaden"><option>Wasserschaden</option><option>Schimmelbefall</option><option>Badezimmer-Sanierung</option></select>
      </div>
    </div>
    <div class="g3" style="margin-top:10px">
        <div class="f"><label>Fl√§che (m¬≤)</label><input type="number" id="flaeche" value="10" /></div>
        <div class="f"><label>Versicherung</label><select id="vers"><option>Ja</option><option>Nein</option></select></div>
        <div class="f"><label>Budget (‚Ç¨)</label><input type="number" id="budget" value="5000" /></div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">üì∑ Schadensfotos</div>
    <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
      <div style="font-size:2rem">üì∑</div>
      <p>Klicken zum Hochladen</p>
      <input type="file" id="fileInput" hidden multiple onchange="handleFiles(this)" />
    </div>
    <div class="pgrid" id="pgrid"></div>
  </div>

  <div class="card">
    <div class="card-title">üöÄ Unicorn-Aktionen</div>
    <div class="modes">
      <div class="mc on" id="m-s" onclick="toggleM('s')">Beurteilung</div>
      <div class="mc on" id="m-k" onclick="toggleM('k')">Konzept</div>
      <div class="mc on" id="m-p" onclick="toggleM('p')">Kosten</div>
      <div class="mc on" id="m-f" onclick="toggleM('f')">Vertrag</div>
    </div>
    <div class="g2">
        <button class="btn btn-p btn-full" id="analyzeBtn" onclick="runAnalyse()">üîç KI-Analyse & Vertrag</button>
        <button class="btn btn-g btn-full" id="vizBtn" onclick="processUnicorn('3d')">üìê 3D Raum-Vorschlag</button>
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p id="ldtxt">Unicorn-Engine arbeitet...</p>
  </div>

  <div class="card rbox" id="rcard">
    <div class="rcontent" id="rcontent"></div>
    
    <div class="viz-section" id="unicorn3DContainer" style="display:none;">
      <div class="card-title" style="color:var(--blue-dark)">üé® 3D Sanierungsvorschlag</div>
      <model-viewer id="unicorn3D" src="" ar camera-controls shadow-intensity="1"></model-viewer>
    </div>
  </div>
</div>

<script>
let photos=[];
const VERCEL_URL = "https://wiegand-demo.vercel.app/api/unicorn-engine";

function handleFiles(input){
  Array.from(input.files).forEach(file=>{
    const r=new FileReader();
    r.onload=e=> {
        photos.push({b64:e.target.result.split(',')[1], full:e.target.result});
        renderPhotos();
    };
    r.readAsDataURL(file);
  });
}

function renderPhotos(){
  document.getElementById('pgrid').innerHTML=photos.map((p,i)=>`<div class="pthumb"><img src="${p.full}"/></div>`).join('');
}

function toggleM(m){ document.getElementById('m-'+m).classList.toggle('on'); }

async function runAnalyse(){
  const key=document.getElementById('apiKey').value;
  if(!key || !photos.length) return showErr("Key oder Foto fehlt!");
  
  document.getElementById('loading').classList.add('on');
  
  try {
    const res = await fetch('https://api.openai.com/v1/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
      body:JSON.stringify({
        model:'gpt-4o',
        messages:[{role:'user',content:[
          {type:'text',text:'Analysiere diesen Schaden und erstelle ein Sanierungskonzept sowie einen VOB-Vertrag.'},
          {type:'image_url',image_url:{url:photos[0].full}}
        ]}]
      })
    });
    const d=await res.json();
    document.getElementById('rcontent').innerHTML = fmt(d.choices[0].message.content);
    document.getElementById('rcard').classList.add('on');
  } catch(e){ showErr(e.message); }
  finally { document.getElementById('loading').classList.remove('on'); }
}

async function processUnicorn(type) {
  if (!photos.length) return showErr('Bitte Foto hochladen.');
  document.getElementById('loading').classList.add('on');

  const payload = {
    imageData: photos[0].b64,
    taskType: type,
    metadata: { kunde: document.getElementById('kunde').value, flaeche: document.getElementById('flaeche').value }
  };

  try {
    const response = await fetch(VERCEL_URL, { method: 'POST', body: JSON.stringify(payload) });
    const data = await response.json();
    
    if (type === '3d' && data.modelUrl) {
      const viewer = document.getElementById('unicorn3D');
      viewer.src = data.modelUrl;
      document.getElementById('unicorn3DContainer').style.display = 'block';
    }
    if (data.text) {
      document.getElementById('rcontent').innerHTML += "<h3>üìÑ VERTREGSENTWURF</h3>" + fmt(data.text);
      document.getElementById('rcard').classList.add('on');
    }
  } catch (err) { showErr("API Fehler: " + err.message); }
  finally { document.getElementById('loading').classList.remove('on'); }
}

function fmt(t){ return t.replace(/\n/g,'<br>').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>'); }
function showErr(m){ const e=document.getElementById('err'); e.textContent=m; e.classList.add('on'); }
</script>
</body>
</html>
