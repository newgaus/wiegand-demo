<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Geb√§udetrocknung Wiegand ‚Äì KI Demo</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --blue:#1a56db; --blue-dark:#1e429f; --blue-light:#ebf5ff;
  --gray-50:#f9fafb; --gray-100:#f3f4f6; --gray-200:#e5e7eb;
  --gray-400:#9ca3af; --gray-500:#6b7280; --gray-600:#4b5563;
  --gray-700:#374151; --gray-800:#1f2937;
  --green:#059669; --green-light:#d1fae5;
  --red:#dc2626; --red-light:#fee2e2;
  --r:12px; --rs:8px;
  --shadow:0 1px 3px rgba(0,0,0,.1);
  --shadow-md:0 4px 12px rgba(0,0,0,.08);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Inter',sans-serif;background:var(--gray-50);color:var(--gray-800);font-size:14px;line-height:1.5;}
.header{background:white;border-bottom:1px solid var(--gray-200);padding:16px 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:var(--shadow);}
.header-logo{display:flex;align-items:center;gap:12px;}
.header-logo .icon{width:38px;height:38px;background:var(--blue);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;}
.header-logo h1{font-size:16px;font-weight:700;color:var(--gray-800);line-height:1.2;}
.header-logo p{font-size:11px;color:var(--gray-500);}
.header-right{display:flex;align-items:center;gap:10px;}
.api-input{border:1.5px solid var(--gray-200);border-radius:var(--rs);padding:8px 12px;font-family:monospace;font-size:12px;outline:none;width:280px;transition:border-color .2s;}
.api-input:focus{border-color:var(--blue);}
.api-label{font-size:11px;font-weight:600;color:var(--blue-dark);white-space:nowrap;}
.main{max-width:1100px;margin:0 auto;padding:28px 24px;}
.sec-title{font-size:13px;font-weight:700;color:var(--gray-700);text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px;display:flex;align-items:center;gap:7px;}
.card{background:white;border:1px solid var(--gray-200);border-radius:var(--r);padding:22px;margin-bottom:20px;box-shadow:var(--shadow);}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;}
.field{margin-bottom:0;}
.field label{display:block;font-size:11px;font-weight:600;color:var(--gray-600);margin-bottom:4px;text-transform:uppercase;letter-spacing:.04em;}
.field input,.field select,.field textarea{width:100%;border:1.5px solid var(--gray-200);border-radius:var(--rs);padding:9px 12px;font-family:'Inter',sans-serif;font-size:13px;color:var(--gray-800);outline:none;transition:border-color .2s;background:white;}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(26,86,219,.07);}
.field textarea{min-height:70px;resize:vertical;line-height:1.6;}
.upload-area{border:2px dashed var(--gray-300);border-radius:var(--r);padding:20px;text-align:center;cursor:pointer;transition:all .2s;position:relative;background:white;}
.upload-area:hover{border-color:var(--blue);background:var(--blue-light);}
.upload-area input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.upload-icon{font-size:1.8rem;margin-bottom:6px;}
.upload-area p{color:var(--gray-500);font-size:12px;}
.upload-area p span{color:var(--blue);font-weight:600;}
.photos-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-top:14px;}
.photo-thumb{position:relative;border-radius:var(--rs);overflow:hidden;aspect-ratio:1;border:2px solid var(--gray-200);}
.photo-thumb img{width:100%;height:100%;object-fit:cover;}
.photo-thumb .del{position:absolute;top:4px;right:4px;background:rgba(220,38,38,.9);color:white;border:none;border-radius:50%;width:22px;height:22px;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:700;}
.photo-thumb .main-badge{position:absolute;bottom:4px;left:4px;background:var(--blue);color:white;font-size:9px;font-weight:600;padding:2px 5px;border-radius:4px;text-transform:uppercase;}
.photos-count{font-size:11px;color:var(--green);font-weight:500;margin-top:6px;}
.audio-card{display:flex;align-items:flex-start;gap:20px;}
.rec-area{text-align:center;flex-shrink:0;}
.rec-btn{width:68px;height:68px;border-radius:50%;border:2.5px solid var(--blue);background:var(--blue-light);color:var(--blue);font-size:1.7rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;margin:0 auto 8px;}
.rec-btn:hover{background:var(--blue);color:white;}
.rec-btn.rec{border-color:var(--red);background:var(--red-light);color:var(--red);animation:pulse 1s infinite;}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
.rec-status{font-size:11px;font-weight:600;color:var(--gray-400);}
.rec-status.active{color:var(--red);}
.rec-timer{font-size:18px;font-weight:700;color:var(--gray-700);margin-top:4px;font-family:monospace;}
.audio-info{flex:1;}
.audio-info h3{font-size:13px;font-weight:600;color:var(--gray-700);margin-bottom:4px;}
.audio-info p{font-size:12px;color:var(--gray-500);line-height:1.7;}
.audio-prev-wrap{margin-top:10px;display:none;}
.audio-prev-wrap audio{width:100%;border-radius:var(--rs);}
.transcript-box{display:none;background:var(--blue-light);border:1px solid #bfdbfe;border-radius:var(--rs);padding:10px 12px;margin-top:10px;font-size:12px;line-height:1.7;color:var(--gray-700);}
.transcript-box.on{display:block;}
.transcript-lbl{font-size:10px;font-weight:700;color:var(--blue-dark);margin-bottom:3px;text-transform:uppercase;letter-spacing:.05em;}
.modes{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px;}
.mchip{border:1.5px solid var(--gray-200);border-radius:var(--rs);padding:10px 6px;text-align:center;cursor:pointer;transition:all .2s;background:white;font-size:10px;font-weight:600;color:var(--gray-500);}
.mchip:hover{border-color:var(--blue);color:var(--blue);}
.mchip.on{border-color:var(--blue);background:var(--blue-light);color:var(--blue);}
.mchip .mi{font-size:1.2rem;display:block;margin-bottom:2px;}
.btn{display:inline-flex;align-items:center;gap:6px;border:none;border-radius:var(--rs);padding:10px 18px;font-family:'Inter',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;}
.btn-p{background:var(--blue);color:white;}
.btn-p:hover{background:var(--blue-dark);}
.btn-p:disabled{opacity:.5;cursor:not-allowed;}
.btn-s{background:white;color:var(--gray-700);border:1.5px solid var(--gray-200);}
.btn-s:hover{background:var(--gray-50);}
.btn-g{background:var(--green);color:white;}
.btn-g:hover{opacity:.9;}
.btn-full{width:100%;justify-content:center;padding:13px;font-size:14px;}
.loading{display:none;text-align:center;padding:36px;}
.loading.on{display:block;}
.spinner{width:36px;height:36px;border:3px solid var(--gray-200);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 12px;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading p{color:var(--gray-500);font-size:13px;}
.loading span{color:var(--blue);font-weight:600;}
.loading-steps{margin-top:12px;}
.step{font-size:12px;color:var(--gray-400);padding:3px 0;}
.step.active{color:var(--blue);font-weight:600;}
.step.done{color:var(--green);}
.result-box{display:none;}
.result-box.on{display:block;}
.result-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;padding-bottom:14px;border-bottom:1px solid var(--gray-100);}
.result-title{font-size:15px;font-weight:700;color:var(--green);display:flex;align-items:center;gap:6px;}
.result-actions{display:flex;gap:8px;}
.result-content{font-size:13px;line-height:1.9;color:var(--gray-700);}
.result-content h3{font-size:11px;font-weight:700;color:var(--blue-dark);text-transform:uppercase;letter-spacing:.06em;margin:20px 0 7px;padding-bottom:4px;border-bottom:1px solid var(--gray-100);}
.result-content h3:first-child{margin-top:0;}
.result-content strong{color:var(--gray-800);font-weight:600;}
.viz-wrap{background:linear-gradient(135deg,#eff6ff,#dbeafe);border:1px solid #bfdbfe;border-radius:var(--r);padding:20px;margin-top:16px;}
.viz-hdr{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:14px;}
.viz-hdr-text h3{font-size:14px;font-weight:700;color:var(--blue-dark);margin-bottom:3px;}
.viz-hdr-text p{font-size:11px;color:var(--gray-500);}
.viz-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;margin-top:12px;}
.viz-item{text-align:center;}
.viz-item img{width:100%;border-radius:10px;border:1px solid var(--gray-200);box-shadow:var(--shadow-md);}
.viz-item p{font-size:10px;color:var(--gray-400);margin-top:5px;text-transform:uppercase;letter-spacing:.05em;}
.viz-steps{margin-top:10px;}
.viz-step{font-size:12px;padding:4px 0;color:var(--gray-400);}
.viz-step.active{color:var(--blue);font-weight:600;}
.viz-step.done{color:var(--green);}
.invoice-wrap{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:1px solid #86efac;border-radius:var(--r);padding:20px;margin-top:16px;}
.invoice-wrap h3{font-size:14px;font-weight:700;color:#166534;margin-bottom:4px;}
.invoice-wrap>p{font-size:12px;color:var(--gray-600);margin-bottom:14px;}
.invoice-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:14px;}
.invoice-field label{display:block;font-size:10px;font-weight:700;color:#166534;margin-bottom:3px;text-transform:uppercase;letter-spacing:.04em;}
.invoice-field input{width:100%;border:1.5px solid #86efac;border-radius:var(--rs);padding:8px 11px;font-family:'Inter',sans-serif;font-size:13px;outline:none;background:white;transition:border-color .2s;}
.invoice-field input:focus{border-color:var(--green);}
.invoice-preview{background:white;border:1px solid var(--gray-200);border-radius:var(--rs);padding:16px;margin-bottom:12px;display:none;font-size:12px;line-height:1.8;}
.invoice-preview.on{display:block;}
.invoice-preview h4{font-size:14px;font-weight:700;margin-bottom:8px;color:var(--gray-800);}
.err-bar{display:none;background:var(--red-light);border:1px solid #fca5a5;color:var(--red);padding:9px 14px;border-radius:var(--rs);font-size:12px;margin-bottom:14px;}
.err-bar.on{display:block;}
.progress-bar{height:3px;background:var(--gray-100);border-radius:2px;margin-top:8px;overflow:hidden;}
.progress-fill{height:100%;background:var(--blue);border-radius:2px;transition:width .3s;width:0%;}
.reno-wishes-wrap{background:white;border:1.5px solid #bfdbfe;border-radius:var(--rs);padding:12px 14px;margin-bottom:14px;}
.reno-wishes-label{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.reno-wishes-label strong{font-size:11px;font-weight:700;color:var(--blue-dark);text-transform:uppercase;letter-spacing:.05em;}
.reno-wishes-label span{font-size:10px;color:var(--gray-400);}
.reno-input-row{display:flex;gap:8px;align-items:flex-start;}
.reno-input-row textarea{flex:1;min-height:64px;border:1.5px solid var(--gray-200);border-radius:var(--rs);padding:8px 10px;font-size:12px;font-family:'Inter',sans-serif;outline:none;resize:vertical;background:white;color:var(--gray-700);line-height:1.6;}
.reno-input-row textarea:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(26,86,219,.07);}
.reno-input-row textarea::placeholder{color:var(--gray-400);}
.reno-rec-wrap{display:flex;flex-direction:column;align-items:center;gap:3px;flex-shrink:0;}
.reno-rec-btn{width:42px;height:42px;border-radius:50%;border:2px solid var(--blue);background:var(--blue-light);color:var(--blue);font-size:1.1rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;}
.reno-rec-btn:hover{background:var(--blue);color:white;}
.reno-rec-btn.rec{border-color:var(--red);background:var(--red-light);color:var(--red);animation:pulse 1s infinite;}
.reno-rec-status{font-size:9px;font-weight:600;color:var(--gray-400);text-align:center;}
.reno-rec-status.active{color:var(--red);}
.reno-transcript{display:none;font-size:11px;color:var(--blue-dark);margin-top:7px;padding:6px 9px;background:var(--blue-light);border-radius:6px;line-height:1.6;}
.reno-transcript.on{display:block;}
/* WIZARD */
.wizard-progress{display:flex;align-items:center;gap:10px;margin-bottom:14px;font-size:12px;font-weight:700;color:var(--blue);}
.wizard-dots{display:flex;gap:5px;}
.wizard-dot{width:9px;height:9px;border-radius:50%;background:var(--gray-200);transition:all .3s;}
.wizard-dot.done{background:var(--green);}
.wizard-dot.active{background:var(--blue);transform:scale(1.25);}
.wizard-question{font-size:13px;color:var(--gray-700);background:var(--blue-light);border:1px solid #bfdbfe;border-left:4px solid var(--blue);border-radius:var(--rs);padding:12px 14px;margin:14px 0 10px;line-height:1.8;}
.wizard-desc{font-size:12px;color:var(--gray-600);background:var(--green-light);border:1px solid #6ee7b7;border-radius:var(--rs);padding:10px 12px;margin:10px 0;line-height:1.6;}
.wizard-feedback-row{display:flex;gap:8px;align-items:flex-start;}
.wizard-feedback-row textarea{flex:1;min-height:60px;border:1.5px solid var(--gray-200);border-radius:var(--rs);padding:8px 11px;font-size:13px;font-family:'Inter',sans-serif;outline:none;resize:vertical;line-height:1.6;color:var(--gray-800);}
.wizard-feedback-row textarea:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(26,86,219,.07);}
.wizard-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;}
.wizard-summary-hdr{font-size:14px;font-weight:700;color:var(--green);margin-bottom:14px;display:flex;align-items:center;gap:6px;}
@media(max-width:768px){
  .g2,.g3,.modes,.invoice-grid{grid-template-columns:1fr;}
  .header{flex-direction:column;gap:10px;align-items:flex-start;}
  .api-input{width:100%;}
  .audio-card{flex-direction:column;}
  .reno-input-row{flex-direction:column;}
  .reno-rec-wrap{flex-direction:row;}
  .wizard-actions{flex-direction:column;}
}
</style>
</head>
<body>
<div class="header">
  <div class="header-logo">
    <div class="icon">üè†</div>
    <div>
      <h1>Geb√§udetrocknung Wiegand</h1>
      <p>KI-Demo ¬∑ Eschwege ¬∑ 01520 88 112 88</p>
    </div>
  </div>
  <div class="header-right">
    <span class="api-label">üîë OpenAI Key</span>
    <input class="api-input" type="password" id="openaiKey" placeholder="sk-..." />
  </div>
</div>
<div class="main">
  <div class="err-bar" id="errBar"></div>
  <div class="card">
    <div class="sec-title">üìç Objektdaten</div>
    <div class="g3" style="margin-bottom:12px">
      <div class="field"><label>Objekt / Adresse</label><input type="text" id="objekt" placeholder="z.B. EFH, Musterstr. 5, Eschwege" /></div>
      <div class="field"><label>Auftraggeber</label><input type="text" id="auftraggeber" placeholder="z.B. Familie M√ºller" /></div>
      <div class="field">
        <label>Art des Schadens</label>
        <select id="schadensart">
          <option value="">Bitte w√§hlen...</option>
          <option>Wasserschaden (Rohrbruch)</option>
          <option>Wasserschaden (√úberschwemmung)</option>
          <option>Leckage (unbekannte Ursache)</option>
          <option>Schimmelbefall</option>
          <option>Feuchtigkeit in W√§nden/B√∂den</option>
          <option>Badezimmer-Sanierung</option>
          <option>Keller-Sanierung</option>
          <option>Sonstiges</option>
        </select>
      </div>
    </div>
    <div class="g3">
      <div class="field"><label>Fl√§che (m¬≤)</label><input type="number" id="flaeche" placeholder="z.B. 12" /></div>
      <div class="field">
        <label>Versicherungsfall</label>
        <select id="versicherung"><option>Nein</option><option>Ja ‚Äì Wohngeb√§ude</option><option>Ja ‚Äì Hausrat</option><option>Ja ‚Äì Haftpflicht</option><option>Unklar</option></select>
      </div>
      <div class="field"><label>Kostensch√§tzung Ziel (‚Ç¨)</label><input type="number" id="budget" placeholder="z.B. 5000" /></div>
    </div>
  </div>
  <div class="card">
    <div class="sec-title">üì∏ Fotos des Schadens <span style="font-size:11px;font-weight:400;color:var(--gray-400);text-transform:none;letter-spacing:0">(mehrere m√∂glich ‚Äì erstes Foto = Hauptbild f√ºr 3D)</span></div>
    <div class="upload-area" id="uploadArea">
      <input type="file" id="fileInput" accept="image/*" multiple onchange="handleFiles(this)" />
      <div class="upload-icon">üìÅ</div>
      <p>Fotos hier ablegen oder <span>ausw√§hlen</span></p>
      <p style="font-size:10px;margin-top:3px;color:var(--gray-400)">Mehrere Fotos gleichzeitig m√∂glich ¬∑ JPG, PNG, WEBP</p>
    </div>
    <div class="photos-grid" id="photosGrid"></div>
    <div class="photos-count" id="photosCount"></div>
    <button class="btn btn-p btn-full" id="startWizardBtn" onclick="startVizWizard()" style="display:none;margin-top:14px;">‚ú® Verbesserungsvorschlag f√ºr jedes Foto erstellen</button>
  </div>
  <!-- ===== VERBESSERUNGSVORSCHLAG WIZARD ===== -->
  <div class="card" id="wizardCard" style="display:none;border:2px solid var(--blue);">
    <div class="sec-title">‚ú® Verbesserungsvorschlag</div>
    <div class="wizard-progress">
      <span id="wizardProgressText">Foto 1 von 1</span>
      <div class="wizard-dots" id="wizardDots"></div>
    </div>
    <div class="loading" id="wizardLoading" style="padding:20px">
      <div class="spinner"></div>
      <p>Erstelle Verbesserungsvorschlag... <span>~45s</span></p>
      <div class="viz-steps">
        <div class="viz-step" id="wstep1">‚è≥ Schritt 1: Raum & Elemente analysieren</div>
        <div class="viz-step" id="wstep2">‚è≥ Schritt 2: Foto f√ºr KI vorbereiten</div>
        <div class="viz-step" id="wstep3">‚è≥ Schritt 3: Verbesserungsbild generieren</div>
      </div>
    </div>
    <div id="wizardResult" style="display:none">
      <div class="viz-grid" id="wizardGrid"></div>
      <div class="wizard-desc" id="wizardDesc"></div>
      <div class="wizard-question">üí¨ Gef√§llt dir dieser Vorschlag? Schreibe einfach was du √§ndern m√∂chtest (z.B. andere Farbe, anderes Material, moderner Stil) und ich erstelle sofort ein neues Bild.</div>
      <div class="wizard-feedback-row">
        <textarea id="wizardFeedback" placeholder="z.B. Hellere Fliesen, Holzboden statt Steinboden, Anthrazit-Schr√§nke, mehr Gr√ºnpflanzen..."></textarea>
      </div>
      <div class="wizard-actions">
        <button class="btn btn-s" onclick="regenerateCurrentWiz()">üîÑ Neu generieren</button>
        <button class="btn btn-p" id="wizardNextBtn" style="display:none" onclick="nextWizPhoto()">‚Üí Weiter zum n√§chsten Foto</button>
        <button class="btn btn-g" id="wizardDoneBtn" style="display:none" onclick="finishWizard()">‚úÖ Alle Vorschl√§ge fertig</button>
      </div>
    </div>
    <div id="wizardSummary" style="display:none">
      <div class="wizard-summary-hdr">‚úÖ Alle Verbesserungsvorschl√§ge erstellt</div>
      <div class="viz-grid" id="wizardSummaryGrid"></div>
    </div>
  </div>

  <div class="card">
    <div class="sec-title">üéôÔ∏è Sprachbeschreibung <span style="font-size:11px;font-weight:400;color:var(--gray-400);text-transform:none;letter-spacing:0">(unbegrenzte L√§nge)</span></div>
    <div class="audio-card">
      <div class="rec-area">
        <button class="rec-btn" id="recBtn" onclick="toggleRec()">üéôÔ∏è</button>
        <div class="rec-status" id="recStatus">Dr√ºcken</div>
        <div class="rec-timer" id="recTimer" style="display:none">0:00</div>
      </div>
      <div class="audio-info">
        <h3>Beschreiben Sie den Schaden m√ºndlich</h3>
        <p>
          ‚Ä¢ Sprechen Sie so lange Sie m√∂chten ‚Äì keine Zeitbegrenzung<br>
          ‚Ä¢ Beschreiben Sie was Sie sehen: W√§nde, Boden, Decke<br>
          ‚Ä¢ Erw√§hnen Sie Ger√ºche (Schimmel, Moder)<br>
          ‚Ä¢ Sagen Sie wo genau der Schaden ist<br>
          ‚Ä¢ Hinweise auf Ursache wenn bekannt
        </p>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="audio-prev-wrap" id="audioPrev">
          <audio id="audioPlayer" controls style="margin-top:10px"></audio>
          <p style="color:var(--green);font-size:11px;margin-top:4px;font-weight:500">‚úì Aufnahme gespeichert ‚Äì bereit zur Analyse</p>
        </div>
        <div class="transcript-box" id="transcriptBox">
          <div class="transcript-lbl">üóíÔ∏è Transkript (Whisper KI)</div>
          <div id="transcriptText"></div>
        </div>
        <div style="margin-top:10px;">
          <label style="display:block;font-size:11px;font-weight:600;color:var(--gray-600);margin-bottom:4px;text-transform:uppercase;letter-spacing:.04em;">‚úèÔ∏è Oder schriftlich beschreiben (optional)</label>
          <textarea id="manualDesc" placeholder="z.B. Feuchte W√§nde im Keller, Schimmelflecken an der Decke, Boden aufgequollen nach Rohrbruch vor 3 Tagen..." style="width:100%;min-height:80px;border:1.5px solid var(--gray-200);border-radius:var(--rs);padding:9px 12px;font-family:'Inter',sans-serif;font-size:13px;color:var(--gray-800);outline:none;transition:border-color .2s;background:white;resize:vertical;line-height:1.6;" onfocus="this.style.borderColor='var(--blue)'" onblur="this.style.borderColor='var(--gray-200)'"></textarea>
        </div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="sec-title">‚öôÔ∏è Was soll erstellt werden?</div>
    <div class="modes">
      <div class="mchip on" id="m-schaden" onclick="toggleM('schaden')"><span class="mi">üîç</span>Schadensbeurteilung</div>
      <div class="mchip on" id="m-konzept" onclick="toggleM('konzept')"><span class="mi">üìã</span>Sanierungskonzept</div>
      <div class="mchip on" id="m-kosten" onclick="toggleM('kosten')"><span class="mi">üí∞</span>Kostensch√§tzung</div>
      <div class="mchip on" id="m-foerder" onclick="toggleM('foerder')"><span class="mi">üèõÔ∏è</span>F√∂rderung & Versicherung</div>
    </div>
    <button class="btn btn-p btn-full" id="analyzeBtn" onclick="runAnalyse()">üîç KI-Analyse starten</button>
  </div>
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p id="ldText">Analysiere... <span>Bitte warten</span></p>
    <div class="loading-steps">
      <div class="step" id="step1">‚è≥ Sprache transkribieren</div>
      <div class="step" id="step2">‚è≥ Fotos analysieren</div>
      <div class="step" id="step3">‚è≥ Sanierungskonzept erstellen</div>
      <div class="step" id="step4">‚è≥ Kostensch√§tzung berechnen</div>
    </div>
  </div>
  <div class="card result-box" id="resultCard">
    <div class="result-hdr">
      <div class="result-title">‚úÖ Analyse abgeschlossen</div>
      <div class="result-actions">
        <button class="btn btn-s" onclick="copyResult()">üìã Kopieren</button>
      </div>
    </div>
    <div class="result-content" id="resultContent"></div>
    <div class="viz-wrap" id="vizWrap">
      <div class="viz-hdr">
        <div class="viz-hdr-text">
          <h3>‚ú® KI-Visualisierung: Sanierter Raum</h3>
          <p>Originalfoto ‚Üí gpt-image-1 bearbeitet das echte Foto direkt ‚Äì Kamerawinkel, Ma√üe & Layout bleiben 1:1 erhalten</p>
        </div>
        <button class="btn btn-p" id="vizBtn" onclick="generateViz()">‚ú® 3D erstellen</button>
      </div>
      <div class="reno-wishes-wrap">
        <div class="reno-wishes-label">
          <strong>üí¨ Ihre W√ºnsche</strong>
          <span>optional ¬∑ Fliesen, Farben, M√∂belposition, Stil...</span>
        </div>
        <div class="reno-input-row">
          <textarea id="renoWishes" placeholder="z.B. Wei√üe gro√üformatige Fliesen ¬∑ Badewanne auf der linken Seite behalten ¬∑ Waschtisch-Unterschrank in Anthrazit ¬∑ Heller Holzboden ¬∑ Regendusche rechts ¬∑ Moderne graue Akzentwand"></textarea>
          <div class="reno-rec-wrap">
            <button class="reno-rec-btn" id="renoRecBtn" onclick="toggleRenoRec()" title="W√ºnsche einsprechen">üéôÔ∏è</button>
            <span class="reno-rec-status" id="renoRecStatus">Sprechen</span>
          </div>
        </div>
        <div class="reno-transcript" id="renoTranscript"></div>
      </div>
      <div class="loading" id="ldViz" style="padding:20px">
        <div class="spinner"></div>
        <p id="ldVizText">Analysiere Raum... <span>Bitte warten (~45s)</span></p>
        <div class="viz-steps">
          <div class="viz-step" id="vstep1">‚è≥ Schritt 1: Raumtyp & Perspektive analysieren</div>
          <div class="viz-step" id="vstep2">‚è≥ Schritt 2: Optimalen Bildprompt erstellen</div>
          <div class="viz-step" id="vstep3">‚è≥ Schritt 3: Perspektivtreues Nachher-Bild generieren</div>
        </div>
      </div>
      <div id="vizResult" style="display:none">
        <div class="viz-grid" id="vizGrid"></div>
        <div style="display:flex;align-items:center;justify-content:center;gap:14px;margin-top:14px;flex-wrap:wrap">
          <p style="font-size:11px;color:var(--gray-400)">üéØ Gleiche Perspektive ‚Äì saniert und modernisiert</p>
          <button class="btn btn-s" id="vizRegenBtn" style="display:none;font-size:12px;padding:7px 14px" onclick="generateViz(true)">üîÑ Neuen Vorschlag erstellen</button>
        </div>
      </div>
    </div>
    <div class="invoice-wrap" id="invoiceWrap">
      <h3>üìÑ Rechnung an Kunden senden</h3>
      <p>Rechnung wird automatisch aus der Analyse erstellt ‚Äì nur E-Mail eingeben und senden</p>
      <div class="invoice-grid">
        <div class="invoice-field"><label>Kunden-E-Mail</label><input type="email" id="inv-email" placeholder="kunde@email.de" /></div>
        <div class="invoice-field"><label>Rechnungsnummer</label><input type="text" id="inv-nr" placeholder="RE-2024-001" /></div>
        <div class="invoice-field"><label>Gesamtbetrag (‚Ç¨ brutto)</label><input type="number" id="inv-betrag" placeholder="3500" /></div>
      </div>
      <div class="invoice-preview" id="invoicePreview"></div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btn-s" onclick="previewInvoice()">üñ®Ô∏è Vorschau</button>
        <button class="btn btn-g" onclick="sendInvoice()">üì® Rechnung senden</button>
      </div>
      <div id="sendStatus" style="margin-top:10px;font-size:12px;"></div>
    </div>
  </div>
</div>
<script>
// ===== STATE =====
let photos = [];
let audBlob = null, isRec = false;
let mRec = null, aChunks = [];
let timerInterval = null, recSeconds = 0;
let modes = new Set(['schaden','konzept','kosten','foerder']);
let lastAnalysis = '';
let transcript = '';
let vizHistory       = [];
let cachedEditPrompt = '';
let cachedRoomType   = 'Raum';
let renoAudBlob      = null;
let renoIsRec        = false;
let renoMRec         = null;
let renoAChunks      = [];
// Wizard-State
let wizIndex         = 0;
let wizCachedPrompts = [];
let wizCachedTypes   = [];
let wizResults       = [];

// ===== STEP LABELS =====
const MAIN_STEPS = ['Sprache transkribieren','Fotos analysieren','Sanierungskonzept erstellen','Kostensch√§tzung berechnen'];
const VIZ_STEPS  = ['Raumtyp, Kamerawinkel & Ma√üe analysieren','Originalfoto f√ºr KI-Bearbeitung vorbereiten','gpt-image-1: Sanierung mit exakt gleicher Perspektive'];

// ===== HELPERS =====
function showErr(msg) {
  const el = document.getElementById('errBar');
  el.textContent = '‚ùå ' + msg;
  el.className = 'err-bar on';
  setTimeout(() => el.className = 'err-bar', 6000);
}
function hideErr() { document.getElementById('errBar').className = 'err-bar'; }

function setMainStep(n) {
  for (let i = 1; i <= 4; i++) {
    const el = document.getElementById('step' + i); if (!el) continue;
    const label = MAIN_STEPS[i-1];
    if (i < n)        { el.className='step done';   el.textContent='‚úÖ '+label; }
    else if (i === n) { el.className='step active'; el.textContent='üîÑ '+label; }
    else              { el.className='step';        el.textContent='‚è≥ '+label; }
  }
}
function setVizStep(n) {
  for (let i = 1; i <= 3; i++) {
    const el = document.getElementById('vstep' + i); if (!el) continue;
    const label = 'Schritt '+i+': '+VIZ_STEPS[i-1];
    if (i < n)        { el.className='viz-step done';   el.textContent='‚úÖ '+label; }
    else if (i === n) { el.className='viz-step active'; el.textContent='üîÑ '+label; }
    else              { el.className='viz-step';        el.textContent='‚è≥ '+label; }
  }
}
function formatMarkdown(text) {
  return text
    .replace(/### (.+)/g,'<h3>$1</h3>').replace(/## (.+)/g,'<h3>$1</h3>')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\*(.+?)\*/g,'<em>$1</em>')
    .replace(/^- (.+)/gm,'‚Ä¢ $1').replace(/\n/g,'<br>');
}

// ===== FOTOS =====
function handleFiles(input) {
  const files = Array.from(input.files); if (!files.length) return;
  let loaded = 0;
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      photos.push({ base64: e.target.result.split(',')[1], name: file.name, full: e.target.result });
      if (++loaded === files.length) renderPhotos();
    };
    reader.readAsDataURL(file);
  });
}
function renderPhotos() {
  vizHistory=[]; cachedEditPrompt=''; cachedRoomType='Raum';
  wizResults=[]; wizCachedPrompts=[]; wizCachedTypes=[];
  document.getElementById('vizResult').style.display  = 'none';
  document.getElementById('wizardCard').style.display = 'none';
  const regenBtn = document.getElementById('vizRegenBtn');
  if (regenBtn) regenBtn.style.display = 'none';
  document.getElementById('startWizardBtn').style.display = photos.length ? 'flex' : 'none';
  document.getElementById('photosGrid').innerHTML = photos.map((p,i) => `
    <div class="photo-thumb">
      <img src="${p.full}" alt="${p.name}" />
      <button class="del" onclick="removePhoto(${i})">√ó</button>
      ${i===0?'<span class="main-badge">Haupt</span>':''}
    </div>`).join('');
  document.getElementById('photosCount').textContent = photos.length > 0 ? `‚úì ${photos.length} Foto${photos.length>1?'s':''} geladen` : '';
  document.getElementById('fileInput').value = '';
}
function removePhoto(i) { photos.splice(i,1); renderPhotos(); }

// ===== AUDIO =====
async function toggleRec() {
  if (!isRec) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : 'audio/webm';
      mRec = new MediaRecorder(stream, { mimeType }); aChunks = [];
      mRec.ondataavailable = e => { if (e.data.size>0) aChunks.push(e.data); };
      mRec.onstop = () => {
        audBlob = new Blob(aChunks, { type: mimeType });
        document.getElementById('audioPlayer').src = URL.createObjectURL(audBlob);
        document.getElementById('audioPrev').style.display = 'block';
        stream.getTracks().forEach(t => t.stop());
      };
      mRec.start(500); isRec=true; recSeconds=0;
      document.getElementById('recBtn').textContent='‚èπ';
      document.getElementById('recBtn').classList.add('rec');
      document.getElementById('recStatus').textContent='‚óè Aufnahme';
      document.getElementById('recStatus').classList.add('active');
      document.getElementById('recTimer').style.display='block';
      timerInterval = setInterval(() => {
        recSeconds++;
        const m=Math.floor(recSeconds/60), s=recSeconds%60;
        document.getElementById('recTimer').textContent=`${m}:${String(s).padStart(2,'0')}`;
        document.getElementById('progressFill').style.width=Math.min((recSeconds/120)*100,100)+'%';
      },1000);
    } catch(e) { showErr('Mikrofon-Zugriff verweigert. Bitte Berechtigung im Browser erteilen.'); }
  } else {
    mRec.stop(); isRec=false; clearInterval(timerInterval);
    document.getElementById('recBtn').textContent='üéôÔ∏è';
    document.getElementById('recBtn').classList.remove('rec');
    document.getElementById('recStatus').textContent='‚úì Gespeichert';
    document.getElementById('recStatus').classList.remove('active');
  }
}

// ===== MODES =====
function toggleM(m) {
  const el = document.getElementById('m-'+m);
  if (modes.has(m)) { modes.delete(m); el.classList.remove('on'); }
  else              { modes.add(m);    el.classList.add('on');    }
}

// ===== ANALYSE =====
async function runAnalyse() {
  const key = document.getElementById('openaiKey').value.trim();
  if (!key) { showErr('Bitte OpenAI API Key eingeben.'); return; }
  if (!photos.length && !audBlob && !document.getElementById('manualDesc').value.trim()) {
    showErr('Bitte mindestens ein Foto, eine Sprachaufnahme oder eine Textbeschreibung bereitstellen.'); return;
  }
  hideErr();
  document.getElementById('analyzeBtn').disabled = true;
  document.getElementById('loading').classList.add('on');
  document.getElementById('resultCard').classList.remove('on');
  transcript = '';

  setMainStep(1);
  if (audBlob) {
    try {
      const fd = new FormData();
      fd.append('file', audBlob, 'aufnahme.webm');
      fd.append('model','whisper-1'); fd.append('language','de');
      const r = await fetch('https://api.openai.com/v1/audio/transcriptions',
        { method:'POST', headers:{'Authorization':'Bearer '+key}, body:fd });
      if (r.ok) {
        const d = await r.json();
        if (d.text) {
          transcript = d.text;
          document.getElementById('transcriptText').textContent = transcript;
          document.getElementById('transcriptBox').classList.add('on');
        }
      }
    } catch(e) { console.warn('Transkription fehlgeschlagen:',e); }
  }

  setMainStep(2);
  const manualDesc = document.getElementById('manualDesc').value.trim();
  const kunde=document.getElementById('auftraggeber').value||'Unbekannt';
  const obj=document.getElementById('objekt').value||'Unbekannt';
  const schaden=document.getElementById('schadensart').value||'Unbekannt';
  const flaeche=document.getElementById('flaeche').value||'unbekannt';
  const vers=document.getElementById('versicherung').value||'';
  const budget=document.getElementById('budget').value||'';

  const systemPrompt=`Du bist ein erfahrener Bausachverst√§ndiger und Gutachter f√ºr Geb√§udetrocknung und Sanierung.
Du erstellst professionelle, strukturierte Berichte f√ºr das Unternehmen Geb√§udetrocknung Wiegand.
Formatiere deine Antwort mit ### √úberschriften und **fett** f√ºr wichtige Punkte.
Antworte ausschlie√ülich auf Deutsch. Sei pr√§zise, praxisnah und konkret.`;

  let userText=`Analysiere diesen Geb√§udeschaden professionell.\n\n**Auftragsdaten:**\n- Objekt: ${obj}\n- Auftraggeber: ${kunde}\n- Schadensart: ${schaden}\n- Fl√§che: ${flaeche} m¬≤\n- Versicherungsfall: ${vers}\n${budget?'- Budgetrahmen: '+budget+' ‚Ç¨':''}\n${transcript?'\n**M√ºndliche Schadensbeschreibung:**\n'+transcript+'\n':''}${manualDesc?'\n**Schriftliche Schadensbeschreibung:**\n'+manualDesc+'\n':''}\nErstelle folgende Abschnitte:\n`;
  if (modes.has('schaden')) userText+=`\n### Schadensbeurteilung\n- Sichtbare Sch√§den detailliert beschreiben\n- Vermutliche Ursache und Schadensausma√ü\n- Sofortma√ünahmen die jetzt getroffen werden m√ºssen\n`;
  if (modes.has('konzept')) userText+=`\n### Sanierungskonzept\n- Schritt-f√ºr-Schritt Ma√ünahmenplan\n- Ben√∂tigte Ger√§te und Materialien\n- Realistischer Zeitplan (in Tagen/Wochen)\n`;
  if (modes.has('kosten'))  userText+=`\n### Kostensch√§tzung\n- Aufgeschl√ºsselte Kostenpositionen in EUR\n- Ger√§tekosten, Material, Arbeitszeit separat\n- Gesamtsumme Netto + 19% MwSt = Brutto\n`;
  if (modes.has('foerder')) userText+=`\n### F√∂rderung & Versicherung\n- Versicherungsrelevante Hinweise und Dokumentationstipps\n- M√∂gliche F√∂rderungen (KfW, BAFA, Landesf√∂rderprogramme)\n- Empfehlungen f√ºr die Schadensmeldung\n`;

  const parts=[{ type:'text', text:userText }];
  for (let i=0; i<Math.min(photos.length,4); i++)
    parts.push({ type:'image_url', image_url:{ url:'data:image/jpeg;base64,'+photos[i].base64, detail:'high' }});

  setMainStep(3);
  try {
    const response = await fetch('https://api.openai.com/v1/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
      body:JSON.stringify({ model:'gpt-4o', max_tokens:2500,
        messages:[{ role:'system', content:systemPrompt },{ role:'user', content:parts }]})
    });
    const data = await response.json();
    if (!response.ok) throw new Error(data.error?.message||'API Fehler '+response.status);
    setMainStep(4);
    await new Promise(r => setTimeout(r,500));
    lastAnalysis = data.choices[0].message.content;
    document.getElementById('resultContent').innerHTML = formatMarkdown(lastAnalysis);
    document.getElementById('resultCard').classList.add('on');
    document.getElementById('resultCard').scrollIntoView({ behavior:'smooth' });
  } catch(e) { showErr('Analyse-Fehler: '+e.message); }

  document.getElementById('loading').classList.remove('on');
  document.getElementById('analyzeBtn').disabled = false;
}

// ===== RENO W√úNSCHE AUDIO =====
async function toggleRenoRec() {
  if (!renoIsRec) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
      const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')?'audio/webm;codecs=opus':'audio/webm';
      renoMRec = new MediaRecorder(stream,{ mimeType }); renoAChunks=[];
      renoMRec.ondataavailable = e => { if (e.data.size>0) renoAChunks.push(e.data); };
      renoMRec.onstop = () => {
        renoAudBlob = new Blob(renoAChunks,{ type:mimeType });
        stream.getTracks().forEach(t=>t.stop());
        document.getElementById('renoRecStatus').textContent='‚úì OK';
      };
      renoMRec.start(500); renoIsRec=true;
      document.getElementById('renoRecBtn').textContent='‚èπ';
      document.getElementById('renoRecBtn').classList.add('rec');
      document.getElementById('renoRecStatus').textContent='‚óè REC';
      document.getElementById('renoRecStatus').classList.add('active');
    } catch(e) { showErr('Mikrofon-Zugriff verweigert.'); }
  } else {
    renoMRec.stop(); renoIsRec=false;
    document.getElementById('renoRecBtn').textContent='üéôÔ∏è';
    document.getElementById('renoRecBtn').classList.remove('rec');
    document.getElementById('renoRecStatus').classList.remove('active');
  }
}

// ===== VISUALISIERUNG =====
async function generateViz(skipAnalysis=false) {
  const key=document.getElementById('openaiKey').value.trim();
  if (!key) { showErr('Bitte OpenAI Key eingeben.'); return; }
  if (!photos.length) { showErr('Bitte zuerst ein Foto hochladen.'); return; }
  document.getElementById('vizBtn').disabled=true;
  document.getElementById('vizRegenBtn').disabled=true;
  document.getElementById('ldViz').classList.add('on');
  if (!vizHistory.length) document.getElementById('vizResult').style.display='none';

  let userWishes=document.getElementById('renoWishes').value.trim();
  if (renoAudBlob && !skipAnalysis) {
    try {
      const wfd=new FormData();
      wfd.append('file',renoAudBlob,'wuensche.webm'); wfd.append('model','whisper-1'); wfd.append('language','de');
      const wr=await fetch('https://api.openai.com/v1/audio/transcriptions',
        { method:'POST', headers:{'Authorization':'Bearer '+key}, body:wfd });
      if (wr.ok) {
        const wd=await wr.json();
        if (wd.text) {
          const wt=wd.text.trim();
          userWishes=userWishes?userWishes+' ¬∑ '+wt:wt;
          const el=document.getElementById('renoTranscript');
          el.textContent='üéôÔ∏è '+wt; el.classList.add('on');
        }
      }
    } catch(e) { console.warn('W√ºnsche-Transkription fehlgeschlagen:',e); }
  }

  let roomType=cachedRoomType, editPrompt=cachedEditPrompt;
  if (!skipAnalysis || !cachedEditPrompt) {
    setVizStep(1);
    try {
      const r1=await fetch('https://api.openai.com/v1/chat/completions',{
        method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
        body:JSON.stringify({ model:'gpt-4o', max_tokens:600,
          messages:[{ role:'user', content:[
            { type:'image_url', image_url:{ url:'data:image/jpeg;base64,'+photos[0].base64, detail:'high' }},
            { type:'text', text:`Analyze this room photo with extreme precision. Return ONLY valid JSON, no markdown:
{
  "roomType": "room type in German, one word",
  "cameraAngle": "exact camera position in English: height from floor, angle, direction",
  "fixedElements": "every fixture with EXACT position on which wall",
  "fixtureSizes": "size of each fixture relative to room as percentage of wall",
  "renovationMaterials": "default modern materials if user specifies none: wall tiles, floor tiles, fixtures style"
}` }
          ]}]})
      });
      const d1=await r1.json();
      if (d1.choices) {
        const match=d1.choices[0].message.content.trim().match(/\{[\s\S]*\}/);
        if (match) {
          const p=JSON.parse(match[0]);
          if (p.roomType) roomType=p.roomType;
          const materials=userWishes
            ?`Apply user wishes for materials/colors: "${userWishes}". Default fallback: ${p.renovationMaterials||'modern European high-end materials'}.`
            :`Use: ${p.renovationMaterials||'modern European high-end materials, clean and bright'}.`;
          editPrompt=[
            `PHOTO RENOVATION TASK: Edit this photo to show the same room after a modern renovation.`,
            `CAMERA LOCK: Keep the exact camera position, angle and height unchanged ‚Äî ${p.cameraAngle||'same as original'}.`,
            `POSITION LOCK ‚Äî keep every fixture on its exact wall at its exact position, do not move anything: ${p.fixedElements||'all fixtures remain in original position'}.`,
            `SIZE LOCK ‚Äî keep every fixture at its exact original size and scale, do not make anything larger or smaller: ${p.fixtureSizes||'all fixtures keep their original size and proportions'}.`,
            `ONLY CHANGE: surface materials (tiles, paint, flooring), colors, and finish quality. ${materials}`,
            `DO NOT: resize any fixture, move any element, change room proportions, alter camera angle, remove windows/doors/radiators, or invent new architectural elements.`,
            `Result: photorealistic, bright, clean renovation. Soft warm LED lighting. No damage, no stains, no mold.`
          ].join(' ');
          cachedRoomType=roomType; cachedEditPrompt=editPrompt;
        }
      }
    } catch(e) { console.warn('Raumanalyse fehlgeschlagen:',e); }
    if (!editPrompt) editPrompt=cachedEditPrompt||`IMAGE EDITING TASK ‚Äî POSITION LOCK and SIZE LOCK: do not move or resize any fixture. DO NOT change camera angle, room dimensions or layout. ONLY replace damaged/stained surfaces with modern renovation materials. ${userWishes?'User wishes: '+userWishes+'.':''} Photorealistic.`;
  } else {
    if (userWishes) editPrompt=cachedEditPrompt.replace(/ONLY CHANGE:.*?(?=DO NOT:)/,`ONLY CHANGE: surface materials and colors. Apply user wishes: "${userWishes}". `)||cachedEditPrompt;
    setVizStep(1); setVizStep(2);
  }

  setVizStep(2);
  let imageBlob;
  try {
    imageBlob=await resizeImagePNG(photos[0].full,1024);
    if (imageBlob.size>20*1024*1024) throw new Error('Foto ist zu gro√ü (max. 20 MB).');
  } catch(e) {
    showErr('Bild-Vorbereitung fehlgeschlagen: '+e.message);
    document.getElementById('ldViz').classList.remove('on');
    document.getElementById('vizBtn').disabled=false;
    document.getElementById('vizRegenBtn').disabled=false;
    return;
  }

  setVizStep(3);
  try {
    const fd=new FormData();
    fd.append('model','gpt-image-1'); fd.append('image[]',imageBlob,'room.png');
    fd.append('prompt',editPrompt); fd.append('n','1'); fd.append('size','auto'); fd.append('quality','high');
    const response=await fetch('https://api.openai.com/v1/images/edits',
      { method:'POST', headers:{'Authorization':'Bearer '+key}, body:fd });
    const data=await response.json();
    if (!response.ok) throw new Error(data.error?.message||'Bildgenerierung fehlgeschlagen');
    const item=data.data[0];
    const imgSrc=item.b64_json?'data:image/png;base64,'+item.b64_json:item.url;
    vizHistory.push(imgSrc);
    renderVizHistory();
  } catch(e) { showErr('Visualisierung Fehler: '+e.message); }

  document.getElementById('ldViz').classList.remove('on');
  document.getElementById('vizBtn').disabled=false;
  document.getElementById('vizRegenBtn').disabled=false;
}

function renderVizHistory() {
  const variants=vizHistory.map((src,i)=>`
    <div class="viz-item">
      <img src="${src}" alt="Vorschlag ${i+1}" />
      <p>‚ú® Vorschlag ${i+1} ‚Äì ${cachedRoomType}</p>
    </div>`).join('');
  document.getElementById('vizGrid').innerHTML=`
    <div class="viz-item">
      <img src="${photos[0].full}" alt="Vorher" />
      <p>üì∑ IST-Zustand (Schaden)</p>
    </div>${variants}`;
  document.getElementById('vizResult').style.display='block';
  document.getElementById('vizRegenBtn').style.display='inline-flex';
  document.getElementById('vizResult').scrollIntoView({ behavior:'smooth' });
}

function resizeImagePNG(dataUrl, maxSize) {
  return new Promise((resolve,reject) => {
    const img=new Image();
    img.onload=() => {
      const scale=Math.min(maxSize/img.width,maxSize/img.height,1);
      const w=Math.round(img.width*scale), h=Math.round(img.height*scale);
      const canvas=document.createElement('canvas');
      canvas.width=w; canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      canvas.toBlob(blob=>blob?resolve(blob):reject(new Error('PNG-Export fehlgeschlagen')),'image/png');
    };
    img.onerror=()=>reject(new Error('Bild konnte nicht geladen werden'));
    img.src=dataUrl;
  });
}

// ===== VERBESSERUNGSVORSCHLAG WIZARD =====
const WIZ_STEPS=['Raum & Elemente analysieren','Foto f√ºr KI vorbereiten','Verbesserungsbild generieren'];

function setWizStep(n) {
  for (let i=1; i<=3; i++) {
    const el=document.getElementById('wstep'+i); if (!el) continue;
    const label='Schritt '+i+': '+WIZ_STEPS[i-1];
    if (i<n)        { el.className='viz-step done';   el.textContent='‚úÖ '+label; }
    else if (i===n) { el.className='viz-step active'; el.textContent='üîÑ '+label; }
    else            { el.className='viz-step';        el.textContent='‚è≥ '+label; }
  }
}

function updateWizardProgress() {
  document.getElementById('wizardProgressText').textContent=`Foto ${wizIndex+1} von ${photos.length}`;
  document.getElementById('wizardDots').innerHTML=photos.map((_,i)=>
    `<div class="wizard-dot ${i<wizIndex?'done':i===wizIndex?'active':''}"></div>`).join('');
  const isLast=wizIndex===photos.length-1;
  document.getElementById('wizardNextBtn').style.display=isLast?'none':'inline-flex';
  document.getElementById('wizardDoneBtn').style.display=isLast?'inline-flex':'none';
}

async function startVizWizard() {
  const key=document.getElementById('openaiKey').value.trim();
  if (!key)          { showErr('Bitte OpenAI API Key eingeben.');  return; }
  if (!photos.length){ showErr('Bitte zuerst Fotos hochladen.');   return; }
  wizIndex=0;
  wizCachedPrompts=new Array(photos.length).fill('');
  wizCachedTypes=new Array(photos.length).fill('Raum');
  wizResults=[];
  document.getElementById('wizardCard').style.display='block';
  document.getElementById('wizardSummary').style.display='none';
  document.getElementById('wizardResult').style.display='none';
  document.getElementById('wizardCard').scrollIntoView({ behavior:'smooth' });
  await generateWizPhoto(0);
}

async function generateWizPhoto(index, feedback='') {
  const key=document.getElementById('openaiKey').value.trim();
  if (!key) { showErr('Bitte OpenAI API Key eingeben.'); return; }
  wizIndex=index; updateWizardProgress();
  document.getElementById('wizardLoading').classList.add('on');
  document.getElementById('wizardResult').style.display='none';
  document.getElementById('wizardFeedback').value='';

  let editPrompt=feedback?'':wizCachedPrompts[index];
  let roomType=wizCachedTypes[index]||'Raum';

  if (!editPrompt||feedback) {
    setWizStep(1);
    try {
      const r1=await fetch('https://api.openai.com/v1/chat/completions',{
        method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
        body:JSON.stringify({ model:'gpt-4o', max_tokens:600,
          messages:[{ role:'user', content:[
            { type:'image_url', image_url:{ url:'data:image/jpeg;base64,'+photos[index].base64, detail:'high' }},
            { type:'text', text:`Analyze this room photo with extreme precision. Return ONLY valid JSON, no markdown:
{
  "roomType": "room type in German, one word",
  "cameraAngle": "exact camera position: height, angle, direction",
  "fixedElements": "every fixture with EXACT wall position",
  "fixtureSizes": "size of each fixture as % of wall",
  "renovationMaterials": "default modern materials: wall tiles, floor tiles, fixtures style"
}` }
          ]}]})
      });
      const d1=await r1.json();
      if (d1.choices) {
        const match=d1.choices[0].message.content.trim().match(/\{[\s\S]*\}/);
        if (match) {
          const p=JSON.parse(match[0]);
          if (p.roomType) { roomType=p.roomType; wizCachedTypes[index]=roomType; }
          const materials=feedback
            ?`Apply ONLY these user changes: "${feedback}". Keep everything else as default modern renovation: ${p.renovationMaterials||'modern European high-end materials'}.`
            :`Use: ${p.renovationMaterials||'modern European high-end materials, clean and bright'}.`;
          editPrompt=[
            `PHOTO RENOVATION TASK: Edit this photo to show the same room after a modern renovation.`,
            `CAMERA LOCK: Keep the exact camera position, angle and height ‚Äî ${p.cameraAngle||'same as original'}.`,
            `POSITION LOCK ‚Äî keep every fixture on its exact wall at its exact position: ${p.fixedElements||'all fixtures remain'}.`,
            `SIZE LOCK ‚Äî keep every fixture at its exact original size: ${p.fixtureSizes||'all sizes unchanged'}.`,
            `ONLY CHANGE: surface materials (tiles, paint, flooring), colors, finish quality. ${materials}`,
            `DO NOT: resize any fixture, move elements, change room proportions, alter camera angle.`,
            `Result: photorealistic, bright, clean renovation. Soft warm LED lighting. No damage, no stains.`
          ].join(' ');
          if (!feedback) wizCachedPrompts[index]=editPrompt;
        }
      }
    } catch(e) { console.warn('Wizard-Analyse fehlgeschlagen:',e); }
    if (!editPrompt) editPrompt=feedback
      ?`POSITION LOCK and SIZE LOCK. Apply only: "${feedback}". Keep rest unchanged. Photorealistic renovation.`
      :`POSITION LOCK and SIZE LOCK. Modern renovation, clean surfaces, same camera angle. Photorealistic.`;
  }

  setWizStep(2);
  let imageBlob;
  try { imageBlob=await resizeImagePNG(photos[index].full,1024); }
  catch(e) { showErr('Bild-Vorbereitung fehlgeschlagen: '+e.message); document.getElementById('wizardLoading').classList.remove('on'); return; }

  setWizStep(3);
  try {
    const fd=new FormData();
    fd.append('model','gpt-image-1'); fd.append('image[]',imageBlob,'room.png');
    fd.append('prompt',editPrompt); fd.append('n','1'); fd.append('size','auto'); fd.append('quality','high');
    const response=await fetch('https://api.openai.com/v1/images/edits',
      { method:'POST', headers:{'Authorization':'Bearer '+key}, body:fd });
    const data=await response.json();
    if (!response.ok) throw new Error(data.error?.message||'Bildgenerierung fehlgeschlagen');
    const item=data.data[0];
    const imgSrc=item.b64_json?'data:image/png;base64,'+item.b64_json:item.url;
    wizResults[index]={ original:photos[index].full, result:imgSrc, roomType };
    document.getElementById('wizardGrid').innerHTML=`
      <div class="viz-item">
        <img src="${photos[index].full}" alt="Vorher" />
        <p>üì∑ IST-Zustand ‚Äì Foto ${index+1}</p>
      </div>
      <div class="viz-item">
        <img src="${imgSrc}" alt="Vorschlag" />
        <p>‚ú® Verbesserungsvorschlag ‚Äì ${roomType}</p>
      </div>`;
    document.getElementById('wizardDesc').textContent=feedback
      ?`‚úÖ √Ñnderungen umgesetzt: "${feedback}" ‚Äì Gleiche Raumgeometrie und alle Positionen beibehalten.`
      :`‚úÖ Moderner Renovierungsvorschlag f√ºr ${roomType} generiert ‚Äì Oberfl√§chen erneuert, Kamerawinkel & Ma√üe identisch.`;
    document.getElementById('wizardResult').style.display='block';
    document.getElementById('wizardResult').scrollIntoView({ behavior:'smooth' });
  } catch(e) { showErr('Visualisierung Fehler: '+e.message); }
  document.getElementById('wizardLoading').classList.remove('on');
}

async function regenerateCurrentWiz() {
  await generateWizPhoto(wizIndex, document.getElementById('wizardFeedback').value.trim());
}
async function nextWizPhoto() {
  if (wizIndex<photos.length-1) await generateWizPhoto(wizIndex+1);
}
function finishWizard() {
  document.getElementById('wizardSummaryGrid').innerHTML=wizResults.map((r,i)=>`
    <div class="viz-item">
      <img src="${r.original}" alt="Vorher ${i+1}" />
      <p>üì∑ Vorher ‚Äì Foto ${i+1}</p>
    </div>
    <div class="viz-item">
      <img src="${r.result}" alt="Nachher ${i+1}" />
      <p>‚ú® Nachher ‚Äì ${r.roomType}</p>
    </div>`).join('');
  document.getElementById('wizardResult').style.display='none';
  document.getElementById('wizardLoading').classList.remove('on');
  document.getElementById('wizardSummary').style.display='block';
  document.getElementById('wizardSummary').scrollIntoView({ behavior:'smooth' });
}

// ===== RECHNUNG =====
function previewInvoice() {
  const nr=document.getElementById('inv-nr').value||'RE-2024-001';
  const betrag=parseFloat(document.getElementById('inv-betrag').value||'0');
  const email=document.getElementById('inv-email').value||'‚Äì';
  const obj=document.getElementById('objekt').value||'Objekt';
  document.getElementById('invoicePreview').innerHTML=`
    <h4>Rechnung ${nr}</h4>
    <p><strong>Empf√§nger:</strong> ${email}</p>
    <p><strong>Leistung:</strong> Geb√§udetrocknung & Sanierung ‚Äì ${obj}</p>
    <p><strong>Betrag (brutto):</strong> ${betrag.toLocaleString('de-DE',{minimumFractionDigits:2})} ‚Ç¨</p>
    <p><strong>Netto:</strong> ${(betrag/1.19).toLocaleString('de-DE',{minimumFractionDigits:2})} ‚Ç¨ ¬∑ <strong>MwSt 19%:</strong> ${(betrag-betrag/1.19).toLocaleString('de-DE',{minimumFractionDigits:2})} ‚Ç¨</p>`;
  document.getElementById('invoicePreview').classList.add('on');
}
function sendInvoice() {
  const email=document.getElementById('inv-email').value;
  if (!email) { showErr('E-Mail fehlt.'); return; }
  const nr=document.getElementById('inv-nr').value||'RE-2024-001';
  const betrag=document.getElementById('inv-betrag').value||'0';
  const obj=document.getElementById('objekt').value||'Objekt';
  const subject=encodeURIComponent(`Rechnung ${nr} ‚Äì Geb√§udetrocknung Wiegand`);
  const body=encodeURIComponent(`Sehr geehrte Damen und Herren,\n\nbitte √ºberweisen Sie den Rechnungsbetrag von ${betrag} ‚Ç¨ f√ºr die Sanierungsarbeiten am Objekt "${obj}".\n\nRechnungsnummer: ${nr}\n\nMit freundlichen Gr√º√üen\nGeb√§udetrocknung Wiegand\nTel: 01520 88 112 88`);
  window.location.href=`mailto:${email}?subject=${subject}&body=${body}`;
}
function copyResult() {
  navigator.clipboard.writeText(document.getElementById('resultContent').innerText)
    .then(()=>alert('Analyse in die Zwischenablage kopiert!'))
    .catch(()=>showErr('Kopieren fehlgeschlagen.'));
}
</script>
</body>
</html>
