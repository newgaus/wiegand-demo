<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Geb√§udetrocknung Wiegand ‚Äì KI Demo</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --blue:#1a56db; --blue-dark:#1e429f; --blue-light:#ebf5ff;
  --gray-50:#f9fafb; --gray-100:#f3f4f6; --gray-200:#e5e7eb;
  --gray-400:#9ca3af; --gray-500:#6b7280; --gray-600:#4b5563;
  --gray-700:#374151; --gray-800:#1f2937;
  --green:#059669; --green-light:#d1fae5;
  --red:#dc2626; --red-light:#fee2e2;
  --r:12px; --rs:8px;
  --shadow:0 1px 3px rgba(0,0,0,.1);
  --shadow-md:0 4px 12px rgba(0,0,0,.08);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Inter',sans-serif;background:var(--gray-50);color:var(--gray-800);font-size:14px;line-height:1.5;}

/* HEADER */
.header{background:white;border-bottom:1px solid var(--gray-200);padding:16px 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:var(--shadow);}
.header-logo{display:flex;align-items:center;gap:12px;}
.header-logo .icon{width:38px;height:38px;background:var(--blue);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;}
.header-logo h1{font-size:16px;font-weight:700;color:var(--gray-800);line-height:1.2;}
.header-logo p{font-size:11px;color:var(--gray-500);}
.header-right{display:flex;align-items:center;gap:10px;}
.api-input{border:1.5px solid var(--gray-200);border-radius:var(--rs);padding:8px 12px;font-family:monospace;font-size:12px;outline:none;width:280px;transition:border-color .2s;}
.api-input:focus{border-color:var(--blue);}
.api-label{font-size:11px;font-weight:600;color:var(--blue-dark);white-space:nowrap;}

/* MAIN */
.main{max-width:1100px;margin:0 auto;padding:28px 24px;}

/* SECTION TITLE */
.sec-title{font-size:13px;font-weight:700;color:var(--gray-700);text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px;display:flex;align-items:center;gap:7px;}

/* CARD */
.card{background:white;border:1px solid var(--gray-200);border-radius:var(--r);padding:22px;margin-bottom:20px;box-shadow:var(--shadow);}

/* FORM GRID */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;}
.field{margin-bottom:0;}
.field label{display:block;font-size:11px;font-weight:600;color:var(--gray-600);margin-bottom:4px;text-transform:uppercase;letter-spacing:.04em;}
.field input,.field select,.field textarea{width:100%;border:1.5px solid var(--gray-200);border-radius:var(--rs);padding:9px 12px;font-family:'Inter',sans-serif;font-size:13px;color:var(--gray-800);outline:none;transition:border-color .2s;background:white;}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(26,86,219,.07);}
.field textarea{min-height:70px;resize:vertical;line-height:1.6;}

/* MULTI PHOTO UPLOAD */
.upload-area{border:2px dashed var(--gray-300);border-radius:var(--r);padding:20px;text-align:center;cursor:pointer;transition:all .2s;position:relative;background:white;}
.upload-area:hover{border-color:var(--blue);background:var(--blue-light);}
.upload-area input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.upload-icon{font-size:1.8rem;margin-bottom:6px;}
.upload-area p{color:var(--gray-500);font-size:12px;}
.upload-area p span{color:var(--blue);font-weight:600;}
.photos-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-top:14px;}
.photo-thumb{position:relative;border-radius:var(--rs);overflow:hidden;aspect-ratio:1;border:2px solid var(--gray-200);}
.photo-thumb img{width:100%;height:100%;object-fit:cover;}
.photo-thumb .del{position:absolute;top:4px;right:4px;background:rgba(220,38,38,.9);color:white;border:none;border-radius:50%;width:22px;height:22px;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:700;}
.photo-thumb .main-badge{position:absolute;bottom:4px;left:4px;background:var(--blue);color:white;font-size:9px;font-weight:600;padding:2px 5px;border-radius:4px;text-transform:uppercase;}
.photos-count{font-size:11px;color:var(--green);font-weight:500;margin-top:6px;}

/* AUDIO */
.audio-card{display:flex;align-items:flex-start;gap:20px;}
.rec-area{text-align:center;flex-shrink:0;}
.rec-btn{width:68px;height:68px;border-radius:50%;border:2.5px solid var(--blue);background:var(--blue-light);color:var(--blue);font-size:1.7rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;margin:0 auto 8px;}
.rec-btn:hover{background:var(--blue);color:white;}
.rec-btn.rec{border-color:var(--red);background:var(--red-light);color:var(--red);animation:pulse 1s infinite;}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
.rec-status{font-size:11px;font-weight:600;color:var(--gray-400);}
.rec-status.active{color:var(--red);}
.rec-timer{font-size:18px;font-weight:700;color:var(--gray-700);margin-top:4px;font-family:monospace;}
.audio-info{flex:1;}
.audio-info h3{font-size:13px;font-weight:600;color:var(--gray-700);margin-bottom:4px;}
.audio-info p{font-size:12px;color:var(--gray-500);line-height:1.7;}
.audio-prev-wrap{margin-top:10px;display:none;}
.audio-prev-wrap audio{width:100%;border-radius:var(--rs);}
.transcript-box{display:none;background:var(--blue-light);border:1px solid #bfdbfe;border-radius:var(--rs);padding:10px 12px;margin-top:10px;font-size:12px;line-height:1.7;color:var(--gray-700);}
.transcript-box.on{display:block;}
.transcript-lbl{font-size:10px;font-weight:700;color:var(--blue-dark);margin-bottom:3px;text-transform:uppercase;letter-spacing:.05em;}

/* MODES */
.modes{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px;}
.mchip{border:1.5px solid var(--gray-200);border-radius:var(--rs);padding:10px 6px;text-align:center;cursor:pointer;transition:all .2s;background:white;font-size:10px;font-weight:600;color:var(--gray-500);}
.mchip:hover{border-color:var(--blue);color:var(--blue);}
.mchip.on{border-color:var(--blue);background:var(--blue-light);color:var(--blue);}
.mchip .mi{font-size:1.2rem;display:block;margin-bottom:2px;}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:6px;border:none;border-radius:var(--rs);padding:10px 18px;font-family:'Inter',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;}
.btn-p{background:var(--blue);color:white;}
.btn-p:hover{background:var(--blue-dark);}
.btn-p:disabled{opacity:.5;cursor:not-allowed;}
.btn-s{background:white;color:var(--gray-700);border:1.5px solid var(--gray-200);}
.btn-s:hover{background:var(--gray-50);}
.btn-g{background:var(--green);color:white;}
.btn-g:hover{opacity:.9;}
.btn-full{width:100%;justify-content:center;padding:13px;font-size:14px;}

/* LOADING */
.loading{display:none;text-align:center;padding:36px;}
.loading.on{display:block;}
.spinner{width:36px;height:36px;border:3px solid var(--gray-200);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 12px;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading p{color:var(--gray-500);font-size:13px;}
.loading span{color:var(--blue);font-weight:600;}
.loading-steps{margin-top:12px;}
.step{font-size:12px;color:var(--gray-400);padding:3px 0;}
.step.active{color:var(--blue);font-weight:600;}
.step.done{color:var(--green);}

/* RESULT */
.result-box{display:none;}
.result-box.on{display:block;}
.result-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;padding-bottom:14px;border-bottom:1px solid var(--gray-100);}
.result-title{font-size:15px;font-weight:700;color:var(--green);display:flex;align-items:center;gap:6px;}
.result-actions{display:flex;gap:8px;}
.result-content{font-size:13px;line-height:1.9;color:var(--gray-700);}
.result-content h3{font-size:11px;font-weight:700;color:var(--blue-dark);text-transform:uppercase;letter-spacing:.06em;margin:20px 0 7px;padding-bottom:4px;border-bottom:1px solid var(--gray-100);}
.result-content h3:first-child{margin-top:0;}
.result-content strong{color:var(--gray-800);font-weight:600;}

/* VIZ */
.viz-wrap{background:linear-gradient(135deg,#eff6ff,#dbeafe);border:1px solid #bfdbfe;border-radius:var(--r);padding:20px;margin-top:16px;}
.viz-hdr{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:14px;}
.viz-hdr-text h3{font-size:14px;font-weight:700;color:var(--blue-dark);margin-bottom:3px;}
.viz-hdr-text p{font-size:11px;color:var(--gray-500);}
.viz-grid{display:grid;grid-template-columns:1fr; gap:14px;margin-top:12px;}
.viz-item{text-align:center;}
.viz-item img{width:100%;border-radius:10px;border:1px solid var(--gray-200);box-shadow:var(--shadow-md);}
.viz-item p{font-size:10px;color:var(--gray-400);margin-top:5px;text-transform:uppercase;letter-spacing:.05em;}

/* RECHNUNG */
.invoice-wrap{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:1px solid #86efac;border-radius:var(--r);padding:20px;margin-top:16px;}
.invoice-wrap h3{font-size:14px;font-weight:700;color:#166534;margin-bottom:4px;}
.invoice-wrap>p{font-size:12px;color:var(--gray-600);margin-bottom:14px;}
.invoice-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:14px;}
.invoice-field label{display:block;font-size:10px;font-weight:700;color:#166534;margin-bottom:3px;text-transform:uppercase;letter-spacing:.04em;}
.invoice-field input{width:100%;border:1.5px solid #86efac;border-radius:var(--rs);padding:8px 11px;font-family:'Inter',sans-serif;font-size:13px;outline:none;background:white;transition:border-color .2s;}
.invoice-field input:focus{border-color:var(--green);}
.invoice-preview{background:white;border:1px solid var(--gray-200);border-radius:var(--rs);padding:16px;margin-bottom:12px;display:none;font-size:12px;line-height:1.8;}
.invoice-preview.on{display:block;}
.invoice-preview h4{font-size:14px;font-weight:700;margin-bottom:8px;color:var(--gray-800);}
.err-bar{display:none;background:var(--red-light);border:1px solid #fca5a5;color:var(--red);padding:9px 14px;border-radius:var(--rs);font-size:12px;margin-bottom:14px;}
.err-bar.on{display:block;}

/* PROGRESS BAR */
.progress-bar{height:3px;background:var(--gray-100);border-radius:2px;margin-top:8px;overflow:hidden;}
.progress-fill{height:100%;background:var(--blue);border-radius:2px;transition:width .3s;width:0%;}

@media(max-width:768px){
  .g2,.g3,.modes,.invoice-grid{grid-template-columns:1fr;}
  .header{flex-direction:column;gap:10px;align-items:flex-start;}
  .api-input{width:100%;}
  .audio-card{flex-direction:column;}
}
</style>
<script src="https://cdn.jsdelivr.net/npm/@fal-ai/client/dist/index.umd.js"></script>
</head>
<body>

<div class="header">
  <div class="header-logo">
    <div class="icon"></div>
    <div>
      <h1>Geb√§udetrocknung Wiegand</h1>
      <p>KI-Demo ¬∑ Eschwege ¬∑ 01520 88 112 88</p>
    </div>
  </div>
  <div class="header-right">
    <span class="api-label">üîë Gemini Key</span>
    <input class="api-input" type="password" id="apiKey" placeholder="AIza..." />
  </div>
</div>

<div class="main">
  <div class="err-bar" id="errBar"></div>

  <div class="card">
    <div class="sec-title"> Objektdaten</div>
    <div class="g3" style="margin-bottom:12px">
      <div class="field"><label>Objekt / Adresse</label><input type="text" id="objekt" placeholder="z.B. EFH, Musterstr. 5, Eschwege" /></div>
      <div class="field"><label>Auftraggeber</label><input type="text" id="auftraggeber" placeholder="z.B. Familie M√ºller" /></div>
      <div class="field">
        <label>Art des Schadens</label>
        <select id="schadensart">
          <option value="">Bitte w√§hlen...</option>
          <option>Wasserschaden (Rohrbruch)</option>
          <option>Wasserschaden (√úberschwemmung)</option>
          <option>Leckage (unbekannte Ursache)</option>
          <option>Schimmelbefall</option>
          <option>Feuchtigkeit in W√§nden/B√∂den</option>
          <option>Badezimmer-Sanierung</option>
          <option>Keller-Sanierung</option>
          <option>Sonstiges</option>
        </select>
      </div>
    </div>
    <div class="g3">
      <div class="field"><label>Fl√§che (m¬≤)</label><input type="number" id="flaeche" placeholder="z.B. 12" /></div>
      <div class="field">
        <label>Versicherungsfall</label>
        <select id="versicherung"><option>Nein</option><option>Ja ‚Äì Wohngeb√§ude</option><option>Ja ‚Äì Hausrat</option><option>Ja ‚Äì Haftpflicht</option><option>Unklar</option></select>
      </div>
      <div class="field"><label>Kostensch√§tzung Ziel (‚Ç¨)</label><input type="number" id="budget" placeholder="z.B. 5000" /></div>
    </div>
  </div>

  <div class="card">
    <div class="sec-title"> Fotos des Schadens <span style="font-size:11px;font-weight:400;color:var(--gray-400);text-transform:none;letter-spacing:0">(mehrere m√∂glich ‚Äì erstes Foto = Hauptbild f√ºr 3D)</span></div>
    <div class="upload-area" id="uploadArea">
      <input type="file" id="fileInput" accept="image/*" multiple onchange="handleFiles(this)" />
      <div class="upload-icon"></div>
      <p>Fotos hier ablegen oder <span>ausw√§hlen</span></p>
      <p style="font-size:10px;margin-top:3px;color:var(--gray-400)">Mehrere Fotos gleichzeitig m√∂glich ¬∑ JPG, PNG, WEBP</p>
    </div>
    <div class="photos-grid" id="photosGrid"></div>
    <div class="photos-count" id="photosCount"></div>
  </div>

  <div class="card">
    <div class="sec-title"> Sprachbeschreibung <span style="font-size:11px;font-weight:400;color:var(--gray-400);text-transform:none;letter-spacing:0">(unbegrenzte L√§nge)</span></div>
    <div class="audio-card">
      <div class="rec-area">
        <button class="rec-btn" id="recBtn" onclick="toggleRec()"></button>
        <div class="rec-status" id="recStatus">Dr√ºcken</div>
        <div class="rec-timer" id="recTimer" style="display:none">0:00</div>
      </div>
      <div class="audio-info">
        <h3>Beschreiben Sie den Schaden m√ºndlich</h3>
        <p>
          ‚Ä¢ Sprechen Sie so lange Sie m√∂chten ‚Äì keine Zeitbegrenzung<br>
          ‚Ä¢ Beschreiben Sie was Sie sehen: W√§nde, Boden, Decke<br>
          ‚Ä¢ Erw√§hnen Sie Ger√ºche (Schimmel, Moder)<br>
          ‚Ä¢ Sagen Sie wo genau der Schaden ist<br>
          ‚Ä¢ Hinweise auf Ursache wenn bekannt
        </p>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="audio-prev-wrap" id="audioPrev">
          <audio id="audioPlayer" controls style="margin-top:10px"></audio>
          <p style="color:var(--green);font-size:11px;margin-top:4px;font-weight:500">‚úì Aufnahme gespeichert ‚Äì bereit zur Analyse</p>
        </div>
        <div class="transcript-box" id="transcriptBox">
          <div class="transcript-lbl">Ô∏è Transkript</div>
          <div id="transcriptText"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="sec-title">‚öôÔ∏è Was soll erstellt werden?</div>
    <div class="modes">
      <div class="mchip on" id="m-schaden" onclick="toggleM('schaden')"><span class="mi"></span>Schadensbeurteilung</div>
      <div class="mchip on" id="m-konzept" onclick="toggleM('konzept')"><span class="mi"></span>Sanierungskonzept</div>
      <div class="mchip on" id="m-kosten" onclick="toggleM('kosten')"><span class="mi"></span>Kostensch√§tzung</div>
      <div class="mchip on" id="m-foerder" onclick="toggleM('foerder')"><span class="mi"></span>F√∂rderung & Versicherung</div>
    </div>
    <button class="btn btn-p btn-full" id="analyzeBtn" onclick="runAnalyse()"> KI-Analyse starten</button>
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p id="ldText">Analysiere... <span>Bitte warten</span></p>
    <div class="loading-steps">
      <div class="step" id="step1">‚è≥ Sprache transkribieren</div>
      <div class="step" id="step2">‚è≥ Fotos analysieren</div>
      <div class="step" id="step3">‚è≥ Sanierungskonzept erstellen</div>
      <div class="step" id="step4">‚è≥ Kostensch√§tzung berechnen</div>
    </div>
  </div>

  <div class="card result-box" id="resultCard">
    <div class="result-hdr">
      <div class="result-title">‚úÖ Analyse abgeschlossen</div>
      <div class="result-actions">
        <button class="btn btn-s" onclick="copyResult()"> Kopieren</button>
      </div>
    </div>
    <div class="result-content" id="resultContent"></div>

    <div class="viz-wrap" id="vizWrap">
      <div class="viz-hdr">
        <div class="viz-hdr-text">
          <h3>ü™Ñ KI-Visualisierung: Raum-Sanierung</h3>
          <p>KI beh√§lt die Raumstruktur (Fenster/T√ºren) exakt bei und rendert einen modernen "Nachher"-Vorschlag.</p>
        </div>
        <button class="btn btn-p" id="vizBtn" onclick="generateViz()">‚ú® Vorschau generieren</button>
      </div>
      <div class="loading" id="ldViz" style="padding:20px">
        </div>
      <div id="vizResult" style="display:none">
        <div class="viz-grid" id="vizGrid"></div>
        <p style="font-size:11px;color:var(--gray-400);margin-top:10px;text-align:center">Ziehe den Schieberegler, um das Vorher-Nachher Ergebnis zu vergleichen.</p>
      </div>
    </div>

    <div class="invoice-wrap" id="invoiceWrap">
      <h3> Rechnung an Kunden senden</h3>
      <p>Rechnung wird automatisch aus der Analyse erstellt ‚Äì nur E-Mail eingeben und senden</p>
      <div class="invoice-grid">
        <div class="invoice-field"><label>Kunden-E-Mail</label><input type="email" id="inv-email" placeholder="kunde@email.de" /></div>
        <div class="invoice-field"><label>Rechnungsnummer</label><input type="text" id="inv-nr" placeholder="RE-2024-001" /></div>
        <div class="invoice-field"><label>Gesamtbetrag (‚Ç¨ brutto)</label><input type="number" id="inv-betrag" placeholder="3500" /></div>
      </div>
      <div class="invoice-preview" id="invoicePreview"></div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btn-s" onclick="previewInvoice()">Ô∏è Vorschau</button>
        <button class="btn btn-g" onclick="sendInvoice()"> Rechnung senden</button>
      </div>
      <div id="sendStatus" style="margin-top:10px;font-size:12px;"></div>
    </div>
  </div>

</div>

<script>
// ===== SYSTEM PROMPT =====
const SYS = `Du bist der KI-Assistent der Firma Geb√§udetrocknung Wiegand, Forstgasse 19a, 37269 Eschwege.
Tel: 01520 88 112 88 ¬∑ E-Mail: kontakt@gebaeudetrocknung-wiegand.de
Gesch√§ftsf√ºhrer: Werner Wiegand & Rayk Wiegand

LEISTUNGEN:
- Leckageortung & Schadensanalyse mit modernster Technik
- Wasserschadensanierung (Rohrbruch, √úberschwemmung, Leckage)
- Bautrocknung: Kondensationstrockner, Adsorptionstrockner, Infrarotheizung
- Feuchtemessung: CM-Messung, elektrische Widerstandsmessung
- Schimmelbehandlung: Neutralisation, Desinfektion, Biozide
- Dokumentation & Trocknungsprotokoll f√ºr Versicherungen
- Versicherungskommunikation & Schadensabwicklung

Erstelle immer pr√§zise, professionelle, praxisnahe Analysen auf Deutsch mit realistischen Preisen f√ºr die Region Hessen/Nordhessen.`;

// ===== STATE =====
let photos = []; // [{base64, name}]
let audBlob = null, isRec = false;
let mRec = null, aChunks = [];
let timerInterval = null, recSeconds = 0;
let modes = new Set(['schaden','konzept','kosten','foerder']);
let lastAnalysis = '';
let kostensection = '';

// ===== MULTI FOTO =====
function handleFiles(input) {
  const files = Array.from(input.files);
  if (!files.length) return;
  let loaded = 0;
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      photos.push({ base64: e.target.result.split(',')[1], name: file.name, full: e.target.result });
      loaded++;
      if (loaded === files.length) renderPhotos();
    };
    reader.readAsDataURL(file);
  });
}

function renderPhotos() {
  const grid = document.getElementById('photosGrid');
  grid.innerHTML = photos.map((p,i) => `
    <div class="photo-thumb">
      <img src="${p.full}" alt="${p.name}" />
      <button class="del" onclick="removePhoto(${i})">√ó</button>
      ${i===0?'<span class="main-badge">Haupt</span>':''}
    </div>
  `).join('');
  const count = document.getElementById('photosCount');
  count.textContent = photos.length > 0 ? `‚úì ${photos.length} Foto${photos.length>1?'s':''} geladen` : '';
  document.getElementById('fileInput').value = '';
}

function removePhoto(i) {
  photos.splice(i, 1);
  renderPhotos();
}

// ===== AUDIO =====
async function toggleRec() {
  if (!isRec) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
        ? 'audio/webm;codecs=opus'
        : MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : 'audio/webm';
      mRec = new MediaRecorder(stream, { mimeType, audioBitsPerSecond: 128000 });
      aChunks = [];
      mRec.ondataavailable = e => { if (e.data.size > 0) aChunks.push(e.data); };
      mRec.onstop = () => {
        audBlob = new Blob(aChunks);
        document.getElementById('audioPlayer').src = URL.createObjectURL(audBlob);
        document.getElementById('audioPrev').style.display = 'block';
        stream.getTracks().forEach(t => t.stop());
      };
      mRec.start(500);
      isRec = true;
      recSeconds = 0;
      document.getElementById('recBtn').textContent = '‚èπ';
      document.getElementById('recBtn').classList.add('rec');
      document.getElementById('recStatus').textContent = '‚óè Aufnahme';
      document.getElementById('recStatus').classList.add('active');
      document.getElementById('recTimer').style.display = 'block';
      timerInterval = setInterval(() => {
        recSeconds++;
        const m = Math.floor(recSeconds / 60);
        const s = recSeconds % 60;
        document.getElementById('recTimer').textContent = `${m}:${String(s).padStart(2,'0')}`;
        document.getElementById('progressFill').style.width = Math.min((recSeconds/120)*100, 100) + '%';
      }, 1000);
    } catch(e) { showErr('Mikrofon-Zugriff verweigert. Bitte in den Browser-Einstellungen erlauben.'); }
  } else {
    mRec.stop(); isRec = false;
    clearInterval(timerInterval);
    document.getElementById('recBtn').textContent = '';
    document.getElementById('recBtn').classList.remove('rec');
    document.getElementById('recStatus').textContent = '‚úì Gespeichert';
    document.getElementById('recStatus').classList.remove('active');
  }
}

// ===== MODES =====
function toggleM(m) {
  const el = document.getElementById('m-'+m);
  if (modes.has(m)) { modes.delete(m); el.classList.remove('on'); }
  else { modes.add(m); el.classList.add('on'); }
}

function setStep(n, status) {
  for (let i = 1; i <= 4; i++) {
    const el = document.getElementById('step'+i);
    el.classList.remove('active','done');
    if (i < n) el.classList.add('done'), el.textContent = el.textContent.replace('‚è≥','‚úÖ');
    if (i === n) { el.classList.add('active'); status && (el.textContent = status); }
  }
}

// ===== ANALYSE =====
async function runAnalyse() {
  const key = document.getElementById('apiKey').value.trim();
  document.getElementById('errBar').className = 'err-bar';
  if (!key) { showErr('Bitte Gemini API Key eingeben.'); return; }
  if (!photos.length && !audBlob) { showErr('Bitte mindestens ein Foto hochladen oder Sprachaufnahme machen.'); return; }

  document.getElementById('analyzeBtn').disabled = true;
  document.getElementById('loading').style.display = 'block';
  document.getElementById('resultCard').style.display = 'none';

  const kunde  = document.getElementById('auftraggeber')?.value || '';
  const obj    = document.getElementById('objekt')?.value || '';
  const flaeche= document.getElementById('flaeche')?.value || '';
  const vers   = document.getElementById('versicherung')?.value || 'Keine Angabe';
  const budget = document.getElementById('budget')?.value || '';
  const checks = Array.from(document.querySelectorAll('.mchip.on')).map(b => b.innerText).join(', ') || 'Allgemeine Analyse';

  const parts = [];

  parts.push({ text: `Du bist ein erfahrener Gutachter f√ºr Geb√§udesch√§den bei Geb√§udetrocknung Wiegand in Eschwege.
Analysiere den Wasserschaden anhand der Fotos und erstelle einen professionellen deutschen Bericht.

Objektdaten:
Kunde: ${kunde || 'nicht angegeben'}
Objekt: ${obj || 'nicht angegeben'}
Betroffene Fl√§che: ${flaeche || '?'} m¬≤
Versicherung: ${vers}
${budget ? 'Budgetrahmen: ' + budget + '‚Ç¨' : ''}
Gew√ºnschte Analyse: ${checks}

Erstelle einen strukturierten Bericht mit:
### Schadensbeschreibung
### Ursachenanalyse
### Sofortma√ünahmen
### Sanierungskonzept
### Kostensch√§tzung
### F√∂rderm√∂glichkeiten

Antworte auf Deutsch, professionell und detailliert.` });

  for (let i = 0; i < Math.min(photos.length, 4); i++) {
    parts.push({ inline_data: { mime_type: 'image/jpeg', data: photos[i].base64 } });
  }

  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ role: 'user', parts }],
          generationConfig: { temperature: 0.4, maxOutputTokens: 2048 }
        })
      }
    );
    const data = await response.json();
    if (!response.ok) throw new Error(data.error?.message || response.status);

    const text = data.candidates[0].content.parts[0].text;
    lastAnalysis = text;

    const html = text
      .replace(/### (.+)/g, '<h3>$1</h3>')
      .replace(/[*][*](.+?)[*][*]/g, '<strong>$1</strong>')
      .replace(/\n/g, '<br>');

    document.getElementById('resultContent').innerHTML = html;
    document.getElementById('resultCard').style.display = 'block';
    document.getElementById('resultCard').scrollIntoView({behavior:'smooth'});

    const kostenMatch = text.match(/Kostensch√§tzung[\s\S]*?(?=###|$)/i);
    if (kostenMatch) kostensection = kostenMatch[0];

  } catch(e) {
    showErr('Analyse-Fehler: ' + e.message);
  }

  document.getElementById('loading').style.display = 'none';
  document.getElementById('analyzeBtn').disabled = false;
}

// ===== NEUE NANO BANANA VISUALISIERUNG MIT SLIDER =====
async function generateViz() {
  const key = document.getElementById('apiKey').value.trim();
  if (!key) { showErr('Bitte Gemini API Key eingeben (AIza...).'); return; }
  if (!photos.length) { showErr('Bitte zuerst ein Foto hochladen.'); return; }

  document.getElementById('vizBtn').disabled = true;
  document.getElementById('ldViz').classList.add('on');
  document.getElementById('ldViz').innerHTML = '<div class="spinner"></div><p>Raumstruktur wird beibehalten & saniert... <span>Bitte warten (~15s)</span></p>';
  document.getElementById('vizResult').style.display = 'none';

  try {
    // 1. Raumtyp schnell erkennen (optionaler Step zur Prompt-Verbesserung)
    let raum = 'room';
    try {
      const r1 = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ role: 'user', parts: [
          { inline_data: { mime_type: 'image/jpeg', data: photos[0].base64 } },
          { text: 'Translate the type of room in this picture to English (e.g. bathroom, basement, living room). Reply with just ONE word.' }
        ]}]})
      });
      const d1 = await r1.json();
      if (d1.candidates) raum = d1.candidates[0].content.parts[0].text.trim().split(' ')[0];
    } catch(e) { console.log("Raumerkennung √ºbersprungen"); }

    // 2. Nano Banana API f√ºr die Vorher/Nachher Komposition aufrufen
    const architectPrompt = `A professional architectural photo of a perfectly renovated interior ${raum}. Clean, freshly plastered walls, modern flooring, flawless condition, soft volumetric lighting, highly detailed, photorealistic, 4k resolution. No water damage, no mold, no dirt.`;

    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/nano-banana:generateImage?key=${key}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        prompt: architectPrompt,
        source_image: photos[0].base64, // Dein kaputtes Foto als Ger√ºst
        edit_mode: "composition" // Zwingt die KI, die W√§nde exakt beizubehalten
      })
    });
    
    const data = await response.json();
    if (!response.ok) throw new Error(data.error?.message || "Fehler bei der Bildgenerierung");
    
    // Fallback: Falls die API das Bild als Base64 oder URL liefert
    const imgSrc = data.images && data.images[0].url ? data.images[0].url : `data:image/jpeg;base64,${data.images[0].base64}`;

    // 3. Den interaktiven Slider ins HTML einbauen
    const grid = document.getElementById('vizGrid');
    grid.innerHTML = `
      <div style="grid-column: 1 / -1; margin-top: 10px;">
        <div style="position:relative; width:100%; max-width:800px; margin:0 auto; border-radius:12px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.15); height: 400px; background:#000;">
          
          <img src="${imgSrc}" id="afterImg" style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:1;" alt="Saniert">
          
          <img src="${photos[0].full}" id="beforeImg" style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:2; clip-path:polygon(0 0, 50% 0, 50% 100%, 0 100%);" alt="Wasserschaden">

          <div id="sliderLine" style="position:absolute; top:0; left:50%; width:4px; height:100%; background:white; z-index:2; pointer-events:none; box-shadow:0 0 10px rgba(0,0,0,0.5);"></div>
          <div id="sliderBtn" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:36px; height:36px; background:white; border-radius:50%; z-index:2; pointer-events:none; box-shadow:0 0 10px rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; font-size:12px; color:#1a56db; font-weight:bold;">‚óÑ‚ñ∫</div>

          <input type="range" min="0" max="100" value="50" oninput="
            document.getElementById('beforeImg').style.clipPath = 'polygon(0 0, ' + this.value + '% 0, ' + this.value + '% 100%, 0 100%)';
            document.getElementById('sliderLine').style.left = this.value + '%';
            document.getElementById('sliderBtn').style.left = this.value + '%';
          " style="position:absolute; top:0; left:0; width:100%; height:100%; z-index:3; opacity:0; cursor:ew-resize;">
          
        </div>
      </div>
    `;
    
    document.getElementById('vizResult').style.display = 'block';
    document.getElementById('vizResult').scrollIntoView({behavior:'smooth'});

  } catch(e) {
    showErr('Visualisierung Fehler: ' + e.message);
  }

  document.getElementById('ldViz').classList.remove('on');
  document.getElementById('vizBtn').disabled = false;
}

// ===== RECHNUNG =====
function previewInvoice() {
  const email = document.getElementById('inv-email').value;
  const nr = document.getElementById('inv-nr').value || 'RE-2024-001';
  const betrag = document.getElementById('inv-betrag').value;
  const obj = document.getElementById('objekt').value || 'Objekt';
  const kunde = document.getElementById('auftraggeber').value || 'Kunde';
  const datum = new Date().toLocaleDateString('de-DE');

  const html = `<h4>Rechnung ${nr}</h4>
<strong>Geb√§udetrocknung Wiegand</strong><br>
Forstgasse 19a ¬∑ 37269 Eschwege<br>
Tel: 01520 88 112 88 ¬∑ kontakt@gebaeudetrocknung-wiegand.de<br><br>
<strong>An:</strong> ${kunde}<br>
<strong>Objekt:</strong> ${obj}<br>
<strong>Datum:</strong> ${datum}<br>
<strong>Rechnungsnummer:</strong> ${nr}<br><br>
<strong>Leistungsbeschreibung:</strong><br>
${kostensection.trim() || 'Wasserschadensanierung gem√§√ü Angebot und Beauftragung'}<br><br>
${betrag ? `<strong>Gesamtbetrag brutto (inkl. 19% MwSt.): ${Number(betrag).toLocaleString('de-DE')}‚Ç¨</strong>` : ''}<br><br>
Zahlbar innerhalb von 14 Tagen ohne Abzug.<br>
Bankverbindung: auf Anfrage<br><br>
Mit freundlichen Gr√º√üen,<br>
<strong>Werner Wiegand & Rayk Wiegand</strong><br>
Geb√§udetrocknung Wiegand`;

  document.getElementById('invoicePreview').innerHTML = html;
  document.getElementById('invoicePreview').classList.add('on');
}

function sendInvoice() {
  const email = document.getElementById('inv-email').value;
  if (!email) { showErr('Bitte E-Mail-Adresse des Kunden eingeben.'); return; }

  const nr = document.getElementById('inv-nr').value || 'RE-2024-001';
  const betrag = document.getElementById('inv-betrag').value;
  const obj = document.getElementById('objekt').value || 'Objekt';
  const kunde = document.getElementById('auftraggeber').value || 'Kunde';
  const datum = new Date().toLocaleDateString('de-DE');

  const body = `Sehr geehrte/r ${kunde},

anbei erhalten Sie Ihre Rechnung f√ºr die durchgef√ºhrten Arbeiten.

Rechnungsnummer: ${nr}
Datum: ${datum}
Objekt: ${obj}

LEISTUNGSBESCHREIBUNG:
${kostensection.replace(/###[^\n]*/,'').replace(/\*\*/g,'').replace(/<br>/g,'\n').trim() || 'Wasserschadensanierung gem√§√ü Beauftragung'}

${betrag ? 'GESAMTBETRAG BRUTTO (inkl. 19% MwSt.): ' + Number(betrag).toLocaleString('de-DE') + '‚Ç¨' : ''}

Zahlbar innerhalb von 14 Tagen ohne Abzug.

Bei Fragen stehen wir Ihnen gerne zur Verf√ºgung.

Mit freundlichen Gr√º√üen

Werner Wiegand & Rayk Wiegand
Geb√§udetrocknung Wiegand
Forstgasse 19a ¬∑ 37269 Eschwege
Tel: 01520 88 112 88
kontakt@gebaeudetrocknung-wiegand.de`;

  const subject = encodeURIComponent(`Rechnung ${nr} ‚Äì Geb√§udetrocknung Wiegand`);
  const bodyEnc = encodeURIComponent(body);
  window.location.href = `mailto:${email}?subject=${subject}&body=${bodyEnc}`;

  document.getElementById('sendStatus').innerHTML = `<span style="color:var(--green);font-weight:600">‚úÖ E-Mail-Programm ge√∂ffnet ‚Äì Rechnung an ${email} bereit zum Senden!</span>`;
}

// ===== HELPERS =====
function copyResult() {
  navigator.clipboard.writeText(document.getElementById('resultContent').innerText).then(() => alert('‚úÖ Analyse kopiert!'));
}
function showErr(msg) {
  const el = document.getElementById('errBar');
  el.textContent = '‚ùå ' + msg;
  el.className = 'err-bar on';
  setTimeout(() => el.className = 'err-bar', 7000);
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
</script>

</body>
</html>
