<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Geb√§udetrocknung Wiegand ‚Äì KI Analyse</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d1117; --surface: #161b22; --surface2: #1c2330;
    --border: #30363d; --accent: #e8a020; --text: #e6edf3;
    --text-muted: #8b949e; --success: #3fb950; --danger: #f85149;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; font-weight: 300; min-height: 100vh; }
  body::before { content: ''; position: fixed; inset: 0; background-image: linear-gradient(rgba(232,160,32,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(232,160,32,0.03) 1px, transparent 1px); background-size: 40px 40px; pointer-events: none; z-index: 0; }

  #loginScreen { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 100; }
  .login-box { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 48px 40px; width: 100%; max-width: 420px; text-align: center; }
  .login-box h1 { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; letter-spacing: 0.1em; margin-bottom: 4px; }
  .login-box h1 span { color: var(--accent); }
  .login-box p { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 32px; }
  .login-box input { width: 100%; background: var(--surface2); border: 1px solid var(--border); color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 1rem; padding: 14px 16px; border-radius: 10px; outline: none; margin-bottom: 16px; text-align: center; letter-spacing: 0.2em; }
  .login-box input:focus { border-color: var(--accent); }
  .login-btn { width: 100%; background: var(--accent); color: #0d1117; border: none; font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 0.15em; padding: 16px; border-radius: 10px; cursor: pointer; }
  .login-error { color: var(--danger); font-size: 0.85rem; margin-top: 12px; display: none; }

  #app { display: none; position: relative; z-index: 1; }
  .container { max-width: 860px; margin: 0 auto; padding: 40px 24px; }
  .header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid var(--border); }
  .logo-area h1 { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; letter-spacing: 0.08em; line-height: 1; }
  .logo-area h1 span { color: var(--accent); }
  .logo-area p { font-size: 0.75rem; color: var(--text-muted); letter-spacing: 0.15em; text-transform: uppercase; margin-top: 6px; }
  .badge { background: rgba(232,160,32,0.12); border: 1px solid rgba(232,160,32,0.3); color: var(--accent); font-size: 0.7rem; font-weight: 500; letter-spacing: 0.1em; text-transform: uppercase; padding: 5px 12px; border-radius: 20px; }

  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 28px; margin-bottom: 20px; }
  .card h2 { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 0.1em; color: var(--accent); margin-bottom: 18px; }

  .api-row { display: flex; align-items: center; gap: 12px; }
  .api-row label { font-size: 0.78rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; white-space: nowrap; font-weight: 500; }
  .api-row input { flex: 1; background: var(--surface2); border: 1px solid var(--border); color: var(--text); font-family: monospace; font-size: 0.85rem; padding: 10px 14px; border-radius: 8px; outline: none; }
  .api-row input:focus { border-color: var(--accent); }

  .field { margin-bottom: 16px; }
  .field label { display: block; font-size: 0.78rem; font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 8px; }
  .field input { width: 100%; background: var(--surface2); border: 1px solid var(--border); color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.95rem; padding: 12px 16px; border-radius: 10px; outline: none; }
  .field input:focus { border-color: var(--accent); }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

  .upload-zone { border: 2px dashed var(--border); border-radius: 12px; padding: 32px 20px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; }
  .upload-zone:hover { border-color: var(--accent); background: rgba(232,160,32,0.04); }
  .upload-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
  .upload-icon { font-size: 2rem; margin-bottom: 10px; }
  .upload-zone p { color: var(--text-muted); font-size: 0.88rem; }
  .upload-zone p span { color: var(--accent); }
  .preview-img { margin-top: 14px; display: none; }
  .preview-img img { max-width: 100%; max-height: 250px; border-radius: 8px; border: 1px solid var(--border); }
  .preview-img p { margin-top: 6px; color: var(--success); font-size: 0.82rem; }

  .audio-section { text-align: center; }
  .record-btn { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--accent); background: var(--surface2); color: var(--accent); font-size: 2rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; }
  .record-btn.recording { border-color: var(--danger); color: var(--danger); animation: pulse 1s infinite; }
  @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
  .record-status { color: var(--text-muted); font-size: 0.88rem; margin-bottom: 12px; }
  .record-status.active { color: var(--danger); font-weight: 500; }
  .audio-preview { display: none; margin-top: 12px; }
  .audio-preview audio { width: 100%; border-radius: 8px; }
  .audio-preview p { color: var(--success); font-size: 0.82rem; margin-top: 6px; }
  .transcript-box { display: none; background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin-top: 12px; font-size: 0.88rem; line-height: 1.6; text-align: left; }
  .transcript-box.active { display: block; }
  .transcript-label { font-size: 0.72rem; color: var(--accent); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 6px; font-weight: 500; }

  .btn-analyze { width: 100%; background: var(--accent); color: #0d1117; border: none; font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 0.15em; padding: 18px; border-radius: 10px; cursor: pointer; transition: all 0.2s; margin-bottom: 20px; }
  .btn-analyze:hover { opacity: 0.9; transform: translateY(-1px); }
  .btn-analyze:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  .loading { display: none; text-align: center; padding: 48px; background: var(--surface); border: 1px solid var(--border); border-radius: 16px; margin-bottom: 20px; }
  .loading.active { display: block; }
  .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading p { color: var(--text-muted); font-size: 0.9rem; }
  .loading p span { color: var(--accent); }

  .result-card { display: none; background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 32px; margin-bottom: 20px; }
  .result-card.active { display: block; }
  .result-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
  .result-header h2 { font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; letter-spacing: 0.1em; color: var(--success); }
  .btn-copy { background: var(--surface2); border: 1px solid var(--border); color: var(--text-muted); font-family: 'DM Sans', sans-serif; font-size: 0.8rem; padding: 8px 16px; border-radius: 8px; cursor: pointer; }
  .btn-copy:hover { border-color: var(--accent); color: var(--accent); }
  .result-content { font-size: 0.95rem; line-height: 1.8; white-space: pre-wrap; }
  .result-content h3 { font-family: 'Bebas Neue', sans-serif; font-size: 1.05rem; letter-spacing: 0.08em; color: var(--accent); margin: 20px 0 6px; }

  .error-box { display: none; background: rgba(248,81,73,0.08); border: 1px solid rgba(248,81,73,0.3); color: var(--danger); padding: 14px 18px; border-radius: 10px; font-size: 0.9rem; margin-bottom: 16px; }
  .error-box.active { display: block; }
  .footer { text-align: center; color: var(--text-muted); font-size: 0.75rem; padding-top: 24px; border-top: 1px solid var(--border); }

  @media (max-width: 600px) { .row { grid-template-columns: 1fr; } .header { flex-direction: column; gap: 12px; } .api-row { flex-direction: column; align-items: flex-start; } }
</style>
</head>
<body>

<div id="loginScreen">
  <div class="login-box">
    <h1>GEB√ÑUDE<span>TROCKNUNG</span> WIEGAND</h1>
    <p>Internes Tool ‚Äì nur f√ºr Mitarbeiter</p>
    <input type="password" id="loginInput" placeholder="Passwort eingeben" onkeydown="if(event.key==='Enter')doLogin()" />
    <button class="login-btn" onclick="doLogin()">EINLOGGEN</button>
    <p class="login-error" id="loginError">‚ùå Falsches Passwort</p>
  </div>
</div>

<div id="app">
  <div class="container">
    <div class="header">
      <div class="logo-area">
        <h1>GEB√ÑUDE<span>TROCKNUNG</span> WIEGAND</h1>
        <p>KI-gest√ºtzte Sanierungsanalyse ¬∑ Intern</p>
      </div>
      <div class="badge">üîí Nur intern</div>
    </div>

    <div class="card">
      <h2>API Einstellung</h2>
      <div class="api-row">
        <label>OpenAI Key</label>
        <input type="password" id="apiKey" placeholder="sk-..." />
      </div>
    </div>

    <div class="error-box" id="errorBox"></div>

    <div class="card">
      <h2>Objekt & Schaden</h2>
      <div class="row">
        <div class="field">
          <label>Objekt / Adresse</label>
          <input type="text" id="objekt" placeholder="z.B. EFH, Musterstr. 5" />
        </div>
        <div class="field">
          <label>Art des Schadens</label>
          <input type="text" id="schadensart" placeholder="z.B. Wasserschaden" />
        </div>
      </div>
    </div>

    <div class="card">
      <h2>üì∑ Foto hochladen</h2>
      <div class="upload-zone">
        <input type="file" id="fileInput" accept="image/*" onchange="handleFile(this)" />
        <div class="upload-icon">üì∑</div>
        <p>Foto hier ablegen oder <span>klicken zum Ausw√§hlen</span></p>
        <div class="preview-img" id="previewImg">
          <img id="previewImgEl" src="" alt="Vorschau" />
          <p id="fileName"></p>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>üé§ Sprachaufnahme</h2>
      <div class="audio-section">
        <button class="record-btn" id="recordBtn" onclick="toggleRecording()">üé§</button>
        <p class="record-status" id="recordStatus">Dr√ºcken um aufzunehmen</p>
        <div class="audio-preview" id="audioPreview">
          <audio id="audioPlayer" controls></audio>
          <p>‚úì Aufnahme bereit</p>
        </div>
        <div class="transcript-box" id="transcriptBox">
          <div class="transcript-label">Transkript</div>
          <div id="transcriptText"></div>
        </div>
      </div>
    </div>

    <button class="btn-analyze" id="analyzeBtn" onclick="analyze()">KI-Analyse starten ‚Üí</button>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p id="loadingText">KI analysiert... <span>Bitte warten</span></p>
    </div>

    <div class="result-card" id="resultCard">
      <div class="result-header">
        <h2>‚úì Analyse abgeschlossen</h2>
        <button class="btn-copy" onclick="copyResult()">Kopieren</button>
      </div>
      <div class="result-content" id="resultContent"></div>
    </div>

    <div class="footer">Geb√§udetrocknung Wiegand ¬∑ Forstgasse 19a ¬∑ 37269 Eschwege ¬∑ Internes Tool</div>
  </div>
</div>

<script>
  const PASSWORD = "wiegand2024";
  function doLogin() {
    if (document.getElementById('loginInput').value === PASSWORD) {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('app').style.display = 'block';
    } else {
      document.getElementById('loginError').style.display = 'block';
    }
  }

  let imageBase64 = null;
  function handleFile(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      imageBase64 = e.target.result.split(',')[1];
      document.getElementById('previewImgEl').src = e.target.result;
      document.getElementById('fileName').textContent = '‚úì ' + file.name;
      document.getElementById('previewImg').style.display = 'block';
    };
    reader.readAsDataURL(file);
  }

  let mediaRecorder = null, audioChunks = [], audioBlob = null, isRecording = false;
  async function toggleRecording() {
    if (!isRecording) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
          audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          document.getElementById('audioPlayer').src = URL.createObjectURL(audioBlob);
          document.getElementById('audioPreview').style.display = 'block';
          stream.getTracks().forEach(t => t.stop());
        };
        mediaRecorder.start();
        isRecording = true;
        document.getElementById('recordBtn').textContent = '‚èπ';
        document.getElementById('recordBtn').classList.add('recording');
        document.getElementById('recordStatus').textContent = '‚óè Aufnahme l√§uft...';
        document.getElementById('recordStatus').classList.add('active');
      } catch (err) { showError('Mikrofon-Zugriff verweigert.'); }
    } else {
      mediaRecorder.stop();
      isRecording = false;
      document.getElementById('recordBtn').textContent = 'üé§';
      document.getElementById('recordBtn').classList.remove('recording');
      document.getElementById('recordStatus').textContent = '‚úì Aufnahme gespeichert';
      document.getElementById('recordStatus').classList.remove('active');
    }
  }

  async function analyze() {
    const apiKey = document.getElementById('apiKey').value.trim();
    const objekt = document.getElementById('objekt').value.trim();
    const schadensart = document.getElementById('schadensart').value.trim();
    document.getElementById('errorBox').className = 'error-box';
    if (!apiKey) { showError('Bitte OpenAI API Key eingeben.'); return; }
    if (!imageBase64 && !audioBlob) { showError('Bitte Foto hochladen oder Sprachaufnahme machen.'); return; }

    const btn = document.getElementById('analyzeBtn');
    btn.disabled = true;
    document.getElementById('loading').className = 'loading active';
    document.getElementById('resultCard').className = 'result-card';

    let transcript = '';
    if (audioBlob) {
      document.getElementById('loadingText').innerHTML = 'Sprache wird transkribiert... <span>Bitte warten</span>';
      try {
        const formData = new FormData();
        formData.append('file', audioBlob, 'aufnahme.webm');
        formData.append('model', 'whisper-1');
        formData.append('language', 'de');
        const res = await fetch('https://api.openai.com/v1/audio/transcriptions', {
          method: 'POST', headers: { 'Authorization': `Bearer ${apiKey}` }, body: formData
        });
        const data = await res.json();
        if (data.text) {
          transcript = data.text;
          document.getElementById('transcriptText').textContent = transcript;
          document.getElementById('transcriptBox').className = 'transcript-box active';
        }
      } catch (err) { showError('Fehler bei Transkription: ' + err.message); btn.disabled = false; return; }
    }

    document.getElementById('loadingText').innerHTML = 'KI analysiert den Schaden... <span>Bitte warten</span>';
    const prompt = `Du bist ein erfahrener Bausachverst√§ndiger f√ºr die Firma Geb√§udetrocknung Wiegand in Eschwege. Erstelle eine vollst√§ndige Sanierungsanalyse auf Deutsch.

Objekt: ${objekt || 'Nicht angegeben'}
Schadensart: ${schadensart || 'Nicht angegeben'}
${transcript ? `Sprachbeschreibung: "${transcript}"` : ''}
${imageBase64 ? 'Analysiere das beigef√ºgte Foto.' : ''}

### 1. SCHADENSBEURTEILUNG
Zustand, Schweregrad und Dringlichkeit.

### 2. EMPFOHLENE MA√üNAHMEN
Alle n√∂tigen Ma√ünahmen ‚Äì priorisiert.

### 3. SANIERUNGSKONZEPT
Schritt-f√ºr-Schritt Vorgehen.

### 4. KOSTENSCH√ÑTZUNG
- Trocknung & Technik: X‚Ç¨
- R√ºckbau: X‚Ç¨
- Material: X‚Ç¨
- Handwerkerleistungen: X‚Ç¨
- Nebenkosten: X‚Ç¨

### 5. GESAMTKOSTEN
Sch√§tzung gesamt: X‚Ç¨ ‚Äì X‚Ç¨

### 6. F√ñRDERM√ñGLICHKEITEN
KfW, BAFA, Versicherung

### 7. BEN√ñTIGTE GEWERKE
Welche Fachbetriebe werden zus√§tzlich ben√∂tigt?`;

    try {
      let content = [];
      if (imageBase64) content.push({ type: 'image_url', image_url: { url: `data:image/jpeg;base64,${imageBase64}` } });
      content.push({ type: 'text', text: prompt });
      const res = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
        body: JSON.stringify({ model: 'gpt-4o', max_tokens: 2000, messages: [{ role: 'user', content }] })
      });
      const data = await res.json();
      if (!res.ok) { showError('API Fehler: ' + (data.error?.message || res.status)); return; }
      const text = data.choices[0].message.content;
      document.getElementById('resultContent').innerHTML = text.replace(/### (.+)/g, '<h3>$1</h3>').replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      document.getElementById('resultCard').className = 'result-card active';
      document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth' });
    } catch (err) { showError('Verbindungsfehler: ' + err.message); }
    finally { btn.disabled = false; document.getElementById('loading').className = 'loading'; }
  }

  function showError(msg) {
    const el = document.getElementById('errorBox');
    el.textContent = msg; el.className = 'error-box active';
    document.getElementById('loading').className = 'loading';
    document.getElementById('analyzeBtn').disabled = false;
  }

  function copyResult() {
    navigator.clipboard.writeText(document.getElementById('resultContent').innerText).then(() => {
      const btn = document.querySelector('.btn-copy');
      btn.textContent = '‚úì Kopiert!';
      setTimeout(() => btn.textContent = 'Kopieren', 2000);
    });
  }
</script>
</body>
</html>
