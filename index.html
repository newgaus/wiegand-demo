<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Geb√§udetrocknung Wiegand ‚Äì KI Demo</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --blue:#1a56db; --blue-dark:#1e429f; --blue-light:#ebf5ff;
  --gray-50:#f9fafb; --gray-100:#f3f4f6; --gray-200:#e5e7eb;
  --gray-400:#9ca3af; --gray-500:#6b7280; --gray-600:#4b5563;
  --gray-700:#374151; --gray-800:#1f2937;
  --green:#059669; --green-light:#d1fae5;
  --red:#dc2626; --red-light:#fee2e2;
  --r:12px; --rs:8px;
  --shadow:0 1px 3px rgba(0,0,0,.1);
  --shadow-md:0 4px 12px rgba(0,0,0,.08);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Inter',sans-serif;background:var(--gray-50);color:var(--gray-800);font-size:14px;line-height:1.5;}

.header{background:white;border-bottom:1px solid var(--gray-200);padding:16px 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:var(--shadow);}
.header-logo{display:flex;align-items:center;gap:12px;}
.header-logo .icon{width:38px;height:38px;background:var(--blue);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;}
.header-logo h1{font-size:16px;font-weight:700;color:var(--gray-800);line-height:1.2;}
.header-logo p{font-size:11px;color:var(--gray-500);}
.header-right{display:flex;align-items:center;gap:10px;}
.api-input{border:1.5px solid var(--gray-200);border-radius:var(--rs);padding:8px 12px;font-family:monospace;font-size:12px;outline:none;width:280px;transition:border-color .2s;}
.api-input:focus{border-color:var(--blue);}
.api-label{font-size:11px;font-weight:600;color:var(--blue-dark);white-space:nowrap;}

.main{max-width:1100px;margin:0 auto;padding:28px 24px;}
.sec-title{font-size:13px;font-weight:700;color:var(--gray-700);text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px;display:flex;align-items:center;gap:7px;}
.card{background:white;border:1px solid var(--gray-200);border-radius:var(--r);padding:22px;margin-bottom:20px;box-shadow:var(--shadow);}

.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;}
.field label{display:block;font-size:11px;font-weight:600;color:var(--gray-600);margin-bottom:4px;text-transform:uppercase;letter-spacing:.04em;}
.field input,.field select,.field textarea{width:100%;border:1.5px solid var(--gray-200);border-radius:var(--rs);padding:9px 12px;font-family:'Inter',sans-serif;font-size:13px;color:var(--gray-800);outline:none;transition:border-color .2s;background:white;}

.upload-area{border:2px dashed var(--gray-300);border-radius:var(--r);padding:20px;text-align:center;cursor:pointer;position:relative;background:white;}
.upload-area input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.photos-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-top:14px;}
.photo-thumb{position:relative;border-radius:var(--rs);overflow:hidden;aspect-ratio:1;border:2px solid var(--gray-200);}
.photo-thumb img{width:100%;height:100%;object-fit:cover;}
.photo-thumb .del{position:absolute;top:4px;right:4px;background:rgba(220,38,38,.9);color:white;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer;}
.main-badge{position:absolute;bottom:4px;left:4px;background:var(--blue);color:white;font-size:9px;padding:2px 5px;border-radius:4px;}

.btn{display:inline-flex;align-items:center;gap:6px;border:none;border-radius:var(--rs);padding:10px 18px;font-weight:600;cursor:pointer;transition:all .2s;}
.btn-p{background:var(--blue);color:white;}
.btn-p:disabled{opacity:.5;}
.btn-full{width:100%;justify-content:center;}

.loading{display:none;text-align:center;padding:36px;}
.spinner{width:36px;height:36px;border:3px solid var(--gray-200);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 12px;}
@keyframes spin{to{transform:rotate(360deg)}}

.result-box{display:none;}
.result-content{font-size:13px;line-height:1.7;color:var(--gray-700);}
.viz-wrap{background:#f3f4f6;border-radius:var(--r);padding:20px;margin-top:16px;}
.viz-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;margin-top:12px;}
.viz-item img{width:100%;border-radius:8px;box-shadow:var(--shadow-md);background:white;}
.viz-item p{font-size:11px;color:var(--gray-500);margin-top:8px;text-align:center;font-weight:600;}

.err-bar{display:none;background:var(--red-light);color:var(--red);padding:12px;border-radius:var(--rs);margin-bottom:14px;font-size:12px;font-weight:600;}
</style>
</head>
<body>

<div class="header">
  <div class="header-logo">
    <div class="icon" style="color:white">W</div>
    <div>
      <h1>Geb√§udetrocknung Wiegand</h1>
      <p>Profi-Visualisierung f√ºr Wassersch√§den</p>
    </div>
  </div>
  <div class="header-right">
    <span class="api-label">üîë OpenAI API Key</span>
    <input class="api-input" type="password" id="openaiKey" placeholder="sk-...">
  </div>
</div>

<div class="main">
  <div id="errBar" class="err-bar"></div>

  <div class="card">
    <div class="sec-title">1. Kundendaten</div>
    <div class="g2">
      <div class="field"><label>Auftraggeber</label><input type="text" id="auftraggeber" placeholder="z.B. Hr. Schmidt"></div>
      <div class="field"><label>Objektadresse</label><input type="text" id="objekt" placeholder="Musterweg 12, 37269"></div>
    </div>
  </div>

  <div class="card">
    <div class="sec-title">2. Schadensfotos</div>
    <div class="upload-area">
      <input type="file" id="fileInput" accept="image/*" multiple onchange="handleFiles(this)">
      <p>Klicken oder Fotos hierher ziehen</p>
    </div>
    <div class="photos-grid" id="photosGrid"></div>
  </div>

  <button class="btn btn-p btn-full" id="analyzeBtn" onclick="runAnalyse()">Analyse & 3D Vorschau starten</button>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p>KI erstellt realistische Raum-Visualisierung...</p>
  </div>

  <div class="card result-box" id="resultCard">
    <div class="sec-title">KI-Bericht</div>
    <div id="resultContent" class="result-content"></div>
    
    <div class="viz-wrap">
      <div class="sec-title">3D Sanierungsvorschlag (Realistisches Rendering)</div>
      <div class="viz-grid" id="vizGrid"></div>
    </div>
  </div>
</div>

<script>
let photos = [];

function handleFiles(input) {
  const files = Array.from(input.files);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      photos.push({ base64: e.target.result.split(',')[1], full: e.target.result });
      renderPhotos();
    };
    reader.readAsDataURL(file);
  });
}

function renderPhotos() {
  const grid = document.getElementById('photosGrid');
  grid.innerHTML = photos.map((p,i) => `
    <div class="photo-thumb">
      <img src="${p.full}">
      <button class="del" onclick="photos.splice(${i},1);renderPhotos()">√ó</button>
      ${i===0?'<span class="main-badge">Referenz</span>':''}
    </div>
  `).join('');
}

async function runAnalyse() {
  const key = document.getElementById('openaiKey').value.trim();
  if (!key) { showError('API Key fehlt!'); return; }
  if (photos.length === 0) { showError('Bitte laden Sie mindestens ein Foto hoch!'); return; }

  document.getElementById('loading').style.display = 'block';
  document.getElementById('analyzeBtn').disabled = true;

  try {
    // Schritt 1: Raum bestimmen
    const roomResponse = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [{ role: 'user', content: [
          { type: 'text', text: 'Nenne nur das Zimmer auf diesem Foto (ein Wort, z.B. Badezimmer, K√ºche).' },
          { type: 'image_url', image_url: { url: `data:image/jpeg;base64,${photos[0].base64}` } }
        ]}]
      })
    });
    const roomData = await roomResponse.json();
    const raum = roomData.choices[0].message.content.trim();

    // Schritt 2: Realistische Bildgenerierung
    // Wir nutzen hier einen extrem spezifischen "Realismus-Prompt", um den KI-Look zu vermeiden
    const prompt = `A highly realistic architectural 3D rendering of a professionaly renovated ${raum}. 
    STYLE: Clean, modern interior design, photorealistic, 8k resolution, cinematic natural lighting from a window, soft shadows. 
    MATERIALS: High-quality matte floor tiles, smooth plastered walls in light neutral colors (eggshell or light grey), real wood accents, chrome fixtures. 
    CAMERA: Wide angle eye-level shot, professional architectural photography style (like ArchDaily or Dezeen). 
    NO FUTURISTIC ELEMENTS: No glowing neon, no sci-fi shapes, no digital artifacts, no saturated purple/blue lights. 
    Atmosphere: Bright, airy, and inviting. Exactly like a real estate marketing brochure.`;

    const imageResponse = await fetch('https://api.openai.com/v1/images/generations', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
      body: JSON.stringify({
        model: 'dall-e-3',
        prompt: prompt,
        n: 1,
        size: '1024x1024',
        quality: 'hd',
        style: 'natural' // WICHTIG: Stellt DALL-E auf den weniger "k√ºnstlerischen" Modus
      })
    });
    
    const imageData = await imageResponse.json();
    if (!imageResponse.ok) throw new Error(imageData.error.message);

    const imgSrc = imageData.data[0].url;
    
    document.getElementById('vizGrid').innerHTML = `
      <div class="viz-item"><img src="${photos[0].full}"><p>IST-ZUSTAND (SCHADEN)</p></div>
      <div class="viz-item"><img src="${imgSrc}"><p>PLANUNG (SANIERTER ZUSTAND)</p></div>
    `;

    document.getElementById('resultCard').style.display = 'block';
    document.getElementById('resultContent').innerHTML = `Der Raum wurde als <strong>${raum}</strong> identifiziert. Basierend auf den Fotos wurde ein Sanierungskonzept erstellt.`;
    document.getElementById('resultCard').scrollIntoView({behavior: 'smooth'});

  } catch (e) {
    showError(e.message);
  } finally {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('analyzeBtn').disabled = false;
  }
}

function showError(m) {
  const el = document.getElementById('errBar');
  el.textContent = '‚ùå ' + m;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 5000);
}
</script>
</body>
</html>
