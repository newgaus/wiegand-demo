<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GebÃ¤udetrocknung Wiegand â€“ KI Demo</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --blue:#1a56db; --blue-dark:#1e429f; --blue-light:#ebf5ff;
  --gray-50:#f9fafb; --gray-100:#f3f4f6; --gray-200:#e5e7eb;
  --gray-400:#9ca3af; --gray-500:#6b7280; --gray-600:#4b5563;
  --gray-700:#374151; --gray-800:#1f2937;
  --green:#059669; --green-light:#d1fae5;
  --red:#dc2626; --red-light:#fee2e2;
  --r:12px; --rs:8px;
  --shadow:0 1px 3px rgba(0,0,0,.1);
  --shadow-md:0 4px 12px rgba(0,0,0,.08);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Inter',sans-serif;background:var(--gray-50);color:var(--gray-800);font-size:14px;line-height:1.5;}
.header{background:white;border-bottom:1px solid var(--gray-200);padding:16px 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:var(--shadow);}
.header-logo{display:flex;align-items:center;gap:12px;}
.header-logo .icon{width:38px;height:38px;background:var(--blue);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;}
.header-logo h1{font-size:16px;font-weight:700;color:var(--gray-800);line-height:1.2;}
.header-logo p{font-size:11px;color:var(--gray-500);}
.header-right{display:flex;align-items:center;gap:10px;}
.api-input{border:1.5px solid var(--gray-200);border-radius:var(--rs);padding:8px 12px;font-family:monospace;font-size:12px;outline:none;width:280px;transition:border-color .2s;}
.api-input:focus{border-color:var(--blue);}
.api-label{font-size:11px;font-weight:600;color:var(--blue-dark);white-space:nowrap;}
.main{max-width:1100px;margin:0 auto;padding:28px 24px;}
.sec-title{font-size:13px;font-weight:700;color:var(--gray-700);text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px;display:flex;align-items:center;gap:7px;}
.card{background:white;border:1px solid var(--gray-200);border-radius:var(--r);padding:22px;margin-bottom:20px;box-shadow:var(--shadow);}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;}
.field{margin-bottom:0;}
.field label{display:block;font-size:11px;font-weight:600;color:var(--gray-600);margin-bottom:4px;text-transform:uppercase;letter-spacing:.04em;}
.field input,.field select,.field textarea{width:100%;border:1.5px solid var(--gray-200);border-radius:var(--rs);padding:9px 12px;font-family:'Inter',sans-serif;font-size:13px;color:var(--gray-800);outline:none;transition:border-color .2s;background:white;}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(26,86,219,.07);}
.field textarea{min-height:70px;resize:vertical;line-height:1.6;}
.upload-area{border:2px dashed var(--gray-300);border-radius:var(--r);padding:20px;text-align:center;cursor:pointer;transition:all .2s;position:relative;background:white;}
.upload-area:hover{border-color:var(--blue);background:var(--blue-light);}
.upload-area input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.upload-icon{font-size:1.8rem;margin-bottom:6px;}
.upload-area p{color:var(--gray-500);font-size:12px;}
.upload-area p span{color:var(--blue);font-weight:600;}
.photos-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-top:14px;}
.photo-thumb{position:relative;border-radius:var(--rs);overflow:hidden;aspect-ratio:1;border:2px solid var(--gray-200);}
.photo-thumb img{width:100%;height:100%;object-fit:cover;}
.photo-thumb .del{position:absolute;top:4px;right:4px;background:rgba(220,38,38,.9);color:white;border:none;border-radius:50%;width:22px;height:22px;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:700;}
.photo-thumb .main-badge{position:absolute;bottom:4px;left:4px;background:var(--blue);color:white;font-size:9px;font-weight:600;padding:2px 5px;border-radius:4px;text-transform:uppercase;}
.photos-count{font-size:11px;color:var(--green);font-weight:500;margin-top:6px;}
.audio-card{display:flex;align-items:flex-start;gap:20px;}
.rec-area{text-align:center;flex-shrink:0;}
.rec-btn{width:68px;height:68px;border-radius:50%;border:2.5px solid var(--blue);background:var(--blue-light);color:var(--blue);font-size:1.7rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;margin:0 auto 8px;}
.rec-btn:hover{background:var(--blue);color:white;}
.rec-btn.rec{border-color:var(--red);background:var(--red-light);color:var(--red);animation:pulse 1s infinite;}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
.rec-status{font-size:11px;font-weight:600;color:var(--gray-400);}
.rec-status.active{color:var(--red);}
.rec-timer{font-size:18px;font-weight:700;color:var(--gray-700);margin-top:4px;font-family:monospace;}
.audio-info{flex:1;}
.audio-info h3{font-size:13px;font-weight:600;color:var(--gray-700);margin-bottom:4px;}
.audio-info p{font-size:12px;color:var(--gray-500);line-height:1.7;}
.audio-prev-wrap{margin-top:10px;display:none;}
.audio-prev-wrap audio{width:100%;border-radius:var(--rs);}
.transcript-box{display:none;background:var(--blue-light);border:1px solid #bfdbfe;border-radius:var(--rs);padding:10px 12px;margin-top:10px;font-size:12px;line-height:1.7;color:var(--gray-700);}
.transcript-box.on{display:block;}
.transcript-lbl{font-size:10px;font-weight:700;color:var(--blue-dark);margin-bottom:3px;text-transform:uppercase;letter-spacing:.05em;}
.modes{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px;}
.mchip{border:1.5px solid var(--gray-200);border-radius:var(--rs);padding:10px 6px;text-align:center;cursor:pointer;transition:all .2s;background:white;font-size:10px;font-weight:600;color:var(--gray-500);}
.mchip:hover{border-color:var(--blue);color:var(--blue);}
.mchip.on{border-color:var(--blue);background:var(--blue-light);color:var(--blue);}
.mchip .mi{font-size:1.2rem;display:block;margin-bottom:2px;}
.btn{display:inline-flex;align-items:center;gap:6px;border:none;border-radius:var(--rs);padding:10px 18px;font-family:'Inter',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;}
.btn-p{background:var(--blue);color:white;}
.btn-p:hover{background:var(--blue-dark);}
.btn-p:disabled{opacity:.5;cursor:not-allowed;}
.btn-s{background:white;color:var(--gray-700);border:1.5px solid var(--gray-200);}
.btn-s:hover{background:var(--gray-50);}
.btn-g{background:var(--green);color:white;}
.btn-g:hover{opacity:.9;}
.btn-full{width:100%;justify-content:center;padding:13px;font-size:14px;}
.loading{display:none;text-align:center;padding:36px;}
.loading.on{display:block;}
.spinner{width:36px;height:36px;border:3px solid var(--gray-200);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 12px;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading p{color:var(--gray-500);font-size:13px;}
.loading span{color:var(--blue);font-weight:600;}
.loading-steps{margin-top:12px;}
.step{font-size:12px;color:var(--gray-400);padding:3px 0;}
.step.active{color:var(--blue);font-weight:600;}
.step.done{color:var(--green);}
.result-box{display:none;}
.result-box.on{display:block;}
.result-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;padding-bottom:14px;border-bottom:1px solid var(--gray-100);}
.result-title{font-size:15px;font-weight:700;color:var(--green);display:flex;align-items:center;gap:6px;}
.result-actions{display:flex;gap:8px;}
.result-content{font-size:13px;line-height:1.9;color:var(--gray-700);}
.result-content h3{font-size:11px;font-weight:700;color:var(--blue-dark);text-transform:uppercase;letter-spacing:.06em;margin:20px 0 7px;padding-bottom:4px;border-bottom:1px solid var(--gray-100);}
.result-content h3:first-child{margin-top:0;}
.result-content strong{color:var(--gray-800);font-weight:600;}
.viz-wrap{background:linear-gradient(135deg,#eff6ff,#dbeafe);border:1px solid #bfdbfe;border-radius:var(--r);padding:20px;margin-top:16px;}
.viz-hdr{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:14px;}
.viz-hdr-text h3{font-size:14px;font-weight:700;color:var(--blue-dark);margin-bottom:3px;}
.viz-hdr-text p{font-size:11px;color:var(--gray-500);}
.viz-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;margin-top:12px;}
.viz-item{text-align:center;}
.viz-item img{width:100%;border-radius:10px;border:1px solid var(--gray-200);box-shadow:var(--shadow-md);}
.viz-item p{font-size:10px;color:var(--gray-400);margin-top:5px;text-transform:uppercase;letter-spacing:.05em;}
.viz-steps{margin-top:10px;}
.viz-step{font-size:12px;padding:4px 0;color:var(--gray-400);}
.viz-step.active{color:var(--blue);font-weight:600;}
.viz-step.done{color:var(--green);}
.invoice-wrap{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:1px solid #86efac;border-radius:var(--r);padding:20px;margin-top:16px;}
.invoice-wrap h3{font-size:14px;font-weight:700;color:#166534;margin-bottom:4px;}
.invoice-wrap>p{font-size:12px;color:var(--gray-600);margin-bottom:14px;}
.invoice-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:14px;}
.invoice-field label{display:block;font-size:10px;font-weight:700;color:#166534;margin-bottom:3px;text-transform:uppercase;letter-spacing:.04em;}
.invoice-field input{width:100%;border:1.5px solid #86efac;border-radius:var(--rs);padding:8px 11px;font-family:'Inter',sans-serif;font-size:13px;outline:none;background:white;transition:border-color .2s;}
.invoice-field input:focus{border-color:var(--green);}
.invoice-preview{background:white;border:1px solid var(--gray-200);border-radius:var(--rs);padding:16px;margin-bottom:12px;display:none;font-size:12px;line-height:1.8;}
.invoice-preview.on{display:block;}
.invoice-preview h4{font-size:14px;font-weight:700;margin-bottom:8px;color:var(--gray-800);}
.err-bar{display:none;background:var(--red-light);border:1px solid #fca5a5;color:var(--red);padding:9px 14px;border-radius:var(--rs);font-size:12px;margin-bottom:14px;}
.err-bar.on{display:block;}
.progress-bar{height:3px;background:var(--gray-100);border-radius:2px;margin-top:8px;overflow:hidden;}
.progress-fill{height:100%;background:var(--blue);border-radius:2px;transition:width .3s;width:0%;}
/* LOGIN SCREEN */
#loginScreen{position:fixed;inset:0;background:linear-gradient(135deg,#1a56db 0%,#1e429f 60%,#1e3a8a 100%);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;}
.login-logo{text-align:center;margin-bottom:36px;}
.login-logo .icon{width:72px;height:72px;background:white;border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:36px;margin:0 auto 14px;box-shadow:0 8px 32px rgba(0,0,0,.2);}
.login-logo h1{font-size:22px;font-weight:700;color:white;line-height:1.2;}
.login-logo p{font-size:13px;color:rgba(255,255,255,.75);margin-top:4px;}
.login-title{font-size:14px;font-weight:700;color:rgba(255,255,255,.9);text-transform:uppercase;letter-spacing:.1em;margin-bottom:18px;}
.employee-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;max-width:700px;width:100%;}
.employee-card{background:rgba(255,255,255,.1);border:1.5px solid rgba(255,255,255,.2);border-radius:14px;padding:18px 12px;text-align:center;cursor:pointer;transition:all .2s;backdrop-filter:blur(10px);}
.employee-card:hover{background:rgba(255,255,255,.25);border-color:rgba(255,255,255,.6);transform:translateY(-3px);box-shadow:0 8px 24px rgba(0,0,0,.2);}
.employee-avatar{font-size:2.2rem;margin-bottom:8px;display:block;}
.employee-name{font-size:13px;font-weight:700;color:white;display:block;margin-bottom:2px;}
.employee-role{font-size:10px;color:rgba(255,255,255,.7);display:block;line-height:1.4;}
.employee-badge{display:inline-flex;align-items:center;gap:6px;background:var(--blue-light);color:var(--blue-dark);border:1.5px solid #bfdbfe;border-radius:20px;padding:5px 12px;font-size:12px;font-weight:600;cursor:pointer;}
.employee-badge:hover{background:#dbeafe;}
/* VIDEO UPLOAD */
.video-upload-area{border:2px dashed #a78bfa;border-radius:var(--r);padding:18px;text-align:center;cursor:pointer;transition:all .2s;position:relative;background:#faf5ff;margin-top:14px;}
.video-upload-area:hover{border-color:#7c3aed;background:#ede9fe;}
.video-upload-area input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.video-upload-area p{color:#6d28d9;font-size:12px;}
.video-upload-area p span{font-weight:600;}
.video-frames-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;margin-top:12px;}
.video-frame-thumb{position:relative;border-radius:var(--rs);overflow:hidden;aspect-ratio:16/9;border:2px solid #a78bfa;}
.video-frame-thumb img{width:100%;height:100%;object-fit:cover;}
.video-frame-thumb .frame-badge{position:absolute;bottom:3px;left:3px;background:#7c3aed;color:white;font-size:8px;font-weight:700;padding:1px 5px;border-radius:3px;}
.video-status{font-size:11px;color:#7c3aed;font-weight:500;margin-top:6px;}
/* INSPIRATIONS-FOTO */
.insp-upload{border:2px dashed var(--gray-300);border-radius:var(--rs);padding:12px 16px;text-align:center;cursor:pointer;transition:all .2s;position:relative;background:var(--gray-50);display:flex;align-items:center;gap:10px;}
.insp-upload:hover{border-color:var(--blue);background:var(--blue-light);}
.insp-upload input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.insp-upload .insp-icon{font-size:1.4rem;flex-shrink:0;}
.insp-upload p{color:var(--gray-500);font-size:12px;text-align:left;line-height:1.5;}
.insp-upload p span{color:var(--blue);font-weight:600;}
.insp-thumb-wrap{display:flex;align-items:center;gap:12px;padding:10px;background:var(--blue-light);border:1px solid #bfdbfe;border-radius:var(--rs);margin-top:10px;}
.insp-thumb-wrap img{width:72px;height:72px;object-fit:cover;border-radius:6px;border:2px solid var(--blue);}
.insp-thumb-wrap .insp-info{flex:1;}
.insp-thumb-wrap .insp-info strong{font-size:12px;color:var(--blue-dark);display:block;margin-bottom:2px;}
.insp-thumb-wrap .insp-info span{font-size:11px;color:var(--gray-500);}
.insp-thumb-wrap .insp-del{background:none;border:none;color:var(--red);font-size:1.2rem;cursor:pointer;padding:4px;border-radius:4px;flex-shrink:0;}
.insp-thumb-wrap .insp-del:hover{background:var(--red-light);}
/* RENOVIERUNGSWÃœNSCHE */
.reno-wishes-wrap{background:white;border:1.5px solid #bfdbfe;border-radius:var(--rs);padding:12px 14px;margin-bottom:14px;}
.reno-wishes-label{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.reno-wishes-label strong{font-size:11px;font-weight:700;color:var(--blue-dark);text-transform:uppercase;letter-spacing:.05em;}
.reno-wishes-label span{font-size:10px;color:var(--gray-400);}
.reno-input-row{display:flex;gap:8px;align-items:flex-start;}
.reno-input-row textarea{flex:1;min-height:64px;border:1.5px solid var(--gray-200);border-radius:var(--rs);padding:8px 10px;font-size:12px;font-family:'Inter',sans-serif;outline:none;resize:vertical;background:white;color:var(--gray-700);line-height:1.6;}
.reno-input-row textarea:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(26,86,219,.07);}
.reno-input-row textarea::placeholder{color:var(--gray-400);}
.reno-rec-wrap{display:flex;flex-direction:column;align-items:center;gap:3px;flex-shrink:0;}
.reno-rec-btn{width:42px;height:42px;border-radius:50%;border:2px solid var(--blue);background:var(--blue-light);color:var(--blue);font-size:1.1rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;}
.reno-rec-btn:hover{background:var(--blue);color:white;}
.reno-rec-btn.rec{border-color:var(--red);background:var(--red-light);color:var(--red);animation:pulse 1s infinite;}
.reno-rec-status{font-size:9px;font-weight:600;color:var(--gray-400);text-align:center;}
.reno-rec-status.active{color:var(--red);}
.reno-transcript{display:none;font-size:11px;color:var(--blue-dark);margin-top:7px;padding:6px 9px;background:var(--blue-light);border-radius:6px;line-height:1.6;}
.reno-transcript.on{display:block;}
/* WIZARD */
.wizard-progress{display:flex;align-items:center;gap:10px;margin-bottom:14px;font-size:12px;font-weight:700;color:var(--blue);}
.wizard-dots{display:flex;gap:5px;}
.wizard-dot{width:9px;height:9px;border-radius:50%;background:var(--gray-200);transition:all .3s;}
.wizard-dot.done{background:var(--green);}
.wizard-dot.active{background:var(--blue);transform:scale(1.25);}
.wizard-question{font-size:13px;color:var(--gray-700);background:var(--blue-light);border:1px solid #bfdbfe;border-left:4px solid var(--blue);border-radius:var(--rs);padding:12px 14px;margin:14px 0 10px;line-height:1.8;}
.wizard-desc{font-size:12px;color:var(--gray-600);background:var(--green-light);border:1px solid #6ee7b7;border-radius:var(--rs);padding:10px 12px;margin:10px 0;line-height:1.6;}
.wizard-feedback-row{display:flex;gap:8px;align-items:flex-start;}
.wizard-feedback-row textarea{flex:1;min-height:60px;border:1.5px solid var(--gray-200);border-radius:var(--rs);padding:8px 11px;font-size:13px;font-family:'Inter',sans-serif;outline:none;resize:vertical;line-height:1.6;color:var(--gray-800);}
.wizard-feedback-row textarea:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(26,86,219,.07);}
.wizard-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;}
.wizard-summary-hdr{font-size:14px;font-weight:700;color:var(--green);margin-bottom:14px;display:flex;align-items:center;gap:6px;}
@media(max-width:768px){
  .g2,.g3,.modes,.invoice-grid{grid-template-columns:1fr;}
  .header{flex-direction:column;gap:10px;align-items:flex-start;}
  .api-input{width:100%;}
  .audio-card{flex-direction:column;}
  .reno-input-row{flex-direction:column;}
  .reno-rec-wrap{flex-direction:row;}
  .wizard-actions{flex-direction:column;}
  .employee-grid{grid-template-columns:repeat(2,1fr);}
}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
  <div class="login-logo">
    <div class="icon">ğŸ </div>
    <h1>GebÃ¤udetrocknung Wiegand</h1>
    <p>Eschwege Â· Meisterbetrieb Â· 30+ Jahre Erfahrung Â· 24h: 01520 88 112 88</p>
  </div>
  <div class="login-title">ğŸ‘‹ Wer bist du?</div>
  <div class="employee-grid">
    <div class="employee-card" onclick="selectEmployee('Werner Wiegand','GeschÃ¤ftsfÃ¼hrer')">
      <span class="employee-avatar">ğŸ‘”</span>
      <span class="employee-name">Werner Wiegand</span>
      <span class="employee-role">GeschÃ¤ftsfÃ¼hrer</span>
    </div>
    <div class="employee-card" onclick="selectEmployee('Rayk Wiegand','GeschÃ¤ftsfÃ¼hrer')">
      <span class="employee-avatar">ğŸ‘”</span>
      <span class="employee-name">Rayk Wiegand</span>
      <span class="employee-role">GeschÃ¤ftsfÃ¼hrer</span>
    </div>
    <div class="employee-card" onclick="selectEmployee('E. Rost','Projektleiter Sanierung')">
      <span class="employee-avatar">ğŸ”§</span>
      <span class="employee-name">E. Rost</span>
      <span class="employee-role">Projektleiter Sanierung</span>
    </div>
    <div class="employee-card" onclick="selectEmployee('Marius Weihseller','Trocknungstechniker')">
      <span class="employee-avatar">ğŸ’§</span>
      <span class="employee-name">Marius Weihseller</span>
      <span class="employee-role">Trocknungstechniker</span>
    </div>
    <div class="employee-card" onclick="selectEmployee('Ralf Kern','Schreiner & Elektriker')">
      <span class="employee-avatar">ğŸªš</span>
      <span class="employee-name">Ralf Kern</span>
      <span class="employee-role">Schreiner & Elektriker</span>
    </div>
    <div class="employee-card" onclick="selectEmployee('Marcel Hartmann','Fliesen- & Mosaiklegger')">
      <span class="employee-avatar">ğŸ”²</span>
      <span class="employee-name">Marcel Hartmann</span>
      <span class="employee-role">Fliesen- & Mosaiklegger</span>
    </div>
    <div class="employee-card" onclick="selectEmployee('Rico Baumann','Trocknungstechniker')">
      <span class="employee-avatar">ğŸ’§</span>
      <span class="employee-name">Rico Baumann</span>
      <span class="employee-role">Trocknungstechniker</span>
    </div>
    <div class="employee-card" onclick="selectEmployee('Viktor Wist','Maler')">
      <span class="employee-avatar">ğŸ¨</span>
      <span class="employee-name">Viktor Wist</span>
      <span class="employee-role">Maler</span>
    </div>
    <div class="employee-card" onclick="selectEmployee('Doro Zaruba','Backoffice')">
      <span class="employee-avatar">ğŸ“‹</span>
      <span class="employee-name">Doro Zaruba</span>
      <span class="employee-role">Backoffice</span>
    </div>
  </div>
</div>

<!-- HAUPT-APP -->
<div id="appScreen" style="display:none">
<div class="header">
  <div class="header-logo">
    <div class="icon">ğŸ </div>
    <div>
      <h1>GebÃ¤udetrocknung Wiegand</h1>
      <p>KI-Demo Â· Eschwege Â· 01520 88 112 88</p>
    </div>
  </div>
  <div class="header-right">
    <div id="employeeBadge" class="employee-badge" onclick="document.getElementById('loginScreen').style.display='flex';document.getElementById('appScreen').style.display='none'">
      <span id="employeeBadgeText">ğŸ‘¤ Mitarbeiter</span>
      <span style="font-size:10px;opacity:.7">wechseln</span>
    </div>
    <span class="api-label">ğŸ”‘ OpenAI Key</span>
    <input class="api-input" type="password" id="openaiKey" placeholder="sk-..." />
  </div>
</div>
<div class="main">
  <div class="err-bar" id="errBar"></div>
  <div class="card">
    <div class="sec-title">ğŸ“ Objektdaten</div>
    <div class="g3" style="margin-bottom:12px">
      <div class="field"><label>Objekt / Adresse</label><input type="text" id="objekt" placeholder="z.B. EFH, Musterstr. 5, Eschwege" /></div>
      <div class="field"><label>Auftraggeber</label><input type="text" id="auftraggeber" placeholder="z.B. Familie MÃ¼ller" /></div>
      <div class="field">
        <label>Art des Schadens</label>
        <select id="schadensart">
          <option value="">Bitte wÃ¤hlen...</option>
          <option>Wasserschaden (Rohrbruch)</option>
          <option>Wasserschaden (Ãœberschwemmung)</option>
          <option>Leckage (unbekannte Ursache)</option>
          <option>Schimmelbefall</option>
          <option>Feuchtigkeit in WÃ¤nden/BÃ¶den</option>
          <option>Badezimmer-Sanierung</option>
          <option>Keller-Sanierung</option>
          <option>Sonstiges</option>
        </select>
      </div>
    </div>
    <div class="g3">
      <div class="field"><label>FlÃ¤che (mÂ²)</label><input type="number" id="flaeche" placeholder="z.B. 12" /></div>
      <div class="field">
        <label>Versicherungsfall</label>
        <select id="versicherung"><option>Nein</option><option>Ja â€“ WohngebÃ¤ude</option><option>Ja â€“ Hausrat</option><option>Ja â€“ Haftpflicht</option><option>Unklar</option></select>
      </div>
      <div class="field"><label>KostenschÃ¤tzung Ziel (â‚¬)</label><input type="number" id="budget" placeholder="z.B. 5000" /></div>
    </div>
  </div>
  <div class="card">
    <div class="sec-title">ğŸ“¸ Fotos des Schadens <span style="font-size:11px;font-weight:400;color:var(--gray-400);text-transform:none;letter-spacing:0">(mehrere mÃ¶glich â€“ erstes Foto = Hauptbild fÃ¼r 3D)</span></div>
    <div class="upload-area" id="uploadArea">
      <input type="file" id="fileInput" accept="image/*" multiple onchange="handleFiles(this)" />
      <div class="upload-icon">ğŸ“</div>
      <p>Fotos hier ablegen oder <span>auswÃ¤hlen</span></p>
      <p style="font-size:10px;margin-top:3px;color:var(--gray-400)">Mehrere Fotos gleichzeitig mÃ¶glich Â· JPG, PNG, WEBP</p>
    </div>
    <div class="photos-grid" id="photosGrid"></div>
    <div class="photos-count" id="photosCount"></div>

    <!-- VIDEO UPLOAD -->
    <div style="margin-top:16px;border-top:1px solid var(--gray-100);padding-top:14px;">
      <div style="font-size:11px;font-weight:700;color:#6d28d9;text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px;">ğŸ“¹ Video hochladen <span style="font-size:10px;font-weight:400;color:var(--gray-400);text-transform:none;letter-spacing:0">(optional â€“ KI extrahiert automatisch 6 Frames)</span></div>
      <div class="video-upload-area">
        <input type="file" id="videoInput" accept="video/*" onchange="handleVideo(this)" />
        <div style="font-size:1.8rem;margin-bottom:6px;">ğŸ“¹</div>
        <p>Video hier ablegen oder <span>auswÃ¤hlen</span></p>
        <p style="font-size:10px;margin-top:3px;color:#9ca3af">MP4, MOV, AVI Â· KI extrahiert 6 gleichmÃ¤ÃŸig verteilte Frames automatisch</p>
      </div>
      <div class="video-frames-grid" id="videoFramesGrid"></div>
      <div class="video-status" id="videoStatus"></div>
    </div>

    <!-- INSPIRATIONS-FOTO -->
    <div style="margin-top:16px;border-top:1px solid var(--gray-100);padding-top:14px;">
      <div style="font-size:11px;font-weight:700;color:var(--gray-600);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px;">ğŸ–¼ï¸ Inspirations-Foto <span style="font-size:10px;font-weight:400;color:var(--gray-400);text-transform:none;letter-spacing:0">(optional â€“ zeigt der KI welchen Stil du dir wÃ¼nschst)</span></div>
      <div class="insp-upload" id="inspUploadArea">
        <input type="file" id="inspirationInput" accept="image/*" onchange="handleInspirationFile(this)" />
        <div class="insp-icon">ğŸ–¼ï¸</div>
        <p>z.B. ein modernes dunkles Bad, eine helle KÃ¼che aus Pinterest...<br><span>Inspirationsbild auswÃ¤hlen</span></p>
      </div>
      <div id="inspirationThumb" style="display:none"></div>
    </div>

    <button class="btn btn-p btn-full" id="startWizardBtn" onclick="startVizWizard()" style="display:none;margin-top:14px;">âœ¨ Verbesserungsvorschlag fÃ¼r jedes Foto erstellen</button>
  </div>

  <!-- WIZARD -->
  <div class="card" id="wizardCard" style="display:none;border:2px solid var(--blue);">
    <div class="sec-title">âœ¨ Verbesserungsvorschlag</div>
    <div class="wizard-progress">
      <span id="wizardProgressText">Foto 1 von 1</span>
      <div class="wizard-dots" id="wizardDots"></div>
    </div>
    <div class="loading" id="wizardLoading" style="padding:20px">
      <div class="spinner"></div>
      <p>Erstelle Verbesserungsvorschlag... <span>~45s</span></p>
      <div class="viz-steps">
        <div class="viz-step" id="wstep1">â³ Schritt 1: Raum & Elemente analysieren</div>
        <div class="viz-step" id="wstep2">â³ Schritt 2: Foto fÃ¼r KI vorbereiten</div>
        <div class="viz-step" id="wstep3">â³ Schritt 3: Verbesserungsbild generieren</div>
      </div>
    </div>
    <div id="wizardResult" style="display:none">
      <div class="viz-grid" id="wizardGrid"></div>
      <div class="wizard-desc" id="wizardDesc"></div>
      <div class="wizard-question">ğŸ’¬ GefÃ¤llt dir dieser Vorschlag? Schreibe einfach was du Ã¤ndern mÃ¶chtest und ich erstelle sofort ein neues Bild.</div>
      <div class="wizard-feedback-row">
        <textarea id="wizardFeedback" placeholder="z.B. Hellere Fliesen, Holzboden statt Steinboden, Anthrazit-SchrÃ¤nke..."></textarea>
      </div>
      <div class="wizard-actions">
        <button class="btn btn-s" onclick="regenerateCurrentWiz()">ğŸ”„ Neu generieren</button>
        <button class="btn btn-p" id="wizardNextBtn" style="display:none" onclick="nextWizPhoto()">â†’ Weiter zum nÃ¤chsten Foto</button>
        <button class="btn btn-g" id="wizardDoneBtn" style="display:none" onclick="finishWizard()">âœ… Alle VorschlÃ¤ge fertig</button>
      </div>
    </div>
    <div id="wizardSummary" style="display:none">
      <div class="wizard-summary-hdr">âœ… Alle VerbesserungsvorschlÃ¤ge erstellt</div>
      <div class="viz-grid" id="wizardSummaryGrid"></div>
    </div>
  </div>

  <div class="card">
    <div class="sec-title">ğŸ™ï¸ Sprachbeschreibung <span style="font-size:11px;font-weight:400;color:var(--gray-400);text-transform:none;letter-spacing:0">(unbegrenzte LÃ¤nge)</span></div>
    <div class="audio-card">
      <div class="rec-area">
        <button class="rec-btn" id="recBtn" onclick="toggleRec()">ğŸ™ï¸</button>
        <div class="rec-status" id="recStatus">DrÃ¼cken</div>
        <div class="rec-timer" id="recTimer" style="display:none">0:00</div>
      </div>
      <div class="audio-info">
        <h3>Beschreiben Sie den Schaden mÃ¼ndlich</h3>
        <p>â€¢ Sprechen Sie so lange Sie mÃ¶chten<br>â€¢ WÃ¤nde, Boden, Decke beschreiben<br>â€¢ GerÃ¼che erwÃ¤hnen (Schimmel, Moder)<br>â€¢ Genauen Ort des Schadens angeben<br>â€¢ Ursache wenn bekannt</p>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="audio-prev-wrap" id="audioPrev">
          <audio id="audioPlayer" controls style="margin-top:10px"></audio>
          <p style="color:var(--green);font-size:11px;margin-top:4px;font-weight:500">âœ“ Aufnahme gespeichert</p>
        </div>
        <div class="transcript-box" id="transcriptBox">
          <div class="transcript-lbl">ğŸ—’ï¸ Transkript (Whisper KI)</div>
          <div id="transcriptText"></div>
        </div>
        <div style="margin-top:10px;">
          <label style="display:block;font-size:11px;font-weight:600;color:var(--gray-600);margin-bottom:4px;text-transform:uppercase;letter-spacing:.04em;">âœï¸ Oder schriftlich beschreiben</label>
          <textarea id="manualDesc" placeholder="z.B. Feuchte WÃ¤nde im Keller, Schimmelflecken an der Decke..." style="width:100%;min-height:80px;border:1.5px solid var(--gray-200);border-radius:var(--rs);padding:9px 12px;font-family:'Inter',sans-serif;font-size:13px;color:var(--gray-800);outline:none;transition:border-color .2s;background:white;resize:vertical;line-height:1.6;" onfocus="this.style.borderColor='var(--blue)'" onblur="this.style.borderColor='var(--gray-200)'"></textarea>
        </div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="sec-title">âš™ï¸ Was soll erstellt werden?</div>
    <div class="modes">
      <div class="mchip on" id="m-schaden" onclick="toggleM('schaden')"><span class="mi">ğŸ”</span>Schadensbeurteilung</div>
      <div class="mchip on" id="m-konzept" onclick="toggleM('konzept')"><span class="mi">ğŸ“‹</span>Sanierungskonzept</div>
      <div class="mchip on" id="m-kosten" onclick="toggleM('kosten')"><span class="mi">ğŸ’°</span>KostenschÃ¤tzung</div>
      <div class="mchip on" id="m-foerder" onclick="toggleM('foerder')"><span class="mi">ğŸ›ï¸</span>FÃ¶rderung & Versicherung</div>
    </div>
    <button class="btn btn-p btn-full" id="analyzeBtn" onclick="runAnalyse()">ğŸ” KI-Analyse starten</button>
  </div>
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p id="ldText">Analysiere... <span>Bitte warten</span></p>
    <div class="loading-steps">
      <div class="step" id="step1">â³ Sprache transkribieren</div>
      <div class="step" id="step2">â³ Fotos analysieren</div>
      <div class="step" id="step3">â³ Sanierungskonzept erstellen</div>
      <div class="step" id="step4">â³ KostenschÃ¤tzung berechnen</div>
    </div>
  </div>
  <div class="card result-box" id="resultCard">
    <div class="result-hdr">
      <div class="result-title">âœ… Analyse abgeschlossen</div>
      <div class="result-actions">
        <button class="btn btn-s" onclick="copyResult()">ğŸ“‹ Kopieren</button>
      </div>
    </div>
    <div class="result-content" id="resultContent"></div>
    <div class="viz-wrap" id="vizWrap">
      <div class="viz-hdr">
        <div class="viz-hdr-text">
          <h3>âœ¨ KI-Visualisierung: Sanierter Raum</h3>
          <p>Originalfoto â†’ gpt-image-1 bearbeitet direkt â€“ Kamerawinkel & Layout 1:1</p>
        </div>
        <button class="btn btn-p" id="vizBtn" onclick="generateViz()">âœ¨ 3D erstellen</button>
      </div>
      <div class="reno-wishes-wrap">
        <div class="reno-wishes-label">
          <strong>ğŸ’¬ Ihre WÃ¼nsche</strong>
          <span>optional Â· Fliesen, Farben, MÃ¶belposition, Stil...</span>
        </div>
        <div class="reno-input-row">
          <textarea id="renoWishes" placeholder="z.B. WeiÃŸe groÃŸformatige Fliesen Â· Anthrazit-SchrÃ¤nke Â· Heller Holzboden Â· Regendusche rechts"></textarea>
          <div class="reno-rec-wrap">
            <button class="reno-rec-btn" id="renoRecBtn" onclick="toggleRenoRec()" title="WÃ¼nsche einsprechen">ğŸ™ï¸</button>
            <span class="reno-rec-status" id="renoRecStatus">Sprechen</span>
          </div>
        </div>
        <div class="reno-transcript" id="renoTranscript"></div>
      </div>
      <div class="loading" id="ldViz" style="padding:20px">
        <div class="spinner"></div>
        <p id="ldVizText">Analysiere Raum... <span>~45s</span></p>
        <div class="viz-steps">
          <div class="viz-step" id="vstep1">â³ Schritt 1: Raumtyp & Perspektive analysieren</div>
          <div class="viz-step" id="vstep2">â³ Schritt 2: Optimalen Bildprompt erstellen</div>
          <div class="viz-step" id="vstep3">â³ Schritt 3: Perspektivtreues Nachher-Bild generieren</div>
        </div>
      </div>
      <div id="vizResult" style="display:none">
        <div class="viz-grid" id="vizGrid"></div>
        <div style="display:flex;align-items:center;justify-content:center;gap:14px;margin-top:14px;flex-wrap:wrap">
          <p style="font-size:11px;color:var(--gray-400)">ğŸ¯ Gleiche Perspektive â€“ saniert und modernisiert</p>
          <button class="btn btn-s" id="vizRegenBtn" style="display:none;font-size:12px;padding:7px 14px" onclick="generateViz(true)">ğŸ”„ Neuen Vorschlag</button>
        </div>
      </div>
    </div>
    <div class="invoice-wrap" id="invoiceWrap">
      <h3>ğŸ“„ Rechnung an Kunden senden</h3>
      <p>Automatisch aus Analyse erstellt â€“ E-Mail eingeben und senden</p>
      <div class="invoice-grid">
        <div class="invoice-field"><label>Kunden-E-Mail</label><input type="email" id="inv-email" placeholder="kunde@email.de" /></div>
        <div class="invoice-field"><label>Rechnungsnummer</label><input type="text" id="inv-nr" placeholder="RE-2024-001" /></div>
        <div class="invoice-field"><label>Gesamtbetrag (â‚¬ brutto)</label><input type="number" id="inv-betrag" placeholder="3500" /></div>
      </div>
      <div class="invoice-preview" id="invoicePreview"></div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btn-s" onclick="previewInvoice()">ğŸ–¨ï¸ Vorschau</button>
        <button class="btn btn-g" onclick="sendInvoice()">ğŸ“¨ Rechnung senden</button>
      </div>
      <div id="sendStatus" style="margin-top:10px;font-size:12px;"></div>
    </div>
  </div>
</div>
</div><!-- end appScreen -->

<script>
// ===== MITARBEITER LOGIN =====
let currentEmployee = null;
function selectEmployee(name, role) {
  currentEmployee = { name, role };
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('appScreen').style.display   = 'block';
  document.getElementById('employeeBadgeText').textContent = 'ğŸ‘¤ ' + name;
}

// ===== STATE =====
let photos = [];
let audBlob = null, isRec = false;
let mRec = null, aChunks = [];
let timerInterval = null, recSeconds = 0;
let modes = new Set(['schaden','konzept','kosten','foerder']);
let lastAnalysis = '';
let transcript = '';
let vizHistory = [], cachedEditPrompt = '', cachedRoomType = 'Raum';
let renoAudBlob = null, renoIsRec = false, renoMRec = null, renoAChunks = [];
let wizIndex = 0, wizCachedPrompts = [], wizCachedTypes = [], wizCachedAnalysis = [], wizResults = [];
let cachedRoomAnalysis = null;
let inspirationPhoto = null, inspirationStyle = null;

const MAIN_STEPS = ['Sprache transkribieren','Fotos analysieren','Sanierungskonzept erstellen','KostenschÃ¤tzung berechnen'];
const VIZ_STEPS  = ['Raumtyp, Kamerawinkel & MaÃŸe analysieren','Originalfoto fÃ¼r KI-Bearbeitung vorbereiten','gpt-image-1: Sanierung mit exakt gleicher Perspektive'];

function showErr(msg) {
  const el = document.getElementById('errBar');
  el.textContent = 'âŒ ' + msg; el.className = 'err-bar on';
  setTimeout(() => el.className = 'err-bar', 6000);
}
function hideErr() { document.getElementById('errBar').className = 'err-bar'; }

function setMainStep(n) {
  for (let i = 1; i <= 4; i++) {
    const el = document.getElementById('step' + i); if (!el) continue;
    const label = MAIN_STEPS[i-1];
    if (i<n) { el.className='step done'; el.textContent='âœ… '+label; }
    else if (i===n) { el.className='step active'; el.textContent='ğŸ”„ '+label; }
    else { el.className='step'; el.textContent='â³ '+label; }
  }
}
function setVizStep(n) {
  for (let i = 1; i <= 3; i++) {
    const el = document.getElementById('vstep' + i); if (!el) continue;
    const label = 'Schritt '+i+': '+VIZ_STEPS[i-1];
    if (i<n) { el.className='viz-step done'; el.textContent='âœ… '+label; }
    else if (i===n) { el.className='viz-step active'; el.textContent='ğŸ”„ '+label; }
    else { el.className='viz-step'; el.textContent='â³ '+label; }
  }
}
function formatMarkdown(text) {
  return text
    .replace(/### (.+)/g,'<h3>$1</h3>').replace(/## (.+)/g,'<h3>$1</h3>')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\*(.+?)\*/g,'<em>$1</em>')
    .replace(/^- (.+)/gm,'â€¢ $1').replace(/\n/g,'<br>');
}

// ===== FOTOS =====
function handleFiles(input) {
  const files = Array.from(input.files); if (!files.length) return;
  let loaded = 0;
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      photos.push({ base64: e.target.result.split(',')[1], name: file.name, full: e.target.result });
      loaded++; if (loaded === files.length) renderPhotos();
    };
    reader.readAsDataURL(file);
  });
}
function renderPhotos() {
  vizHistory=[]; cachedEditPrompt=''; cachedRoomType='Raum'; cachedRoomAnalysis=null;
  wizResults=[]; wizCachedPrompts=[]; wizCachedTypes=[]; wizCachedAnalysis=[];
  document.getElementById('vizResult').style.display='none';
  document.getElementById('wizardCard').style.display='none';
  const rb = document.getElementById('vizRegenBtn'); if(rb) rb.style.display='none';
  document.getElementById('startWizardBtn').style.display = photos.length ? 'flex' : 'none';
  document.getElementById('photosGrid').innerHTML = photos.map((p,i) => `
    <div class="photo-thumb">
      <img src="${p.full}" alt="${p.name}" />
      <button class="del" onclick="removePhoto(${i})">Ã—</button>
      ${i===0?'<span class="main-badge">Haupt</span>':''}
    </div>`).join('');
  document.getElementById('photosCount').textContent = photos.length > 0 ? `âœ“ ${photos.length} Foto${photos.length>1?'s':''} geladen` : '';
  document.getElementById('fileInput').value = '';
}
function removePhoto(i) { photos.splice(i,1); renderPhotos(); }

// ===== AUDIO =====
async function toggleRec() {
  if (!isRec) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : 'audio/webm';
      mRec = new MediaRecorder(stream, { mimeType }); aChunks = [];
      mRec.ondataavailable = e => { if(e.data.size>0) aChunks.push(e.data); };
      mRec.onstop = () => {
        audBlob = new Blob(aChunks, { type: mimeType });
        document.getElementById('audioPlayer').src = URL.createObjectURL(audBlob);
        document.getElementById('audioPrev').style.display = 'block';
        stream.getTracks().forEach(t => t.stop());
      };
      mRec.start(500); isRec=true; recSeconds=0;
      document.getElementById('recBtn').textContent='â¹';
      document.getElementById('recBtn').classList.add('rec');
      document.getElementById('recStatus').textContent='â— Aufnahme';
      document.getElementById('recStatus').classList.add('active');
      document.getElementById('recTimer').style.display='block';
      timerInterval = setInterval(() => {
        recSeconds++;
        const m=Math.floor(recSeconds/60), s=recSeconds%60;
        document.getElementById('recTimer').textContent=`${m}:${String(s).padStart(2,'0')}`;
        document.getElementById('progressFill').style.width=Math.min((recSeconds/120)*100,100)+'%';
      },1000);
    } catch(e) { showErr('Mikrofon-Zugriff verweigert.'); }
  } else {
    mRec.stop(); isRec=false; clearInterval(timerInterval);
    document.getElementById('recBtn').textContent='ğŸ™ï¸';
    document.getElementById('recBtn').classList.remove('rec');
    document.getElementById('recStatus').textContent='âœ“ Gespeichert';
    document.getElementById('recStatus').classList.remove('active');
  }
}

function toggleM(m) {
  const el = document.getElementById('m-'+m);
  if(modes.has(m)){modes.delete(m);el.classList.remove('on');}
  else{modes.add(m);el.classList.add('on');}
}

// ===== ANALYSE =====
async function runAnalyse() {
  const key = document.getElementById('openaiKey').value.trim();
  if(!key){showErr('Bitte OpenAI API Key eingeben.');return;}
  if(!photos.length&&!audBlob&&!document.getElementById('manualDesc').value.trim()){showErr('Bitte Foto, Sprachaufnahme oder Beschreibung bereitstellen.');return;}
  hideErr();
  document.getElementById('analyzeBtn').disabled=true;
  document.getElementById('loading').classList.add('on');
  document.getElementById('resultCard').classList.remove('on');
  transcript='';

  setMainStep(1);
  if(audBlob){
    try{
      const fd=new FormData();
      fd.append('file',audBlob,'aufnahme.webm');fd.append('model','whisper-1');fd.append('language','de');
      const r=await fetch('https://api.openai.com/v1/audio/transcriptions',{method:'POST',headers:{'Authorization':'Bearer '+key},body:fd});
      if(r.ok){const d=await r.json();if(d.text){transcript=d.text;document.getElementById('transcriptText').textContent=transcript;document.getElementById('transcriptBox').classList.add('on');}}
    }catch(e){console.warn('Transkription fehlgeschlagen:',e);}
  }

  setMainStep(2);
  const manualDesc=document.getElementById('manualDesc').value.trim();
  const kunde=document.getElementById('auftraggeber').value||'Unbekannt';
  const obj=document.getElementById('objekt').value||'Unbekannt';
  const schaden=document.getElementById('schadensart').value||'Unbekannt';
  const flaeche=document.getElementById('flaeche').value||'unbekannt';
  const vers=document.getElementById('versicherung').value||'';
  const budget=document.getElementById('budget').value||'';

  const systemPrompt = `Du bist ein erfahrener BausachverstÃ¤ndiger bei GebÃ¤udetrocknung Wiegand GbR in Eschwege (Werra-MeiÃŸner-Kreis). Meisterbetrieb, 30+ Jahre Erfahrung, Kooperationspartner von Versicherungen und BehÃ¶rden. Bearbeitender Techniker: ${currentEmployee ? currentEmployee.name+' ('+currentEmployee.role+')' : 'GebÃ¤udetrocknung Wiegand'}.

AKTUELLE MARKTPREISE 2025 (Deutschland â€“ Pflicht: verwende diese bei jeder Kostenkalkulation):

GEBÃ„UDETROCKNUNG & WASSERSCHADEN:
â€“ Technische Trocknung (Kondensationstrockner): 3â€“8 â‚¬/mÂ²
â€“ Trocknung aufwÃ¤ndig (HohlrÃ¤ume/Injektor): 8â€“12 â‚¬/mÂ²
â€“ Putz entfernen & entsorgen: 10â€“30 â‚¬/mÂ²
â€“ Schimmelsanierung OberflÃ¤che: 200â€“500 â‚¬/mÂ²
â€“ Schimmelsanierung tiefgehend: 500â€“1.200 â‚¬/mÂ²
â€“ Estrichtrocknung: 15â€“40 â‚¬/mÂ²
â€“ Leckortung & Diagnose: 80â€“250 â‚¬/Einsatz
â€“ GerÃ¤temiete Kondensationstrockner: 40â€“80 â‚¬/Tag
â€“ GerÃ¤temiete Adsorptionstrockner: 60â€“120 â‚¬/Tag
â€“ Gesamtkosten klein (10â€“20 mÂ²): 400â€“800 â‚¬
â€“ Gesamtkosten mittel (bis 50 mÂ²): 1.000â€“2.500 â‚¬
â€“ Gesamtkosten groÃŸ/komplex: 3.000â€“15.000 â‚¬
â€“ Handwerkerstunde: 55â€“75 â‚¬/h zzgl. 19% MwSt
â€“ Anfahrt regional (Werra-MeiÃŸner-Kreis): 35â€“90 â‚¬

BADSANIERUNG:
â€“ Standard: 1.000â€“1.500 â‚¬/mÂ²
â€“ Gehoben: 1.800â€“2.500 â‚¬/mÂ²
â€“ Luxus: 3.000â€“4.500 â‚¬/mÂ²
â€“ Bad 8mÂ² Standard gesamt: 8.000â€“12.000 â‚¬
â€“ Bad 8mÂ² gehoben gesamt: 14.000â€“20.000 â‚¬
â€“ Fliesen inkl. Verlegen Standard: 40â€“80 â‚¬/mÂ²
â€“ Fliesen GroÃŸformat/Feinsteinzeug: 80â€“160 â‚¬/mÂ²
â€“ Fliesen Naturstein: 120â€“250 â‚¬/mÂ²
â€“ Demontage & Entsorgung: 300â€“600 â‚¬/mÂ²
â€“ SanitÃ¤rinstallation komplett: 2.000â€“5.000 â‚¬
â€“ Badewanne komplett: 1.500â€“4.000 â‚¬
â€“ Regendusche komplett: 800â€“2.500 â‚¬
â€“ Elektriker Feuchtraum: 800â€“2.500 â‚¬
â€“ Dauer: 2â€“4 Wochen (Standard), 4â€“8 Wochen (komplex)

FÃ–RDERUNGEN (immer prÃ¼fen):
â€“ KfW 455-B Barrierefreiheit: bis 6.250 â‚¬ Zuschuss
â€“ Pflegekasse (ab Pflegegrad 1): bis 4.000 â‚¬ einmalig
â€“ BAFA Warmwasser energieeffizient
â€“ Â§35a EStG: 20% Handwerkerkosten, max. 1.200 â‚¬/Jahr

VERSICHERUNG:
â€“ Sofort fotografieren (VOR AufrÃ¤umen!): FlÃ¤chen, Wasserstand, Quelle
â€“ Obliegenheit: Versicherung sofort melden
â€“ Leitungswasser â†’ GebÃ¤udeversicherung
â€“ Naturkatastrophe â†’ Elementarschaden
â€“ Schriftlicher KV fÃ¼r Versicherungsabrechnung

Stil: direkt, handlungsorientiert, konkrete â‚¬/mÂ²-Werte, Zeitangaben in Arbeitstagen, GerÃ¤teempfehlungen nennen. Formatierung: ### Abschnitte, **fett** fÃ¼r SofortmaÃŸnahmen, Kosten IMMER als Spanne mit â‚¬/mÂ² + Gesamt. Antwort auf Deutsch.`;

  let userText = `Analysiere diesen GebÃ¤udeschaden professionell.\n\n**Auftragsdaten:**\n- Objekt: ${obj}\n- Auftraggeber: ${kunde}\n- Schadensart: ${schaden}\n- FlÃ¤che: ${flaeche} mÂ²\n- Versicherungsfall: ${vers}\n${budget?'- Budgetrahmen: '+budget+' â‚¬\n':''}${transcript?'\n**MÃ¼ndliche Beschreibung:**\n'+transcript+'\n':''}${manualDesc?'\n**Schriftliche Beschreibung:**\n'+manualDesc+'\n':''}\nErstelle:\n`;
  if(modes.has('schaden')) userText+=`\n### Schadensbeurteilung\n- SchÃ¤den detailliert\n- Ursache & AusmaÃŸ\n- SofortmaÃŸnahmen\n`;
  if(modes.has('konzept')) userText+=`\n### Sanierungskonzept\n- Schritt-fÃ¼r-Schritt Plan\n- GerÃ¤te und Materialien\n- Zeitplan\n`;
  if(modes.has('kosten'))  userText+=`\n### KostenschÃ¤tzung\n- AufgeschlÃ¼sselt mit â‚¬/mÂ²\n- GerÃ¤te, Material, Arbeit separat\n- Netto + 19% MwSt = Brutto\n`;
  if(modes.has('foerder')) userText+=`\n### FÃ¶rderung & Versicherung\n- Versicherungshinweise & Dokumentation\n- KfW, BAFA, Pflegekasse\n- Schadensmeldung\n`;

  const parts=[{type:'text',text:userText}];
  for(let i=0;i<Math.min(photos.length,4);i++) parts.push({type:'image_url',image_url:{url:'data:image/jpeg;base64,'+photos[i].base64,detail:'high'}});

  setMainStep(3);
  try{
    const response=await fetch('https://api.openai.com/v1/chat/completions',{
      method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
      body:JSON.stringify({model:'gpt-4o',max_tokens:2500,messages:[{role:'system',content:systemPrompt},{role:'user',content:parts}]})
    });
    const data=await response.json();
    if(!response.ok) throw new Error(data.error?.message||'API Fehler '+response.status);
    setMainStep(4); await new Promise(r=>setTimeout(r,500));
    lastAnalysis=data.choices[0].message.content;
    document.getElementById('resultContent').innerHTML=formatMarkdown(lastAnalysis);
    document.getElementById('resultCard').classList.add('on');
    document.getElementById('resultCard').scrollIntoView({behavior:'smooth'});
  }catch(e){showErr('Analyse-Fehler: '+e.message);}
  document.getElementById('loading').classList.remove('on');
  document.getElementById('analyzeBtn').disabled=false;
}

// ===== RENO-RECORDER =====
async function toggleRenoRec() {
  if(!renoIsRec){
    try{
      const stream=await navigator.mediaDevices.getUserMedia({audio:true});
      const mimeType=MediaRecorder.isTypeSupported('audio/webm;codecs=opus')?'audio/webm;codecs=opus':'audio/webm';
      renoMRec=new MediaRecorder(stream,{mimeType}); renoAChunks=[];
      renoMRec.ondataavailable=e=>{if(e.data.size>0)renoAChunks.push(e.data);};
      renoMRec.onstop=()=>{renoAudBlob=new Blob(renoAChunks,{type:mimeType});stream.getTracks().forEach(t=>t.stop());document.getElementById('renoRecStatus').textContent='âœ“ OK';};
      renoMRec.start(500); renoIsRec=true;
      document.getElementById('renoRecBtn').textContent='â¹'; document.getElementById('renoRecBtn').classList.add('rec');
      document.getElementById('renoRecStatus').textContent='â— REC'; document.getElementById('renoRecStatus').classList.add('active');
    }catch(e){showErr('Mikrofon-Zugriff verweigert.');}
  }else{
    renoMRec.stop(); renoIsRec=false;
    document.getElementById('renoRecBtn').textContent='ğŸ™ï¸'; document.getElementById('renoRecBtn').classList.remove('rec');
    document.getElementById('renoRecStatus').classList.remove('active');
  }
}

// ===== VISUALISIERUNG =====
async function generateViz(skipAnalysis=false) {
  const key=document.getElementById('openaiKey').value.trim();
  if(!key){showErr('Bitte OpenAI Key eingeben.');return;}
  if(!photos.length){showErr('Bitte zuerst ein Foto hochladen.');return;}
  document.getElementById('vizBtn').disabled=true; document.getElementById('vizRegenBtn').disabled=true;
  document.getElementById('ldViz').classList.add('on');
  if(!vizHistory.length) document.getElementById('vizResult').style.display='none';

  let userWishes=document.getElementById('renoWishes').value.trim();
  if(renoAudBlob&&!skipAnalysis){
    try{
      const wfd=new FormData(); wfd.append('file',renoAudBlob,'wuensche.webm'); wfd.append('model','whisper-1'); wfd.append('language','de');
      const wr=await fetch('https://api.openai.com/v1/audio/transcriptions',{method:'POST',headers:{'Authorization':'Bearer '+key},body:wfd});
      if(wr.ok){const wd=await wr.json();if(wd.text){const wt=wd.text.trim();userWishes=userWishes?userWishes+' Â· '+wt:wt;const el=document.getElementById('renoTranscript');el.textContent='ğŸ™ï¸ '+wt;el.classList.add('on');}}
    }catch(e){console.warn('WÃ¼nsche-Transkription fehlgeschlagen:',e);}
  }

  let roomType=cachedRoomType, editPrompt=cachedEditPrompt;
  if(!skipAnalysis||!cachedRoomAnalysis){
    setVizStep(1);
    try{
      const r1=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify({model:'gpt-4o',temperature:0,max_tokens:700,messages:[{role:'user',content:[{type:'image_url',image_url:{url:'data:image/jpeg;base64,'+photos[0].base64,detail:'high'}},{type:'text',text:ROOM_ANALYSIS_PROMPT}]}]})});
      const d1=await r1.json(); if(!r1.ok) throw new Error(d1.error?.message||'GPT-4o Fehler');
      const raw=d1.choices[0].message.content.trim(); const match=raw.match(/\{[\s\S]*\}/);
      if(match){const p=JSON.parse(match[0]);cachedRoomAnalysis=p;if(p.roomType){roomType=p.roomType;cachedRoomType=roomType;}}
    }catch(e){console.warn('Raumanalyse fehlgeschlagen:',e);}
  }else{setVizStep(2);}

  const inspStyle=await getInspirationStyle(key);
  if(cachedRoomAnalysis){
    const a=cachedRoomAnalysis;
    const materials=userWishes?`Apply ONLY these user wishes: "${userWishes}". For everything else use: ${a.renovationMaterials||'modern high-end European materials'}.`:`Use: ${a.renovationMaterials||'modern high-end European materials, bright and clean'}.`;
    editPrompt=buildEditPrompt(a,materials,inspStyle||null); cachedEditPrompt=editPrompt;
  }else{
    editPrompt=cachedEditPrompt||`RENOVATION VISUALIZATION. POSITION LOCK and SIZE LOCK. CAMERA LOCK: same viewpoint. APPLY: Replace surfaces. ${userWishes?'User wishes: '+userWishes+'.':''} ${inspStyle?'STYLE INSPIRATION: '+inspStyle:''} Photorealistic, bright, clean.`;
  }

  setVizStep(2);
  let imageBlob;
  try{imageBlob=await resizeImagePNG(photos[0].full,1024);if(imageBlob.size>20*1024*1024)throw new Error('Foto zu groÃŸ.');}
  catch(e){showErr('Bildvorbereitung: '+e.message);document.getElementById('ldViz').classList.remove('on');document.getElementById('vizBtn').disabled=false;document.getElementById('vizRegenBtn').disabled=false;return;}

  setVizStep(3);
  try{
    const fd=new FormData(); fd.append('model','gpt-image-1'); fd.append('image[]',imageBlob,'room.png');
    if(inspirationPhoto){const ib=await resizeImagePNG(inspirationPhoto.full,1024);fd.append('image[]',ib,'inspiration.png');}
    fd.append('prompt',editPrompt); fd.append('n','1'); fd.append('size','auto'); fd.append('quality','high');
    const response=await fetch('https://api.openai.com/v1/images/edits',{method:'POST',headers:{'Authorization':'Bearer '+key},body:fd});
    const data=await response.json();
    if(!response.ok){const errMsg=data.error?.message||'Unbekannter Fehler';throw new Error(errMsg+(errMsg.includes('billing')?' â€“ Guthaben prÃ¼fen.':errMsg.includes('key')?' â€“ Key ungÃ¼ltig.':''));}
    const item=data.data[0]; const imgSrc=item.b64_json?'data:image/png;base64,'+item.b64_json:item.url;
    vizHistory.push(imgSrc); renderVizHistory();
  }catch(e){showErr('Visualisierung: '+e.message);}
  document.getElementById('ldViz').classList.remove('on'); document.getElementById('vizBtn').disabled=false; document.getElementById('vizRegenBtn').disabled=false;
}

function renderVizHistory(){
  document.getElementById('vizGrid').innerHTML=`<div class="viz-item"><img src="${photos[0].full}" alt="Vorher"/><p>ğŸ“· IST-Zustand (Schaden)</p></div>`+vizHistory.map((src,i)=>`<div class="viz-item"><img src="${src}" alt="Vorschlag ${i+1}"/><p>âœ¨ Vorschlag ${i+1} â€“ ${cachedRoomType}</p></div>`).join('');
  document.getElementById('vizResult').style.display='block'; document.getElementById('vizRegenBtn').style.display='inline-flex';
  document.getElementById('vizResult').scrollIntoView({behavior:'smooth'});
}

function resizeImagePNG(dataUrl,maxSize){
  return new Promise((resolve,reject)=>{
    const img=new Image();
    img.onload=()=>{
      const scale=Math.min(maxSize/img.width,maxSize/img.height,1);
      const w=Math.round(img.width*scale),h=Math.round(img.height*scale);
      const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      canvas.toBlob(blob=>blob?resolve(blob):reject(new Error('PNG-Export fehlgeschlagen')),'image/png');
    };
    img.onerror=()=>reject(new Error('Bild konnte nicht geladen werden'));
    img.src=dataUrl;
  });
}

function buildEditPrompt(a,materials,inspStyle=null){
  const parts=[
    `RENOVATION VISUALIZATION: Transform this exact photo into a photorealistic modern renovation of the same room.`,
    `CAMERA LOCK (absolute): Preserve camera height, angle, focal length and framing identically â€” ${a.cameraAngle||'same viewpoint as source photo'}.`,
    `POSITION LOCK (absolute): Every single fixture stays at its exact location â€” ${a.fixedElements||'all elements at original positions'}.`,
    `SIZE LOCK (absolute): No element may change size â€” ${a.fixtureSizes||'all elements at original scale'}.`,
    `APPLY ONLY: Replace surface finishes. ${materials}`,
  ];
  if(inspStyle) parts.push(`STYLE INSPIRATION (reference image provided): Adopt this exact aesthetic â€” ${inspStyle}. Mirror its color palette, material language, lighting mood precisely.`);
  parts.push(`FORBIDDEN: Moving, resizing, adding or removing any element.`);
  parts.push(`OUTPUT QUALITY: Photorealistic interior photo. Professional real estate photography. Soft warm lighting. No damage, no stains, no mold.`);
  return parts.join(' ');
}

const ROOM_ANALYSIS_PROMPT = `You are an expert interior architect specializing in renovation visualization.
Analyze this room photo with maximum precision. Return ONLY valid JSON:
{
  "roomType": "one German noun, e.g. Badezimmer / KÃ¼che / Wohnzimmer",
  "cameraAngle": "camera height in cm from floor, horizontal angle, viewing direction, tilt",
  "fixedElements": "exhaustive list with EXACT wall placement",
  "fixtureSizes": "each element as approximate % of visible wall area",
  "surfaceCondition": "brief current damage/condition",
  "renovationMaterials": "specific recommended modern materials"
}`;

// ===== INSPIRATION =====
function handleInspirationFile(input){
  const file=input.files[0]; if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{inspirationPhoto={base64:e.target.result.split(',')[1],full:e.target.result};inspirationStyle=null;renderInspirationThumb();};
  reader.readAsDataURL(file); input.value='';
}
function renderInspirationThumb(){
  const wrap=document.getElementById('inspirationThumb');
  if(!inspirationPhoto){wrap.style.display='none';wrap.innerHTML='';return;}
  wrap.style.display='block';
  wrap.innerHTML=`<div class="insp-thumb-wrap"><img src="${inspirationPhoto.full}" alt="Inspiration"/><div class="insp-info"><strong>ğŸ–¼ï¸ Inspirationsbild gesetzt</strong><span>Die KI orientiert sich beim Stil, Farben &amp; Materialien an diesem Bild</span></div><button class="insp-del" onclick="removeInspiration()" title="Entfernen">âœ•</button></div>`;
}
function removeInspiration(){inspirationPhoto=null;inspirationStyle=null;renderInspirationThumb();}

async function getInspirationStyle(key){
  if(!inspirationPhoto)return null; if(inspirationStyle)return inspirationStyle;
  try{
    const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify({model:'gpt-4o',temperature:0,max_tokens:220,messages:[{role:'user',content:[{type:'image_url',image_url:{url:'data:image/jpeg;base64,'+inspirationPhoto.base64,detail:'high'}},{type:'text',text:`Describe the interior design style precisely in 2-3 sentences: exact dominant colors, material types, fixture finishes, lighting mood, overall aesthetic. Be very specific. English only.`}]}]})});
    const d=await r.json(); if(r.ok&&d.choices?.[0]){inspirationStyle=d.choices[0].message.content.trim();return inspirationStyle;}
  }catch(e){console.warn('Inspiration-Stilanalyse fehlgeschlagen:',e);}
  return null;
}

// ===== WIZARD BESCHREIBUNG =====
function buildDetailedDescription(a,roomType,feedback){
  if(!a)return feedback?`<strong>âœ… Ihre WÃ¼nsche wurden umgesetzt:</strong> â€${feedback}"`:`<strong>âœ… Renovierungsvorschlag fÃ¼r ${roomType} generiert.</strong>`;
  let html=`<strong>âœ¨ ${a.roomType||roomType} â€“ Renovierungsvorschlag</strong>`;
  if(a.surfaceCondition) html+=`<br><br><strong style="color:var(--gray-700)">ğŸ“‹ Ausgangszustand:</strong><br>${a.surfaceCondition}`;
  if(a.renovationMaterials) html+=`<br><br><strong style="color:var(--gray-700)">ğŸ¨ Materialien & Design:</strong><br>${a.renovationMaterials}`;
  if(a.fixedElements) html+=`<br><br><strong style="color:var(--gray-700)">ğŸ“ Positionen beibehalten:</strong><br>${a.fixedElements}`;
  if(a.fixtureSizes) html+=`<br><br><strong style="color:var(--gray-700)">ğŸ“ MaÃŸverhÃ¤ltnisse:</strong><br>${a.fixtureSizes}`;
  if(feedback) html+=`<br><br><strong style="color:var(--blue)">ğŸ’¬ Ã„nderungswÃ¼nsche:</strong> â€${feedback}"`;
  if(inspirationPhoto&&inspirationStyle) html+=`<br><br><strong style="color:var(--blue-dark)">ğŸ–¼ï¸ Orientiert an Inspirationsbild:</strong><br><em style="font-size:11px">${inspirationStyle}</em>`;
  if(a.cameraAngle) html+=`<br><br><strong style="color:var(--green)">âœ… Kamerawinkel 1:1:</strong> ${a.cameraAngle}`;
  return html;
}

// ===== WIZARD =====
const WIZ_STEPS=['Raum & Elemente analysieren','Foto fÃ¼r KI vorbereiten','Verbesserungsbild generieren'];
function setWizStep(n){
  for(let i=1;i<=3;i++){
    const el=document.getElementById('wstep'+i);if(!el)continue;
    const label='Schritt '+i+': '+WIZ_STEPS[i-1];
    if(i<n){el.className='viz-step done';el.textContent='âœ… '+label;}
    else if(i===n){el.className='viz-step active';el.textContent='ğŸ”„ '+label;}
    else{el.className='viz-step';el.textContent='â³ '+label;}
  }
}
function updateWizardProgress(){
  document.getElementById('wizardProgressText').textContent=`Foto ${wizIndex+1} von ${photos.length}`;
  document.getElementById('wizardDots').innerHTML=photos.map((_,i)=>`<div class="wizard-dot ${i<wizIndex?'done':i===wizIndex?'active':''}"></div>`).join('');
  const isLast=wizIndex===photos.length-1;
  document.getElementById('wizardNextBtn').style.display=isLast?'none':'inline-flex';
  document.getElementById('wizardDoneBtn').style.display=isLast?'inline-flex':'none';
}
async function startVizWizard(){
  const key=document.getElementById('openaiKey').value.trim();
  if(!key){showErr('Bitte OpenAI Key eingeben.');return;}
  if(!photos.length){showErr('Bitte Fotos hochladen.');return;}
  wizIndex=0; wizCachedPrompts=new Array(photos.length).fill(''); wizCachedTypes=new Array(photos.length).fill('Raum'); wizCachedAnalysis=new Array(photos.length).fill(null); wizResults=[];
  document.getElementById('wizardCard').style.display='block'; document.getElementById('wizardSummary').style.display='none'; document.getElementById('wizardResult').style.display='none';
  document.getElementById('wizardCard').scrollIntoView({behavior:'smooth'}); await generateWizPhoto(0);
}
async function generateWizPhoto(index,feedback=''){
  const key=document.getElementById('openaiKey').value.trim();
  if(!key){showErr('Bitte OpenAI Key eingeben.');return;}
  wizIndex=index; updateWizardProgress();
  document.getElementById('wizardLoading').classList.add('on'); document.getElementById('wizardResult').style.display='none'; document.getElementById('wizardFeedback').value='';
  let editPrompt='', roomType=wizCachedTypes[index]||'Raum';
  if(!wizCachedAnalysis[index]){
    setWizStep(1);
    try{
      const r1=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify({model:'gpt-4o',temperature:0,max_tokens:700,messages:[{role:'user',content:[{type:'image_url',image_url:{url:'data:image/jpeg;base64,'+photos[index].base64,detail:'high'}},{type:'text',text:ROOM_ANALYSIS_PROMPT}]}]})});
      const d1=await r1.json(); if(!r1.ok) throw new Error(d1.error?.message||'GPT-4o Fehler');
      const raw=d1.choices[0].message.content.trim(); const match=raw.match(/\{[\s\S]*\}/);
      if(match){const p=JSON.parse(match[0]);wizCachedAnalysis[index]=p;if(p.roomType){roomType=p.roomType;wizCachedTypes[index]=roomType;}}
    }catch(e){console.warn('Wizard-Analyse fehlgeschlagen:',e);}
  }else{roomType=wizCachedTypes[index]||'Raum';setWizStep(2);}

  const a=wizCachedAnalysis[index];
  if(a){
    const materials=feedback?`Apply ONLY: "${feedback}". Keep rest: ${a.renovationMaterials||'modern materials'}.`:`Use: ${a.renovationMaterials||'modern high-end European materials'}.`;
    editPrompt=buildEditPrompt(a,materials);
  }else{editPrompt=feedback?`POSITION LOCK. Apply ONLY: "${feedback}". Photorealistic.`:`POSITION LOCK. Modern renovation, same angle. Photorealistic.`;}

  const inspStyle=await getInspirationStyle(key);
  if(inspStyle&&a){
    const materials=feedback?`Apply ONLY: "${feedback}". Keep rest: ${a.renovationMaterials||'modern materials'}.`:`Use: ${a.renovationMaterials||'modern high-end European materials'}.`;
    editPrompt=buildEditPrompt(a,materials,inspStyle);
  }

  setWizStep(2);
  let imageBlob;
  try{imageBlob=await resizeImagePNG(photos[index].full,1024);}
  catch(e){showErr('Bild-Vorbereitung: '+e.message);document.getElementById('wizardLoading').classList.remove('on');return;}

  setWizStep(3);
  try{
    const fd=new FormData(); fd.append('model','gpt-image-1'); fd.append('image[]',imageBlob,'room.png');
    if(inspirationPhoto){const ib=await resizeImagePNG(inspirationPhoto.full,1024);fd.append('image[]',ib,'inspiration.png');}
    fd.append('prompt',editPrompt); fd.append('n','1'); fd.append('size','auto'); fd.append('quality','high');
    const response=await fetch('https://api.openai.com/v1/images/edits',{method:'POST',headers:{'Authorization':'Bearer '+key},body:fd});
    const data=await response.json();
    if(!response.ok){const errMsg=data.error?.message||'Fehler';throw new Error(errMsg+(errMsg.includes('billing')?' â€“ Guthaben prÃ¼fen.':errMsg.includes('key')?' â€“ Key ungÃ¼ltig.':''));}
    const item=data.data[0]; const imgSrc=item.b64_json?'data:image/png;base64,'+item.b64_json:item.url;
    wizResults[index]={original:photos[index].full,result:imgSrc,roomType};
    document.getElementById('wizardGrid').innerHTML=`<div class="viz-item"><img src="${photos[index].full}" alt="Vorher"/><p>ğŸ“· IST-Zustand â€“ Foto ${index+1}</p></div><div class="viz-item"><img src="${imgSrc}" alt="Vorschlag"/><p>âœ¨ Vorschlag â€“ ${roomType}${inspirationPhoto?' Â· ğŸ–¼ï¸ Inspiriert':''}</p></div>`;
    document.getElementById('wizardDesc').innerHTML=buildDetailedDescription(a,roomType,feedback);
    document.getElementById('wizardResult').style.display='block'; document.getElementById('wizardResult').scrollIntoView({behavior:'smooth'});
  }catch(e){showErr('Visualisierung: '+e.message);}
  document.getElementById('wizardLoading').classList.remove('on');
}
async function regenerateCurrentWiz(){await generateWizPhoto(wizIndex,document.getElementById('wizardFeedback').value.trim());}
async function nextWizPhoto(){if(wizIndex<photos.length-1)await generateWizPhoto(wizIndex+1);}
function finishWizard(){
  document.getElementById('wizardSummaryGrid').innerHTML=wizResults.map((r,i)=>`<div class="viz-item"><img src="${r.original}" alt="Vorher ${i+1}"/><p>ğŸ“· Vorher â€“ Foto ${i+1}</p></div><div class="viz-item"><img src="${r.result}" alt="Nachher ${i+1}"/><p>âœ¨ Nachher â€“ ${r.roomType}</p></div>`).join('');
  document.getElementById('wizardResult').style.display='none'; document.getElementById('wizardLoading').classList.remove('on');
  document.getElementById('wizardSummary').style.display='block'; document.getElementById('wizardSummary').scrollIntoView({behavior:'smooth'});
}

// ===== RECHNUNG =====
function previewInvoice(){
  const nr=document.getElementById('inv-nr').value||'RE-2024-001';
  const betrag=parseFloat(document.getElementById('inv-betrag').value||'0');
  const email=document.getElementById('inv-email').value||'â€“';
  const obj=document.getElementById('objekt').value||'Objekt';
  document.getElementById('invoicePreview').innerHTML=`<h4>Rechnung ${nr}</h4><p><strong>EmpfÃ¤nger:</strong> ${email}</p><p><strong>Leistung:</strong> GebÃ¤udetrocknung & Sanierung â€“ ${obj}</p><p><strong>Brutto:</strong> ${betrag.toLocaleString('de-DE',{minimumFractionDigits:2})} â‚¬</p><p><strong>Netto:</strong> ${(betrag/1.19).toLocaleString('de-DE',{minimumFractionDigits:2})} â‚¬ Â· <strong>MwSt:</strong> ${(betrag-betrag/1.19).toLocaleString('de-DE',{minimumFractionDigits:2})} â‚¬</p>`;
  document.getElementById('invoicePreview').classList.add('on');
}
function sendInvoice(){
  const email=document.getElementById('inv-email').value; if(!email){showErr('E-Mail fehlt.');return;}
  const nr=document.getElementById('inv-nr').value||'RE-2024-001';
  const betrag=document.getElementById('inv-betrag').value||'0';
  const obj=document.getElementById('objekt').value||'Objekt';
  window.location.href=`mailto:${email}?subject=${encodeURIComponent('Rechnung '+nr+' â€“ GebÃ¤udetrocknung Wiegand')}&body=${encodeURIComponent('Sehr geehrte Damen und Herren,\n\nbitte Ã¼berweisen Sie '+betrag+' â‚¬ fÃ¼r Sanierungsarbeiten am Objekt "'+obj+'".\n\nRechnungsnummer: '+nr+'\n\nMit freundlichen GrÃ¼ÃŸen\nGebÃ¤udetrocknung Wiegand\nTel: 01520 88 112 88')}`;
}
function copyResult(){
  navigator.clipboard.writeText(document.getElementById('resultContent').innerText)
    .then(()=>alert('Analyse kopiert!')).catch(()=>showErr('Kopieren fehlgeschlagen.'));
}

// ===== VIDEO EXTRAKTION =====
function extractVideoFrames(videoFile,count=6){
  return new Promise((resolve,reject)=>{
    const video=document.createElement('video');
    const url=URL.createObjectURL(videoFile);
    video.src=url; video.muted=true; video.preload='auto';
    video.addEventListener('loadedmetadata',()=>{
      const duration=video.duration;
      if(!duration||duration===Infinity){URL.revokeObjectURL(url);return reject(new Error('Video-Dauer nicht ermittelbar.'));}
      const frames=[],canvas=document.createElement('canvas'),ctx=canvas.getContext('2d');
      let captured=0;
      video.addEventListener('seeked',function onSeeked(){
        canvas.width=video.videoWidth; canvas.height=video.videoHeight; ctx.drawImage(video,0,0);
        const dataUrl=canvas.toDataURL('image/jpeg',0.85);
        frames.push({base64:dataUrl.split(',')[1],full:dataUrl,name:`frame_${captured+1}.jpg`});
        captured++;
        if(captured<count){captureFrame(Math.min((duration/(count-1))*captured,duration-0.1));}
        else{video.removeEventListener('seeked',onSeeked);URL.revokeObjectURL(url);resolve(frames);}
      });
      function captureFrame(t){video.currentTime=t;}
      captureFrame(0);
    });
    video.addEventListener('error',()=>{URL.revokeObjectURL(url);reject(new Error('Video konnte nicht geladen werden.'));});
  });
}
async function handleVideo(input){
  const file=input.files[0]; if(!file)return;
  document.getElementById('videoStatus').textContent='â³ Frames werden extrahiert...';
  document.getElementById('videoFramesGrid').innerHTML=''; input.value='';
  try{
    const frames=await extractVideoFrames(file,6);
    frames.forEach(f=>photos.push(f)); renderPhotos();
    document.getElementById('videoFramesGrid').innerHTML=frames.map((f,i)=>`<div class="video-frame-thumb"><img src="${f.full}" alt="Frame ${i+1}"/><span class="frame-badge">Frame ${i+1}</span></div>`).join('');
    document.getElementById('videoStatus').textContent=`âœ… ${frames.length} Frames extrahiert â€“ bereit fÃ¼r KI-Analyse & 3D`;
  }catch(e){document.getElementById('videoStatus').textContent='âŒ '+e.message;showErr('Video: '+e.message);}
}
</script>
</body>
</html>
